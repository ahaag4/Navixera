#include <WiFi.h>
#include <FirebaseESP32.h>
#include <TinyGPS++.h>
#include <NTPClient.h>
#include <WiFiUdp.h>

// ==== CONFIGURATION ====
#define WIFI_SSID       "your_wifi"
#define WIFI_PASSWORD   "your_pass"
#define FIREBASE_HOST   "https://svms-c0232-default-rtdb.firebaseio.com"
#define FIREBASE_AUTH   "https://console.firebase.google.com/project/svms-c0232/settings/serviceaccounts/databasesecrets"  // Go to Firebase > Settings > Service Accounts > Database Secrets

// ==== OBJECTS ====
FirebaseData firebaseData;
TinyGPSPlus gps;
HardwareSerial GPS(1);  // UART1
WiFiUDP ntpUDP;
NTPClient timeClient(ntpUDP, "pool.ntp.org", 19800, 60000); // India Time (UTC+5:30)

// ==== PINS ====
#define GPS_RX 16  // GPIO16 - RX pin (connect to GPS TX)
#define GPS_TX 17  // GPIO17 - TX pin (connect to GPS RX)

void setup() {
  Serial.begin(115200);
  GPS.begin(9600, SERIAL_8N1, GPS_RX, GPS_TX);

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting to WiFi...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println(" Connected!");

  // Init Firebase
  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);
  Firebase.reconnectWiFi(true);

  // Init time
  timeClient.begin();
  while (!timeClient.update()) {
    timeClient.forceUpdate();
  }
}

void loop() {
  while (GPS.available()) {
    gps.encode(GPS.read());

    if (gps.location.isUpdated()) {
      float lat = gps.location.lat();
      float lng = gps.location.lng();
      String locationText = String(lat, 6) + "," + String(lng, 6);
      String timestamp = getTimeString();

      Serial.println("Uploading GPS data...");
      Serial.println(locationText);

      // ---- Upload Current Location ----
      Firebase.setFloat(firebaseData, "/vehicle/current/latitude", lat);
      Firebase.setFloat(firebaseData, "/vehicle/current/longitude", lng);
      Firebase.setString(firebaseData, "/vehicle/current/status", "Moving");
      Firebase.setString(firebaseData, "/vehicle/current/last_active", timestamp);

      // ---- Upload to History (Push with JSON) ----
      FirebaseJson json;
      json.set("time", timestamp);
      json.set("location", locationText);

      if (Firebase.pushJSON(firebaseData, "/vehicle/history", json)) {
        Serial.println("History updated.");
      } else {
        Serial.print("Push failed: ");
        Serial.println(firebaseData.errorReason());
      }

      delay(5000);  // Wait before next location update
    }
  }
}

String getTimeString() {
  timeClient.update();
  unsigned long epochTime = timeClient.getEpochTime();

  // Convert to human-readable format
  time_t rawtime = epochTime;
  struct tm* timeinfo = localtime(&rawtime);

  char buffer[25];
  strftime(buffer, sizeof(buffer), "%Y-%m-%d %H:%M:%S", timeinfo);
  return String(buffer);
}
