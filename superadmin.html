<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Main Admin Panel - Smart Vehicle Logistics</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f9fafb; }
    .navbar { background-color: #0d6efd; }
    .navbar-brand, .nav-link, .navbar-nav .nav-link.active { color: white !important; }
    #map { height: 400px; border-radius: 10px; }
    .card { box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
    .stat-card { text-align: center; padding: 20px; }
    .stat-card h3 { margin-bottom: 10px; font-weight: 600; }
    .section-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 15px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Super Admin - SVMS</a>
      <button class="btn btn-light ms-auto" onclick="logout()">Logout</button>
    </div>
  </nav>
  <div class="container py-4">
    <div class="row text-center">
      <div class="col-md-3 stat-card bg-light"><h3 id="totalCompanies">0</h3><p>Total Companies</p></div>
      <div class="col-md-3 stat-card bg-light"><h3 id="totalVehicles">0</h3><p>Total Vehicles</p></div>
      <div class="col-md-3 stat-card bg-light"><h3 id="totalDeliveries">0</h3><p>Total Deliveries</p></div>
      <div class="col-md-3 stat-card bg-light"><h3 id="alertsToday">0</h3><p>Alerts Today</p></div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="section-title">Live Vehicle Locations</div>
        <div id="map"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="section-title">Company Management</div>
        <table class="table table-bordered">
          <thead class="table-light">
            <tr><th>Company</th><th>Vehicles</th><th>Deliveries</th><th>Status</th><th>Actions</th></tr>
          </thead>
          <tbody id="companyTable"></tbody>
        </table>
      </div>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">Edit Company Profile</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="text" id="editCompanyName" class="form-control mb-2" placeholder="Company Name">
            <input type="email" id="editCompanyEmail" class="form-control mb-2" placeholder="Email">
            <input type="text" id="editCompanyPhone" class="form-control mb-2" placeholder="Phone">
            <input type="text" id="editCompanyAddress" class="form-control mb-2" placeholder="Address">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="saveCompanyChanges()">Save changes</button>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="section-title">Other Panels</div>
        <!-- Placeholder for other panels -->
      </div>
    </div>
  </div>
  <script src="main-admin-logic.js"></script>
  <script>
    let currentEditUID = "";
    function approveCompany(uid) {
      firebase.database().ref(`users/${uid}`).update({ approved: true });
      alert("Company Approved");
      loadCompanyTable();
    }
    function editCompany(uid) {
      currentEditUID = uid;
      firebase.database().ref(`users/${uid}`).once("value", snap => {
        const data = snap.val();
        document.getElementById("editCompanyName").value = data.companyName || "";
        document.getElementById("editCompanyEmail").value = data.email || "";
        document.getElementById("editCompanyPhone").value = data.phone || "";
        document.getElementById("editCompanyAddress").value = data.address || "";
        new bootstrap.Modal(document.getElementById("editModal")).show();
      });
    }
    function saveCompanyChanges() {
      const name = document.getElementById("editCompanyName").value.trim();
      const email = document.getElementById("editCompanyEmail").value.trim();
      const phone = document.getElementById("editCompanyPhone").value.trim();
      const address = document.getElementById("editCompanyAddress").value.trim();
      firebase.database().ref(`users/${currentEditUID}`).update({
        companyName: name,
        email: email,
        phone: phone,
        address: address
      });
      alert("Company profile updated");
      bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
      loadCompanyTable();
    }
    function deleteCompany(uid) {
      if (confirm("Are you sure you want to delete this company profile?")) {
        firebase.database().ref(`users/${uid}`).remove();
        alert("Company deleted");
        loadCompanyTable();
      }
    }
    function loadCompanyTable() {
      const tbody = document.getElementById("companyTable");
      tbody.innerHTML = "";
      firebase.database().ref("users").once("value", snap => {
        const users = snap.val();
        for (const uid in users) {
          const user = users[uid];
          const companies = user.vehicle?.companies || {};
          for (const name in companies) {
            const vehicles = companies[name].vehicle || {};
            let deliveryCount = 0;
            for (const v in vehicles) {
              deliveryCount += Object.keys(vehicles[v].deliveries || {}).length;
            }
            const approved = user.approved === true;
            const statusLabel = approved ? "✅ Approved" : "❌ Pending";
            const actions = `
              ${approved ? "" : `<button class='btn btn-success btn-sm' onclick="approveCompany('${uid}')">Approve</button>`}
              <button class='btn btn-primary btn-sm' onclick="editCompany('${uid}')">Edit</button>
              <button class='btn btn-danger btn-sm' onclick="deleteCompany('${uid}')">Delete</button>
            `;
            const row = `<tr><td>${name}</td><td>${Object.keys(vehicles).length}</td><td>${deliveryCount}</td><td>${statusLabel}</td><td>${actions}</td></tr>`;
            tbody.innerHTML += row;
          }
        }
      });
    }
  </script>
</body>
</html>
