<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Super Admin — Subscription Approvals</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f8f9fa;padding:18px;font-family:Arial,Helvetica,sans-serif}
    .card{border-radius:8px;padding:14px;margin-bottom:12px}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <div style="max-width:1100px;margin:auto">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3>Super Admin — Subscription Requests</h3>
      <div>
        <span id="adminEmail" class="me-3 small">Loading...</span>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
      </div>
    </div>

    <div class="card bg-white">
      <h5>Pending Subscription Requests</h5>
      <div class="small mb-2">Click approve to activate the plan for the user (30-day expiry)</div>
      <div id="pendingRequestsArea">Loading...</div>
    </div>

    <div class="card bg-white">
      <h5>Approvals Log</h5>
      <div id="approvalsLog">Loading...</div>
    </div>

    <div class="card bg-white">
      <h5>User Earnings (Add credits)</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="small">User ID</label>
          <input id="earnUserId" class="form-control" placeholder="uid"/>
        </div>
        <div class="col-md-3">
          <label class="small">Amount (₹)</label>
          <input id="earnAmount" class="form-control" type="number" placeholder="100"/>
        </div>
        <div class="col-md-3">
          <button id="addEarningsBtn" class="btn btn-primary">Add Earnings</button>
        </div>
      </div>
      <hr/>
      <h6>Balances</h6>
      <div id="earningsList">Loading...</div>
    </div>
  </div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- DOM ----------
  const adminEmail = document.getElementById('adminEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const pendingRequestsArea = document.getElementById('pendingRequestsArea');
  const approvalsLog = document.getElementById('approvalsLog');
  const earnUserId = document.getElementById('earnUserId');
  const earnAmount = document.getElementById('earnAmount');
  const addEarningsBtn = document.getElementById('addEarningsBtn');
  const earningsList = document.getElementById('earningsList');

  let adminUid = null;

  // ---------- Auth guard ----------
  auth.onAuthStateChanged(async user => {
    if(!user) return window.location.href = 'login.html';
    adminUid = user.uid;
    adminEmail.textContent = user.email || adminUid;

    // verify role
    const snap = await db.ref(`users/${adminUid}`).once('value');
    const u = snap.val() || {};
    if(u.role !== 'super-admin') {
      alert('Not authorized');
      return window.location.href = 'dashboard.html';
    }

    // start listeners
    listenSubscriptionRequests();
    listenApprovalsLog();
    loadEarnings();
  });

  logoutBtn.onclick = ()=> auth.signOut().then(()=> window.location.href='login.html');

  // ---------- Listen subscription requests ----------
  function listenSubscriptionRequests(){
    db.ref('subscriptionRequests').on('value', snap => {
      const v = snap.val() || {};
      const entries = Object.entries(v).filter(([k, val]) => val && val.status === 'pending');
      if(entries.length === 0) {
        pendingRequestsArea.innerHTML = '<div class="small text-muted">No pending requests.</div>';
        return;
      }
      const list = document.createElement('div');
      list.className = 'list-group';
      entries.forEach(([reqId, req])=>{
        const div = document.createElement('div');
        div.className = 'list-group-item d-flex justify-content-between align-items-start';
        div.innerHTML = `<div><strong>${req.uid}</strong> requested <strong>${req.requestedPlan}</strong><div class="small text-muted">${req.request_time}</div></div>`;
        const actions = document.createElement('div');
        const approveBtn = document.createElement('button'); approveBtn.className='btn btn-sm btn-success me-2'; approveBtn.textContent='Approve';
        const rejectBtn = document.createElement('button'); rejectBtn.className='btn btn-sm btn-danger'; rejectBtn.textContent='Reject';
        approveBtn.onclick = ()=> handleApprove(reqId, req);
        rejectBtn.onclick = ()=> handleReject(reqId, req);
        actions.appendChild(approveBtn); actions.appendChild(rejectBtn);
        div.appendChild(actions);
        list.appendChild(div);
      });
      pendingRequestsArea.innerHTML = '';
      pendingRequestsArea.appendChild(list);
    });
  }

  // ---------- Approve / Reject handlers ----------
  async function handleApprove(reqId, req){
    if(!confirm(`Approve ${req.uid} → ${req.requestedPlan}?`)) return;
    const targetUid = req.uid;
    const plan = req.requestedPlan || 'silver';
    // set plan, expiry, vehicle_limit, exportCSV and mark user's upgrade_request and subscriptionRequests reqId as approved
    const now = new Date();
    const expiry = new Date(now.getTime() + 30*24*60*60*1000).toISOString();
    const updates = {};
    updates[`users/${targetUid}/plan`] = plan;
    updates[`users/${targetUid}/plan_expiry`] = expiry;
    updates[`users/${targetUid}/vehicle_limit`] = (plan === 'silver' || plan === 'gold') ? 3 : 1;
    updates[`users/${targetUid}/exportCSV`] = true;
    updates[`users/${targetUid}/upgrade_request/status`] = 'approved';
    updates[`subscriptionRequests/${reqId}/status`] = 'approved';
    const log = { adminUid, uid: targetUid, plan, approvedAt: new Date().toISOString(), reqId };
    updates[`admin/approvals/${reqId}`] = log;
    try {
      await db.ref().update(updates);
      alert('Approved and applied to user.');
    } catch(err){ console.error(err); alert('Approve failed: '+err.message); }
  }

  async function handleReject(reqId, req){
    if(!confirm('Reject this request?')) return;
    const updates = {};
    if(req && req.uid) updates[`users/${req.uid}/upgrade_request/status`] = 'rejected';
    updates[`subscriptionRequests/${reqId}/status`] = 'rejected';
    updates[`admin/approvals/${reqId}`] = { adminUid, uid: req.uid || null, status:'rejected', processedAt: new Date().toISOString(), reqId };
    try {
      await db.ref().update(updates);
      alert('Rejected.');
    } catch(err){ console.error(err); alert('Reject failed: '+err.message); }
  }

  // ---------- approvals log ----------
  function listenApprovalsLog(){
    db.ref('admin/approvals').limitToLast(100).on('value', snap => {
      const v = snap.val() || {};
      const rows = Object.entries(v).reverse().map(([k,log])=>{
        return `<div class="small mb-1">${log.approvedAt || log.processedAt || ''} — <strong>${log.adminUid}</strong> → ${log.uid} : ${log.plan || log.status}</div>`;
      }).join('');
      approvalsLog.innerHTML = rows || '<div class="small text-muted">No approvals yet</div>';
    });
  }

  // ---------- Earnings ----------
  addEarningsBtn.onclick = async () => {
    const target = earnUserId.value.trim();
    const amt = Number(earnAmount.value);
    if(!target || !amt || amt <= 0) return alert('Enter user id and positive amount');
    try {
      // atomic add
      const ref = db.ref(`earnings/${target}`);
      const snap = await ref.once('value');
      const prev = snap.val() && snap.val().amount ? Number(snap.val().amount) : 0;
      await ref.set({ amount: prev + amt, lastUpdated: new Date().toISOString() });
      alert(`Added ₹${amt} to ${target}. New balance: ₹${prev + amt}`);
      earnUserId.value = ''; earnAmount.value = '';
    } catch(err){ console.error(err); alert('Add failed: '+err.message); }
    loadEarnings();
  };

  function loadEarnings(){
    db.ref('earnings').on('value', snap => {
      const v = snap.val() || {};
      const rows = Object.entries(v).map(([uid,eo])=> `<div class="small mb-1"><strong>${uid}</strong> : ₹${eo.amount || 0}</div>`).join('');
      earningsList.innerHTML = rows || '<div class="small text-muted">No earnings records.</div>';
    });
  }

  </script>
</body>
</html>
