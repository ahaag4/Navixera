<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Super Admin Panel - SVMS</title>

    <!-- Bootstrap & Leaflet CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />

    <style>
      body {
        background-color: #f9fafb;
      }
      .navbar {
        background-color: #0d6efd;
      }
      .navbar-brand, .nav-link {
        color: white !important;
      }
      #map {
        height: 400px;
        border-radius: 10px;
      }
      .card {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .stat-card {
        text-align: center;
        padding: 20px;
      }
      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 15px;
      }
    </style>
  </head>

  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Super Admin - SVMS</a>
        <button class="btn btn-light ms-auto" id="logoutBtn">Logout</button>
      </div>
    </nav>

    <div class="container py-4">
      <div class="row text-center">
        <div class="col-md-3 stat-card bg-light">
          <h3 id="totalCompanies">0</h3>
          <p>Total Companies</p>
        </div>
        <div class="col-md-3 stat-card bg-light">
          <h3 id="totalVehicles">0</h3>
          <p>Total Vehicles</p>
        </div>
        <div class="col-md-3 stat-card bg-light">
          <h3 id="totalDeliveries">0</h3>
          <p>Total Deliveries</p>
        </div>
        <div class="col-md-3 stat-card bg-light">
          <h3 id="alertsToday">0</h3>
          <p>Alerts Today</p>
        </div>
      </div>

      <!-- Map -->
      <div class="card">
        <div class="card-body">
          <div class="section-title">Live Vehicle Locations</div>
          <div id="map"></div>
        </div>
      </div>

      <!-- Pending Approvals -->
      <div class="card">
        <div class="card-body">
          <div class="section-title">Pending Approvals</div>
          <ul class="list-group" id="pendingUsersList"></ul>
        </div>
      </div>

      <!-- Approved Companies Table -->
      <div class="card">
        <div class="card-body">
          <div class="section-title">Approved Companies</div>
          <table class="table table-bordered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Company</th>
                <th>Vehicles</th>
                <th>Deliveries</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="companyTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Vehicle Tracker -->
      <div class="card">
        <div class="card-body">
          <div class="section-title">Vehicle Tracker</div>
          <input type="text" class="form-control mb-3" id="trackVehicleId" placeholder="Enter Vehicle ID..." autocomplete="off" />
          <div id="vehicleTrackerResult"></div>
        </div>
      </div>

      <!-- Manual Alarm -->
      <div class="card">
        <div class="card-body">
          <div class="section-title">Manual Alarm Trigger</div>
          <input type="text" class="form-control mb-3" id="alarmVehicleId" placeholder="Enter Vehicle ID..." />
          <button class="btn btn-danger" id="triggerAlarmBtn">Trigger Alarm</button>
          <div id="alarmStatus"></div>
        </div>
      </div>
    </div>

    <!-- Firebase/Leaflet -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
        authDomain: "svms-c0232.firebaseapp.com",
        databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
        projectId: "svms-c0232",
        storageBucket: "svms-c0232.appspot.com",
        messagingSenderId: "359201898609",
        appId: "1:359201898609:web:893ef076207abb06471bd0"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();

      // Map markers reference
      let map, markers = {};

      // --- Auth Check ---
      auth.onAuthStateChanged(user => {
        if (!user) return (location.href = "login.html");
        db.ref(`users/${user.uid}`).once('value').then(snap => {
          const data = snap.val();
          if (!data || data.role !== "super-admin") location.href = "dashboard.html";
          else initializeDashboard();
        });
      });

      // --- Initialize Dashboard ---
      function initializeDashboard() {
        loadStats();
        setupMap();
        loadPendingApprovals();
        loadApprovedCompanies();
        document.getElementById("logoutBtn").onclick = () => auth.signOut().then(() => location.href = "login.html");
        document.getElementById("trackVehicleId").addEventListener("input", trackVehicle);
        document.getElementById("triggerAlarmBtn").addEventListener("click", triggerManualAlarm);
      }

      function loadStats() {
        db.ref("users").once("value").then(snap => {
          let companies = 0, vehicles = 0, deliveries = 0, alerts = 0;
          const users = snap.val() || {};
          for (const uid in users) {
            const user = users[uid];
            const comps = user.vehicle?.companies || {};
            for (const cname in comps) {
              companies++;
              const vehs = comps[cname].vehicle || {};
              vehicles += Object.keys(vehs).length;
              for (const vid in vehs) {
                deliveries += Object.keys(vehs[vid].deliveries || {}).length;
              }
            }
            if (user.vehicle?.last_trigger?.status === "alert") alerts++;
          }
          document.getElementById("totalCompanies").innerText = companies;
          document.getElementById("totalVehicles").innerText = vehicles;
          document.getElementById("totalDeliveries").innerText = deliveries;
          document.getElementById("alertsToday").innerText = alerts;
        });
      }

      function loadPendingApprovals() {
        const list = document.getElementById("pendingUsersList");
        list.innerHTML = "";
        db.ref("users").once("value").then(snap => {
          const users = snap.val() || {};
          for (const uid in users) {
            const u = users[uid];
            if ((u.role === "company" || u.role === "customer") && !u.approved) {
              const li = document.createElement("li");
              li.className = "list-group-item d-flex justify-content-between align-items-center";
              li.innerHTML = `
                <span>${u.companyName || u.email || uid} (${u.role})</span>
                <div>
                  <button class="btn btn-success btn-sm me-2" onclick="approveUser('${uid}')">Approve</button>
                  <button class="btn btn-danger btn-sm" onclick="rejectUser('${uid}')">Reject</button>
                </div>`;
              list.appendChild(li);
            }
          }
        });
      }

      function approveUser(uid) {
        db.ref(`users/${uid}`).update({ approved: true }).then(() => {
          alert("âœ… User Approved");
          loadPendingApprovals();
          loadApprovedCompanies();
        });
      }

      function rejectUser(uid) {
        if (confirm("Are you sure to delete this user?")) {
          db.ref(`users/${uid}`).remove().then(() => {
            alert("âŒ User Removed");
            loadPendingApprovals();
          });
        }
      }

      function loadApprovedCompanies() {
        const table = document.getElementById("companyTable");
        table.innerHTML = "";
        db.ref("users").once("value").then(snap => {
          const users = snap.val() || {};
          for (const uid in users) {
            const u = users[uid];
            if (u.role === "company" && u.approved) {
              const comps = u.vehicle?.companies || {};
              for (const cname in comps) {
                const vehs = comps[cname].vehicle || {};
                let deliveries = 0;
                for (const vid in vehs) {
                  deliveries += Object.keys(vehs[vid].deliveries || {}).length;
                }
                const row = `
                  <tr>
                    <td>${cname}</td>
                    <td>${Object.keys(vehs).length}</td>
                    <td>${deliveries}</td>
                    <td>
                      <button class="btn btn-sm btn-primary" onclick="editCompany('${uid}', '${cname}')">Edit</button>
                      <button class="btn btn-sm btn-danger" onclick="deleteCompany('${uid}', '${cname}')">Delete</button>
                    </td>
                  </tr>`;
                table.innerHTML += row;
              }
            }
          }
        });
      }

      function editCompany(uid, oldName) {
        const newName = prompt("Enter new name:", oldName);
        if (!newName || newName === oldName) return;
        const ref = db.ref(`users/${uid}/vehicle/companies`);
        ref.child(oldName).once('value').then(snap => {
          const data = snap.val();
          if (!data) return;
          const updates = {};
          updates[`${newName}`] = data;
          updates[`${oldName}`] = null;
          ref.update(updates).then(() => {
            alert("âœ… Company updated");
            loadApprovedCompanies();
          });
        });
      }

      function deleteCompany(uid, cname) {
        if (confirm("Delete this company?")) {
          db.ref(`users/${uid}/vehicle/companies/${cname}`).remove().then(() => {
            alert("âŒ Company deleted");
            loadApprovedCompanies();
          });
        }
      }

      // Map and marker logic
      function setupMap() {
        map = L.map('map').setView([19.2, 72.9], 11);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
        updateAllMarkers();
        db.ref("users").on("value", updateAllMarkers);
      }

      function updateAllMarkers(snapshot) {
        const users = snapshot?.val?.() || snapshot || {};
        const currentIds = new Set();
        for (const uid in users) {
          const comps = users[uid]?.vehicle?.companies || {};
          for (const c in comps) {
            const vehs = comps[c].vehicle || {};
            for (const id in vehs) {
              const gps = vehs[id]?.gps || "0,0";
              const [lat, lng] = gps.split(',').map(Number);
              currentIds.add(id);
              if (!markers[id]) {
                markers[id] = L.marker([lat, lng]).addTo(map).bindPopup(id);
              } else {
                markers[id].setLatLng([lat, lng]);
              }
            }
          }
        }

        // Clean old markers
        Object.keys(markers).forEach(id => {
          if (!currentIds.has(id)) {
            map.removeLayer(markers[id]);
            delete markers[id];
          }
        });
      }

      function trackVehicle(e) {
        const id = e.target.value.trim();
        const out = document.getElementById('vehicleTrackerResult');
        if (!id) {
          out.innerHTML = "";
          return;
        }

        db.ref('users').once('value').then(snap => {
          const users = snap.val();
          for (const uid in users) {
            const comps = users[uid]?.vehicle?.companies || {};
            for (const cname in comps) {
              const vehs = comps[cname]?.vehicle || {};
              if (vehs[id]) {
                const gps = vehs[id].gps || "0,0";
                const [lat, lng] = gps.split(",").map(Number);
                out.innerHTML = `<div class='alert alert-info'>ðŸšš <strong>${id}</strong> at ${gps} (Battery: ${vehs[id].battery || "N/A"}%)</div>`;
                if (markers[id]) {
                  markers[id].bindPopup(`Vehicle: ${id}`).openPopup();
                  map.setView([lat, lng], 14);
                } else {
                  markers[id] = L.marker([lat, lng]).addTo(map).bindPopup(id).openPopup();
                  map.setView([lat, lng], 14);
                }
                return;
              }
            }
          }
          out.innerHTML = "<div class='alert alert-warning'>Vehicle not found</div>";
        });
      }

      function triggerManualAlarm() {
        const id = document.getElementById("alarmVehicleId").value.trim();
        const out = document.getElementById("alarmStatus");
        if (!id) return out.innerHTML = `<div class="alert alert-warning">Please enter vehicle ID</div>`;

        db.ref("users").once("value").then(snap => {
          const users = snap.val();
          for (const uid in users) {
            const comps = users[uid]?.vehicle?.companies || {};
            for (const cname in comps) {
              const vehs = comps[cname]?.vehicle || {};
              if (vehs[id]) {
                return db
                  .ref(`users/${uid}/vehicle/last_trigger`)
                  .set({
                    vehicleId: id,
                    status: "alert",
                    location: vehs[id].gps || "0,0",
                    time: new Date().toISOString()
                  })
                  .then(() => {
                    out.innerHTML = `<div class="alert alert-danger">ðŸš¨ Alarm triggered for ${id}</div>`;
                  });
              }
            }
          }
          out.innerHTML = "<div class='alert alert-warning'>Vehicle not found</div>";
        });
      }
    </script>
  </body>
</html>
