<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Tracker â€” Subscription + Admin</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { background: #f6f7fa; }
    .navbar-brand { font-weight: 700; }
    .ad-banner { width: 100%; min-height: 64px; background: #e9ecef; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 18px; overflow: hidden; }
    .ad-banner img, .ad-banner video { max-height: 62px; max-width: 96vw; border-radius: 8px; }
    .card { border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.06); margin-bottom: 18px;}
    h2, h3 { font-weight: 700; color: #343a40; }
    .plan-pill { padding: 7px 14px; border-radius: 20px; background: #e2e3e5; font-weight:700; margin-right: 8px;}
    @media (max-width: 575px) {
      h2, h3 { font-size: 1.15rem; }
      .plan-pill { font-size: 1rem; padding: 5px 10px; }
      .ad-banner { min-height: 52px; }
      .ad-banner img, .ad-banner video { max-height: 48px;}
    }
    .pending-pill, .approved-pill, .rejected-pill {
      padding:5px 12px; border-radius:20px; font-weight:600; font-size:1em;
    }
    .pending-pill { background: #fff3cd; color:#856404; }
    .approved-pill { background: #d4edda; color:#155724; }
    .rejected-pill { background: #f8d7da; color:#721c24; }
    .small-muted { color:#6c757d; font-size:.94em;}
    .table { font-size: .98em;}
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-sm navbar-dark bg-primary mb-3">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <img src="assets/logo.png" alt="Logo" style="height:32px; margin-right:10px;">
        Smart Tracker
      </a>
      <div class="d-flex align-items-center ms-auto">
        <span id="userEmail" class="small-muted me-3">Loading...</span>
        <span id="planPill" class="plan-pill">â€”</span>
        <button id="logoutBtn" class="btn btn-light btn-sm ms-2">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container" style="max-width:1000px;">
    <!-- Ad area -->
    <div id="adArea" class="ad-banner">Ad placeholder</div>

    <!-- Status & Plan -->
    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-body">
            <h3>Live Status</h3>
            <div class="row">
              <div class="col-6"><strong>Online:</strong> <span id="onlineStatus">Checking...</span></div>
              <div class="col-6"><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
            </div>
            <p><strong>Location:</strong> <span id="location">Loading...</span></p>
            <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
            <p><strong>Status:</strong> <span id="status">Loading...</span></p>
            <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <!-- Subscription -->
        <div class="card">
          <div class="card-body">
            <h3>Subscription & Upgrades</h3>
            <div>Plan: <strong id="currentPlan">Loading</strong></div>
            <div class="small-muted mt-1">Expiry: <span id="planExpiry">-</span></div>
            <div class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></div>
            <div class="mt-2">
              <button id="upgradeToSilver" class="btn btn-warning btn-sm">Request Silver (â‚¹149/mo)</button>
              <button id="upgradeToGold" class="btn btn-primary btn-sm">Request Gold (â‚¹249/mo)</button>
            </div>
            <div style="margin-top:10px;">
              <span id="requestStatusArea"></span>
            </div>
            <div class="small-muted mt-2">
              Plans: Basic (24h history, ads) â€¢ Silver (7d history, limited ads, CSV) â€¢ Gold (90d, no ads, advanced export)
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div class="card mb-4">
      <div class="card-body">
        <h3>Live Map</h3>
        <div id="map" style="height:290px;border-radius:8px;">Loading map...</div>
      </div>
    </div>

    <!-- History -->
    <div class="card mb-4">
      <div class="card-body">
        <h3>Movement History</h3>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="small-muted">Recent movements</div>
          <button id="exportCSVBtn" class="btn btn-primary btn-sm" style="display:none;">Export CSV</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-light"><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
            <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Admin panel (hidden by default) -->
    <div id="adminPanel" class="card admin-panel mb-5" style="display:none;">
      <div class="card-body">
        <h3>ðŸ”§ Admin Panel â€” Upgrade Requests</h3>
        <div id="adminList">Loading admin dataâ€¦</div>
        <hr/>
        <h5>Recent admin logs</h5>
        <div id="adminLogs">Loading logsâ€¦</div>
      </div>
    </div>
  </div>

  <!-- Interstitial (simulate for login, optional) -->
  <div id="interstitial" class="interstitial"><div class="card"><h3>Ad (simulated)</h3><p>Will close in 3s...</p></div></div>

  <!-- Modal for upsell/info -->
  <div id="modal" style="display:none;"><div class="dialog"><div id="modalContent"></div><div class="mt-3 text-end"><button id="modalClose" class="btn btn-light btn-sm">Close</button><button id="modalUpgradeBtn" class="btn btn-primary btn-sm" style="display:none;">Request Upgrade</button></div></div></div>

  <!-- JS/libraries -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- DOM refs ----------
  const userEmailEl     = document.getElementById('userEmail');
  const planPill        = document.getElementById('planPill');
  const adArea          = document.getElementById('adArea');
  const interstitial    = document.getElementById('interstitial');
  const currentPlanEl   = document.getElementById('currentPlan');
  const planExpiryEl    = document.getElementById('planExpiry');
  const vehicleLimitEl  = document.getElementById('vehicleLimit');
  const upgradeToSilverBtn = document.getElementById('upgradeToSilver');
  const upgradeToGoldBtn   = document.getElementById('upgradeToGold');
  const requestStatusArea  = document.getElementById('requestStatusArea');
  const historyTbody    = document.getElementById('history');
  const exportCSVBtn    = document.getElementById('exportCSVBtn');
  const adminPanel      = document.getElementById('adminPanel');
  const adminList       = document.getElementById('adminList');
  const adminLogs       = document.getElementById('adminLogs');
  const modal           = document.getElementById('modal');
  const modalContent    = document.getElementById('modalContent');
  const modalClose      = document.getElementById('modalClose');
  const modalUpgradeBtn = document.getElementById('modalUpgradeBtn');

  let uidGlobal = null;
  let isAdmin = false;
  let localPlan = { plan:'basic', plan_expiry:null, vehicle_limit:1, exportCSV:false };

  // ---------- Plan policies ----------
  const PLAN_POLICIES = {
    basic: { historyDays:1, ads:'banner+interstitial', vehicle_limit:1, exportCSV:false },
    silver: { historyDays:7, ads:'banner-limited', vehicle_limit:3, exportCSV:true },
    gold: { historyDays:90, ads:'no-ads', vehicle_limit:3, exportCSV:true }
  };

  function prettyTS(iso) { if(!iso) return '-'; try{ return new Date(iso).toLocaleString(); } catch(e){ return iso; } }

  // -------------- Banner Ad Logic: Responsive fetch + render -------------------
  function loadBannerAdForUser(plan) {
    // Only show ads for Basic and Silver plans
    const showAd = plan !== 'gold';
    if (!showAd) {
      adArea.style.display = 'none';
      return;
    }
    db.ref('admin/ads').once('value').then(snap => {
      const ads = snap.val() || {};
      // Find first active dashboard banner or video
      // Extend this logic to support video ads too, if needed
      const found = Object.values(ads).find(ad =>
        ad && ad.active && (ad.type === 'banner' || ad.type === 'video') &&
        (ad.placement === 'dashboard_top' || ad.placement === 'dashboard_footer') &&
        ad.url
      );
      if (found) {
        if (found.type === 'banner') {
          adArea.innerHTML = `<img src="${found.url}" alt="Ad Banner" class="img-fluid" style="max-height:62px;">`;
        } else if (found.type === 'video') {
          adArea.innerHTML = `<video controls style="max-height:62px;max-width:99vw;"><source src="${found.url}"></video>`;
        }
        adArea.style.display = 'flex';
      } else {
        adArea.innerHTML = 'No active ad';
        adArea.style.display = 'flex';
      }
    }).catch(err => {
      adArea.innerHTML = '<span class="small-muted">Ad load error</span>';
      adArea.style.display = 'flex';
      console.error('Ad fetch failed:', err);
    });
  }

  // ---------- Plan UI logic ----------
  function applyPlanToUI(udata) {
    const plan = udata.plan || 'basic';
    const plan_expiry = udata.plan_expiry || null;
    const vehicle_limit = (udata.vehicle_limit || PLAN_POLICIES[plan].vehicle_limit);
    const exportCSV = (typeof udata.exportCSV === 'boolean') ? udata.exportCSV : !!PLAN_POLICIES[plan].exportCSV;
    localPlan = { plan, plan_expiry, vehicle_limit, exportCSV };

    planPill.textContent = plan.toUpperCase();
    currentPlanEl.textContent = plan.toUpperCase();
    planExpiryEl.textContent = prettyTS(plan_expiry);
    vehicleLimitEl.textContent = vehicle_limit;
    exportCSVBtn.style.display = exportCSV ? 'inline-block' : 'none';

    // Show responsive database-powered ad banner
    loadBannerAdForUser(plan);

    // If there's a pending upgrade_request, show pending UI
    const req = udata.upgrade_request || null;
    renderRequestUI(req);
  }

  // ---------- Upgrade request UI logic ----------
  function renderRequestUI(upgradeRequest) {
    if (!upgradeRequest || !upgradeRequest.status) {
      requestStatusArea.innerHTML = '';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      return;
    }
    const s = upgradeRequest.status;
    if (s === 'pending') {
      upgradeToSilverBtn.style.display = 'none';
      upgradeToGoldBtn.style.display = 'none';
      requestStatusArea.innerHTML = `<span class="pending-pill">Upgrade to ${upgradeRequest.requestedPlan?.toUpperCase() || ''} â€” PENDING APPROVAL</span>`;
    } else if (s === 'approved') {
      upgradeToSilverBtn.style.display = 'none';
      upgradeToGoldBtn.style.display = 'none';
      requestStatusArea.innerHTML = `<span class="approved-pill">Upgrade approved â€” Enjoy your ${upgradeRequest.requestedPlan?.toUpperCase() || ''} plan</span>`;
    } else if (s === 'rejected') {
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      requestStatusArea.innerHTML = `<span class="rejected-pill">Upgrade request rejected â€” you may try again</span>`;
    } else if (s === 'cancelled') {
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      requestStatusArea.innerHTML = `<span class="small-muted">Upgrade request cancelled</span>`;
    }
  }

  // ---------- Authentication + user loader ----------
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      location.href = 'login.html';
      return;
    }
    uidGlobal = user.uid;
    userEmailEl.textContent = user.email || 'No email';

    db.ref(`users/${uidGlobal}`).once('value').then(snap => {
      const udata = snap.val() || {};
      isAdmin = udata.role === 'super-admin' || udata.role === 'admin' || udata.admin === true || udata.isAdmin === true;
      applyPlanToUI(udata);
      // Add map and history loader here as needed
    }).catch(err => {
      userEmailEl.textContent = 'Error loading user';
    });
  });

  logoutBtn.onclick = () => auth.signOut().then(()=>location.href='login.html');

  // Add your map, history, and admin panel logic as before...

  </script>
</body>
</html>
