<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Tracker Dashboard</title>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f7f9fc; }
    .dashboard { max-width: 1080px; margin:28px auto; padding:0 24px 36px 24px; }
    header {
      background: #222c37;
      color: #fff;
      padding: 22px 24px;
      border-radius: 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,.075);
    }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .logo { height:48px; }
    .app-title { font-size: 25px; font-weight: 800; letter-spacing: 0.015em; }
    .app-desc { font-size: 15px; color:#b3b8c7; margin-top: 2px; font-weight: 500; }
    .header-right { display: flex; align-items: center; gap: 18px;}
    .header-email { font-size:15px; color:#e2e6ed; font-weight: 500; }
    .plan-pill { background: linear-gradient(90deg,#2670ff,#31ffa7); color:#fff; font-weight:700; border-radius:20px; font-size:15px; padding:6px 18px; letter-spacing:0.04em; }
    .header-logout { background: #2636ad; color: #fff; font-weight:700; border:none;border-radius:8px;padding:8px 22px; cursor: pointer; font-size:15px;}
    .header-logout:hover { background:#386afa;}
    .card { background:#fff; padding:22px; margin:20px 0; border-radius:14px; box-shadow:0 2px 15px rgba(40,50,90,.09);}
    h2 { margin:0 0 10px 0; color:#191f2a; font-size:22px; font-weight:900;}
    .ad-banner { width:100%; min-height:70px; background:#e9ecef; display:flex; align-items:center; justify-content:center; border-radius:10px; margin:20px 0 22px 0; color:#333; font-weight:700; }
    #adArea img, #adArea video {border-radius:8px;object-fit:contain;display:block;max-width:100%;height:auto;}
    .switch { position: relative; display: inline-block; width: 60px; height: 30px; vertical-align:middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px;}
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;}
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(30px); }
    .badge { padding:6px 14px; border-radius:8px; font-weight:600; font-size:13px; color:#fff; }
    .badge.online { background:#28a745; }
    .badge.offline { background:#dc3545; }
    .pending-pill { background:#ffd966; color:#4a2900; padding:7px 16px; border-radius:8px; font-weight:700; font-size:15px;}
    .approved-pill { background:#31ffa7; color:#167054; padding:7px 16px; border-radius:8px; font-weight:700; font-size:15px;}
    .rejected-pill { background:#f8d7da; color:#721c24; padding:7px 16px; border-radius:8px; font-weight:700; font-size:15px;}
    .small-muted { color:#6c757d; font-size:14px; }
    .components-list { margin-top:11px; list-style:none; padding-left:0; }
    .components-list li { padding:7px 0; border-bottom:1px dashed #f0f3fa; }
    .comp-ok { color:#25ad45; font-weight:700;}
    .comp-warn { color:#e67700; font-weight:700;}
    .comp-bad { color:#c82333; font-weight:700;}
    .comp-unknown { color:#6c757d; font-weight:700;}
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:11px; border-bottom:1px solid #f2f5fc; text-align:left; font-size:15px;}
    .view-btn { background:#2670ff; color:#fff; padding:7px 15px; border-radius:8px; border:none; cursor:pointer; font-size:15px; }
    .admin-panel { margin-top:12px;}
    .btn { padding:8px 15px; border-radius:7px; border:none; cursor:pointer; font-size:15px;}
    .btn-primary { background:#2670ff; color:#fff; font-weight:700;}
    .btn-warning { background:#ffd966; color:#4a2900; font-weight:700;}
    .btn-danger { background:#dc3545; color:#fff; font-weight:700;}
    .btn-ghost { background:transparent; border:1px solid #ddd; font-weight:700;}
    #modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:10000; }
    #modal .dialog { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:520px; }
    @media (max-width:600px) {
      .dashboard {padding:0 7px;}
      header {flex-direction:column;align-items:flex-start;padding:16px 5px;}
      .header-left{gap:10px;}
      .app-title{font-size:18px;}
      .plan-pill{font-size:13px;}
      .header-logout{font-size:13px;padding:7px 13px;}
      .card{padding:13px;}
      th,td{font-size:14px;}
      .pending-pill,.approved-pill,.rejected-pill{font-size:13px;}
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div class="header-left">
        <img src="assets/logo.png" alt="Logo" class="logo"/>
        <div>
          <div class="app-title">Smart Tracker <span style="font-size:15px;font-weight:normal;background:rgba(38,112,255,.1);border-radius:7px;padding:2px 11px;color:#2670ff;margin-left:7px;" id="planPillHeader"></span></div>
          <div class="app-desc">Vehicle tracking & fleet dashboard</div>
        </div>
      </div>
      <div class="header-right">
        <span class="header-email" id="userEmail">Loading...</span>
        <span class="plan-pill" id="planPill">‚Äî</span>
        <button id="logoutBtn" class="header-logout">Logout</button>
      </div>
    </header>

    <div id="adArea" class="ad-banner">Ad placeholder</div>

    <section class="card status-card">
      <h2>üîç Live Status</h2>
      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:2px;">
        <div><strong>Online:</strong> <span id="onlineStatus"><span class='badge offline'>Checking...</span></span></div>
        <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
      </div>
      <p><strong>Location:</strong> <span id="location">Loading...</span></p>
      <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
      <p><strong>Alarm Last Trigger:</strong> <span id="alarmTrigger">No triggers</span></p>
      <div id="componentsBlock">
        <h4 style="font-size:16px;border-bottom:1px solid #f3f6ff;">Components</h4>
        <ul id="componentsList" class="components-list">
          <li class="comp-unknown">No data</li>
        </ul>
      </div>
    </section>

    <section class="card alarm-card">
      <h2>üîî Alarm</h2>
      <label class="switch">
        <input type="checkbox" id="alarmToggle">
        <span class="slider round"></span>
      </label>
      <span id="alarmStatusText" style="margin-left:14px;">Loading alarm status...</span>
    </section>

    <section class="card subscription-card">
      <h2>üí≥ Subscription & Upgrades</h2>
      <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
        <div>Plan: <strong id="currentPlan">Loading</strong></div>
        <div class="small-muted">Expiry: <span id="planExpiry">-</span></div>
        <div class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></div>
        <div id="upgradeBtns" style="margin-left:auto;">
          <button id="upgradeToSilver" class="btn btn-warning">Request Silver (‚Çπ149/mo)</button>
          <button id="upgradeToGold" class="btn btn-primary">Request Gold (‚Çπ249/mo)</button>
        </div>
      </div>
      <div style="margin-top:10px;">
        <span id="requestStatusArea"></span>
      </div>
      <div style="margin-top:14px;" class="small-muted">
        Plans: Basic (24h history, ads) ‚Ä¢ Silver (7d history, limited ads, CSV export) ‚Ä¢ Gold (90d, no ads, CSV & analytics)
      </div>
    </section>

    <section class="card map-card">
      <h2>üó∫ Live Map</h2>
      <div id="map" style="height:300px;border-radius:8px;">Loading map...</div>
    </section>

    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="small-muted">Recent movements</div>
        <div>
          <button id="exportCSVBtn" class="btn btn-primary" style="display:none;">Export CSV</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>

    <section id="adminPanel" class="card admin-panel" style="display:none;">
      <h2>üîß Admin Panel ‚Äî Upgrade Requests</h2>
      <div id="adminList">Loading admin data‚Ä¶</div>
      <hr/>
      <h3>Recent admin logs</h3>
      <div id="adminLogs">Loading logs‚Ä¶</div>
    </section>
  </div>

  <div id="modal">
    <div class="dialog">
      <div id="modalContent"></div>
      <div style="margin-top:12px;text-align:right;">
        <button id="modalClose" class="btn btn-ghost">Close</button>
        <button id="modalUpgradeBtn" class="btn btn-primary" style="display:none;">Request Upgrade</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const userEmailEl = document.getElementById('userEmail');
  const planPill = document.getElementById('planPill');
  const planPillHeader = document.getElementById('planPillHeader');
  const adArea = document.getElementById('adArea');
  const locationEl = document.getElementById("location");
  const lastActiveEl = document.getElementById("lastActive");
  const statusEl = document.getElementById("status");
  const batteryHealthEl = document.getElementById("batteryHealth");
  const historyTbody = document.getElementById("history");
  const exportCSVBtn = document.getElementById("exportCSVBtn");
  const alarmToggle = document.getElementById("alarmToggle");
  const alarmStatusText = document.getElementById("alarmStatusText");
  const alarmTriggerEl = document.getElementById("alarmTrigger");
  const onlineStatusEl = document.getElementById("onlineStatus");
  const lastSeenEl = document.getElementById("lastSeen");
  const componentsListEl = document.getElementById("componentsList");
  const currentPlanEl = document.getElementById('currentPlan');
  const planExpiryEl = document.getElementById('planExpiry');
  const vehicleLimitEl = document.getElementById('vehicleLimit');
  const upgradeBtns = document.getElementById('upgradeBtns');
  const upgradeToSilverBtn = document.getElementById('upgradeToSilver');
  const upgradeToGoldBtn = document.getElementById('upgradeToGold');
  const requestStatusArea = document.getElementById('requestStatusArea');
  const adminPanel = document.getElementById('adminPanel');
  const adminList = document.getElementById('adminList');
  const adminLogs = document.getElementById('adminLogs');
  const modal = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const modalClose = document.getElementById('modalClose');
  const modalUpgradeBtn = document.getElementById('modalUpgradeBtn');
  document.getElementById('logoutBtn').onclick = ()=> auth.signOut();

  let uidGlobal = null;
  let isAdmin = false;
  let localPlan = { plan:'basic', plan_expiry:null, vehicle_limit:1, exportCSV:false };

  const PLAN_POLICIES = {
    basic: { historyDays:1, ads:'banner+interstitial', vehicle_limit:1, exportCSV:false },
    silver: { historyDays:7, ads:'banner-limited', vehicle_limit:3, exportCSV:true },
    gold: { historyDays:90, ads:'no-ads', vehicle_limit:3, exportCSV:true }
  };
  let adTimerInt = null, currentAdIndex=0, adsList=[];
  function showAd(ad) {
    adArea.innerHTML = 'Loading...';
    if (ad.type === 'banner') {
      const img = new Image(); img.src = ad.url;
      img.onload = () => { adArea.innerHTML = ''; adArea.appendChild(img); };
    } else if (ad.type === 'video') {
      const v = document.createElement('video'); v.src = ad.url; v.controls = true; v.autoplay = true; v.muted = true;
      adArea.innerHTML = ''; adArea.appendChild(v);
    }
  }
  function loadAdsForPlan(plan) {
    if (adTimerInt) clearInterval(adTimerInt);
    const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
    if (policy.ads === 'no-ads') { adArea.style.display='none'; adArea.innerHTML=''; return; }
    adArea.style.display = 'flex';
    db.ref('admin/ads').once('value').then(snapshot => {
      const adsObj = snapshot.val() || {};
      adsList = Object.values(adsObj).filter(ad =>
        ad && ad.active && ad.url &&
        (ad.placement === 'dashboard_top' || ad.placement === 'dashboard_footer')
      );
      if (policy.ads==='banner-limited' && adsList.length > 1) { adsList = adsList.slice(0,1); }
      if (adsList.length) {
        showAd(adsList[currentAdIndex=0]);
        adTimerInt = setInterval(() => {
          currentAdIndex = (currentAdIndex + 1) % adsList.length;
          showAd(adsList[currentAdIndex]);
        }, 15000);
      } else {
        adArea.innerHTML = 'No active ad';
      }
    }).catch(err => {
      adArea.innerHTML = 'Ad load error';
    });
  }
  function renderAdsForPlan(plan) { loadAdsForPlan(plan); }
  function renderRequestUI(upgradeRequest, currentPlan) {
    upgradeToSilverBtn.style.display = 'none';
    upgradeToGoldBtn.style.display = 'none';
    let statusMsg = '';
    if (currentPlan === 'gold') {
      upgradeBtns.style.display = 'none';
      statusMsg = `<span class="approved-pill">You are on GOLD, the highest plan.</span>`;
    } else if (!upgradeRequest || !upgradeRequest.status) {
      upgradeBtns.style.display = 'block';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      statusMsg = '';
    } else if (upgradeRequest.status === 'pending') {
      upgradeBtns.style.display = 'none';
      statusMsg = `<span class="pending-pill">Upgrade to ${upgradeRequest.requestedPlan?.toUpperCase() || ''} ‚Äî PENDING APPROVAL</span>`;
    } else if (upgradeRequest.status === 'approved') {
      upgradeBtns.style.display = 'none';
      statusMsg = `<span class="approved-pill">Upgrade approved ‚Äî Enjoy your ${upgradeRequest.requestedPlan?.toUpperCase() || ''} plan</span>`;
    } else if (upgradeRequest.status === 'rejected') {
      upgradeBtns.style.display = 'block';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      statusMsg = `<span class="rejected-pill">Upgrade request rejected ‚Äî you may try again</span>`;
    } else if (upgradeRequest.status === 'cancelled') {
      upgradeBtns.style.display = 'block';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      statusMsg = `<span class="small-muted">Upgrade request cancelled</span>`;
    }
    requestStatusArea.innerHTML = statusMsg;
  }
  function prettyTS(iso) { if(!iso) return '-'; try{ return new Date(iso).toLocaleString(); } catch(e){ return iso; } }
  function applyPlanToUI(udata) {
    const plan = udata.plan || 'basic';
    const plan_expiry = udata.plan_expiry || null;
    const vehicle_limit = (udata.vehicle_limit || PLAN_POLICIES[plan].vehicle_limit);
    const exportCSV = (typeof udata.exportCSV === 'boolean') ? udata.exportCSV : !!PLAN_POLICIES[plan].exportCSV;
    localPlan = { plan, plan_expiry, vehicle_limit, exportCSV };
    planPill.textContent = plan.toUpperCase();
    currentPlanEl.textContent = plan.toUpperCase();
    planPillHeader.textContent = plan.toUpperCase();
    planExpiryEl.textContent = prettyTS(plan_expiry); vehicleLimitEl.textContent = vehicle_limit;
    exportCSVBtn.style.display = exportCSV ? 'inline-block' : 'none';
    renderAdsForPlan(plan);
    renderRequestUI(udata.upgrade_request || null, plan);
  }
  function createUpgradeRequest(uid, desiredPlan) {
    const now = new Date().toISOString();
    const req = { status:'pending', requestedPlan:desiredPlan, request_time:now };
    const updates = {};
    updates[`users/${uid}/upgrade_request`] = req;
    const adminKey = `req_${uid}_${Date.now()}`;
    updates[`admin/upgrade_requests/${adminKey}`] = { uid, requestedPlan: desiredPlan, status:'pending', request_time: now };
    return db.ref().update(updates);
  }
  async function adminApproveRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const plan = adminReqObj.requestedPlan || 'silver';
    const now = new Date();
    const expiry = new Date(now.getTime() + (30*24*60*60*1000));
    const updates = {};
    updates[`users/${targetUid}/plan`] = plan;
    updates[`users/${targetUid}/plan_expiry`] = expiry.toISOString();
    updates[`users/${targetUid}/vehicle_limit`] = PLAN_POLICIES[plan].vehicle_limit;
    updates[`users/${targetUid}/exportCSV`] = true;
    updates[`users/${targetUid}/upgrade_request/status`] = 'approved';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'approved';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, plan, approvedAt: new Date().toISOString(), adminNameDisplay:adminName||adminUid };
    await db.ref().update(updates);
    alert('User upgraded to ' + plan.toUpperCase());
  }
  async function adminRejectRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const updates = {};
    updates[`users/${targetUid}/upgrade_request/status`] = 'rejected';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'rejected';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, status:'rejected', processedAt: new Date().toISOString() };
    await db.ref().update(updates);
    alert('Request rejected.');
  }
  function checkAndAutoDowngrade(uid, udata) {
    if (!udata || !udata.plan || !udata.plan_expiry) return;
    const expiryMs = Date.parse(udata.plan_expiry);
    if (isNaN(expiryMs)) return;
    if (Date.now() >= expiryMs && udata.plan !== 'basic') {
      const updates = {
        [`users/${uid}/plan`]: 'basic',
        [`users/${uid}/plan_expiry`]: null,
        [`users/${uid}/vehicle_limit`]: PLAN_POLICIES.basic.vehicle_limit,
        [`users/${uid}/exportCSV`]: false,
        [`users/${uid}/upgrade_request/status`]: 'cancelled'
      };
      db.ref().update(updates).then(() => {
        const k = `downgrade_${uid}_${Date.now()}`;
        db.ref(`admin/downgrades/${k}`).set({ uid, old_plan:udata.plan, new_plan:'basic', time:new Date().toISOString(), reason:'expired_auto_downgrade' });
      });
    }
  }

  let map, marker;
  function updateMap(lat, lng, popupText=null) {
    if (!(typeof lat==='number' && typeof lng==='number' && !isNaN(lat) && !isNaN(lng))) return;
    if (!map) {
      map = L.map('map').setView([lat, lng], 14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([lat, lng]).addTo(map);
    } else {
      marker.setLatLng([lat, lng]); map.setView([lat, lng], 14);
    }
    if (popupText) marker.bindPopup(popupText).openPopup();
  }
  window.focusOnMap = function(lat, lng) {
    lat = parseFloat(lat); lng = parseFloat(lng);
    if (!isNaN(lat) && !isNaN(lng)) updateMap(lat, lng, `üìç ${lat}, ${lng}`);
  }
  function renderHistory(historyObj) {
    historyTbody.innerHTML = '';
    if (!historyObj) {
      historyTbody.innerHTML = '<tr><td colspan="3">No history found.</td></tr>';
      return;
    }
    const entries = Object.values(historyObj).slice().reverse();
    const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
    const cutoffMs = Date.now() - policy.historyDays * 24*60*60*1000;
    const visible = entries.filter(e => {
      if (!e.time) return false;
      const tms = Date.parse(e.time);
      if (!isNaN(tms)) return tms >= cutoffMs;
      const parts = (e.time || '').split(' ');
      if (parts.length>=2) {
        const d = parts[0].split('-'), tm = parts[1].split(':');
        if (d.length===3 && tm.length===3) {
          const dt = new Date(parseInt(d[0]),parseInt(d[1])-1,parseInt(d[2]),parseInt(tm[0]),parseInt(tm[1]),parseInt(tm[2]));
          return dt.getTime() >= cutoffMs;
        }
      }
      return false;
    });
    if (visible.length === 0) {
      historyTbody.innerHTML = '<tr><td colspan="3">No history available within your plan window.</td></tr>';
      return;
    }
    visible.forEach(entry => {
      const loc = entry.location || '';
      const time = entry.time || '';
      const [lat, lng] = (loc.split(',') || []).map(s=>parseFloat(s.trim()));
      const canFocus = !isNaN(lat) && !isNaN(lng);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${time}</td><td>${loc}</td>
        <td><button class="view-btn"${canFocus?` onclick="focusOnMap(${lat},${lng})"`:' disabled style="opacity:.65;"'}>View</button></td>`;
      historyTbody.appendChild(tr);
    });
  }
  function exportHistoryCSV(histObj) {
    if (!localPlan.exportCSV) {
      showModal('CSV export is not available on your current plan. Request upgrade to Silver or Gold.', true);
      return;
    }
    if (!histObj) { alert('No history'); return; }
    const rows=[['time','location']];
    Object.values(histObj).forEach(e=>rows.push([e.time||'',''+(e.location||'')]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download = `history_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function renderComponents(obj) {
    componentsListEl.innerHTML = "";
    if (!obj || !Object.keys(obj).length) {
      componentsListEl.innerHTML = '<li class="comp-unknown">No components</li>';
      return;
    }
    for (let k in obj) {
      const v = obj[k];
      let cls = "comp-unknown";
      if (v === "ok" || v === "activity") cls = "comp-ok";
      else if (v === "no_fix" || v === "idle") cls = "comp-warn";
      else if (v === "down") cls = "comp-bad";
      componentsListEl.innerHTML += `<li class="${cls}"><strong>${k}:</strong> ${v}</li>`;
    }
  }
  function parseTimestampToMs(ts) {
    if (!ts) return null;
    const parts = ts.split(' ');
    if (parts.length < 2) return null;
    const [y, m, d] = parts[0].split('-').map(n => parseInt(n));
    const [hh, mm, ss] = parts[1].split(':').map(n => parseInt(n));
    return new Date(y, m-1, d, hh, mm, ss).getTime();
  }
  const ONLINE_TTL_MS = 90000;
  function computeOnlineDisplay(flag, lastActiveStr) {
    const lastActiveMs = parseTimestampToMs(lastActiveStr);
    if (!lastActiveMs) return !!flag;
    return (Date.now() - lastActiveMs <= ONLINE_TTL_MS) && !!flag;
  }
  function renderOnlineAndLastActive(flag, lastActiveStr) {
    onlineStatusEl.innerHTML = computeOnlineDisplay(flag, lastActiveStr) ?
      '<span class="badge online">ONLINE</span>' :
      '<span class="badge offline">OFFLINE</span>';
    lastActiveEl.textContent = lastActiveStr || "Unknown";
  }
  let lastActivePoller = null;
  function startLastActivePoll(uid) {
    if (lastActivePoller) clearInterval(lastActivePoller);
    lastActivePoller = setInterval(() => {
      db.ref(`users/${uid}/vehicle/current/last_active`).once('value').then(lastSnap => {
        const lastActive = lastSnap.val();
        db.ref(`users/${uid}/vehicle/online`).once('value').then(flagSnap => renderOnlineAndLastActive(flagSnap.val(), lastActive));
      });
    }, 30000);
  }
  function showModal(html, showUpgrade=false) {
    modalContent.innerHTML = html;
    modal.style.display = 'flex';
    modalUpgradeBtn.style.display = showUpgrade ? 'inline-block' : 'none';
  }
  modalClose.onclick = ()=> modal.style.display='none';
  modalUpgradeBtn.onclick = ()=> { modal.style.display='none'; };

  auth.onAuthStateChanged(async (user)=>{
    if(!user) { window.location.href='login.html'; return; }
    uidGlobal = user.uid; userEmailEl.textContent = user.email || user.uid;
    db.ref(`users/${uidGlobal}`).on('value', snap=>{
      const udata = snap.val() || {};
      applyPlanToUI(udata);
      checkAndAutoDowngrade(uidGlobal, udata);
      if (udata.admin === true) { isAdmin = true; adminPanel.style.display = 'block'; }
      else { isAdmin = false; adminPanel.style.display = 'none'; }
    });
    const ref = db.ref(`users/${uidGlobal}/vehicle`);
    ref.child("current").on("value", snap => {
      const d = snap.val(); if (!d) return;
      locationEl.textContent = d.latitude && d.longitude ? `${d.latitude}, ${d.longitude}` : "No location";
      if (d.latitude && d.longitude) updateMap(parseFloat(d.latitude), parseFloat(d.longitude));
      lastActiveEl.textContent = d.last_active || "Unknown";
      statusEl.textContent = d.status || "Unknown";
      batteryHealthEl.textContent = typeof d.battery !== 'undefined' ? `${d.battery}%` : "N/A";
      ref.child("online").once('value').then(s => renderOnlineAndLastActive(s.val(), d.last_active));
    });
    ref.child("history").on("value", snap => renderHistory(snap.val()));
    ref.child("components").on("value", snap => renderComponents(snap.val()));
    ref.child("online").on("value", snap => {
      ref.child("current/last_active").once("value").then(s2 => renderOnlineAndLastActive(snap.val(), s2.val()));
    });
    ref.child("last_seen").on("value", s => lastSeenEl.textContent = s.val() || "N/A");
    ref.child("alarm").on("value", s => {
      const st = s.val() || "off";
      alarmToggle.checked = st === "on";
      alarmStatusText.textContent = `Alarm is ${st.toUpperCase()}`;
    });
    ref.child("last_trigger").on("value", s => {
      const t = s.val();
      if (t && t.time && t.status === "alert") {
        alarmTriggerEl.innerHTML = `<span style="color:red;">‚ö†Ô∏è ${t.time} at ${t.location}</span>`;
      } else alarmTriggerEl.textContent = "No triggers";
    });
    alarmToggle.addEventListener("change", () => {
      ref.child("alarm").set(alarmToggle.checked ? "on" : "off");
    });
    startLastActivePoll(uidGlobal);

    db.ref('admin/upgrade_requests').on('value', snap=>{
      if(!isAdmin) return;
      const reqs = snap.val() || {};
      adminList.innerHTML = '<table style="width:100%"><thead><tr><th>User</th><th>Plan</th><th>When</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>';
      const tbody = adminList.querySelector('tbody'); tbody.innerHTML = '';
      Object.entries(reqs).reverse().forEach(([key, val])=>{
        const tr = document.createElement('tr');
        const when = val.request_time || '-';
        const status = val.status || '-';
        tr.innerHTML = `<td>${val.uid}</td><td>${val.requestedPlan||''}</td><td>${when}</td><td>${status}</td><td></td>`;
        const actionsTd = tr.querySelector('td:last-child');
        if (status === 'pending') {
          const aBtn = document.createElement('button'); aBtn.textContent='Approve'; aBtn.className='btn btn-primary'; aBtn.onclick = ()=> {
            adminApproveRequest(uidGlobal, user.email||uidGlobal, key, val);
          };
          const rBtn = document.createElement('button'); rBtn.textContent='Reject'; rBtn.className='btn btn-danger'; rBtn.style.marginLeft='8px'; rBtn.onclick = ()=> {
            if (!confirm('Reject this upgrade request?')) return;
            adminRejectRequest(uidGlobal, user.email||uidGlobal, key, val);
          };
          actionsTd.appendChild(aBtn); actionsTd.appendChild(rBtn);
        } else { actionsTd.textContent = 'Processed'; }
        tbody.appendChild(tr);
      });
    });
    db.ref('admin/approvals').limitToLast(50).on('value', snap=>{
      if(!isAdmin) return;
      const logs = snap.val() || {};
      adminLogs.innerHTML = '<ul style="padding-left:16px;margin:0;">' +
        Object.entries(logs).reverse().map(([k,v])=>
          `<li style="margin-bottom:6px;"><b>${v.adminName||v.adminUid||'admin'}</b> ‚Üí ${v.uid} : ${v.plan||v.status} (${v.approvedAt||v.processedAt||v.time||''})</li>`
        ).join('') + '</ul>';
    });
  });
  upgradeToSilverBtn.addEventListener('click', ()=> {
    if (!uidGlobal) return alert('Not logged in');
    createUpgradeRequest(uidGlobal, 'silver').then(()=> {
      upgradeToSilverBtn.style.display='none'; upgradeToGoldBtn.style.display='none';
      requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
    }).catch(err => { alert('Failed to send request'); });
  });
  upgradeToGoldBtn.addEventListener('click', ()=> {
    if (!uidGlobal) return alert('Not logged in');
    createUpgradeRequest(uidGlobal, 'gold').then(()=> {
      upgradeToSilverBtn.style.display='none'; upgradeToGoldBtn.style.display='none';
      requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
    }).catch(err => { alert('Failed to send request'); });
  });
  exportCSVBtn.addEventListener('click', ()=>{
    if (!uidGlobal) return;
    db.ref(`users/${uidGlobal}/vehicle/history`).once('value').then(snap=>{
      exportHistoryCSV(snap.val());
    });
  });
  </script>
</body>
</html>
