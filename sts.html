<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Tracker ‚Äî Subscription + Admin</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f7f9fc; color:#222; }
    .dashboard { max-width:1100px; margin:18px auto; padding:18px; }
    header { display:flex; align-items:center; gap:12px; justify-content:space-between; background:#343a40; color:#fff; padding:12px 20px; border-radius:10px; }
    .logo { height:40px; }
    .card { background:#fff; padding:16px; margin:18px 0; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    h2 { margin:0 0 8px 0; color:#343a40; }
    .plan-pill { padding:6px 10px; border-radius:8px; background:#f2f2f2; font-weight:700; }
    .ad-banner { width:100%; height:60px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:8px; margin-top:12px; color:#333; font-weight:700; }
    .interstitial { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999; }
    .interstitial .card { width:86%; max-width:420px; text-align:center; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-warning { background:#ffc107; color:#212529; }
    .btn-danger { background:#dc3545; color:#fff; }
    .btn-ghost { background:transparent; border:1px solid #ddd; }
    .small-muted { color:#6c757d; font-size:13px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    .view-btn { background:#007bff; color:#fff; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
    .admin-panel { margin-top:12px; }
    .pending-pill { background:#ffd966; color:#4a2900; padding:6px 10px; border-radius:6px; font-weight:700; }
    .approved-pill { background:#d4edda; color:#155724; padding:6px 10px; border-radius:6px; font-weight:700; }
    .rejected-pill { background:#f8d7da; color:#721c24; padding:6px 10px; border-radius:6px; font-weight:700; }
    #modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:10000; }
    #modal .dialog { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:520px; }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="assets/logo.png" alt="Logo" class="logo"/>
        <div>
          <div style="font-size:20px;font-weight:700;">Smart Tracker</div>
          <div style="font-size:12px;color:#ddd;">Vehicle tracking & fleet dashboard</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="userEmail" class="small-muted">Loading...</div>
        <div id="planPill" class="plan-pill">‚Äî</div>
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </header>

    <!-- Ad area -->
    <div id="adArea" class="ad-banner">Ad placeholder</div>

    <!-- Status card -->
    <section class="card status-card">
      <h2>üîç Live Status</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div><strong>Online:</strong> <span id="onlineStatus">Checking...</span></div>
        <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
      </div>
      <p><strong>Location:</strong> <span id="location">Loading...</span></p>
      <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
    </section>

    <!-- Subscription + upgrade request -->
    <section class="card subscription-card">
      <h2>üí≥ Subscription & Upgrades</h2>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div>Plan: <strong id="currentPlan">Loading</strong></div>
        <div class="small-muted">Expiry: <span id="planExpiry">-</span></div>
        <div class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></div>
        <div style="margin-left:auto;">
          <button id="upgradeToSilver" class="btn btn-warning">Request Silver (‚Çπ149/mo)</button>
          <button id="upgradeToGold" class="btn btn-primary">Request Gold (‚Çπ249/mo)</button>
        </div>
      </div>
      <div style="margin-top:10px;">
        <span id="requestStatusArea"></span>
      </div>
      <div style="margin-top:12px;" class="small-muted">
        Plans: Basic (24h history, ads) ‚Ä¢ Silver (7d history, limited ads, CSV export) ‚Ä¢ Gold (90d, no ads, CSV & analytics)
      </div>
    </section>

    <!-- Map -->
    <section class="card map-card">
      <h2>üó∫ Live Map</h2>
      <div id="map" style="height:300px;border-radius:8px;">Loading map...</div>
    </section>

    <!-- History -->
    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="small-muted">Recent movements</div>
        <div>
          <button id="exportCSVBtn" class="btn btn-primary" style="display:none;">Export CSV</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>

    <!-- Admin panel (visible only to admin users) -->
    <section id="adminPanel" class="card admin-panel" style="display:none;">
      <h2>üîß Admin Panel ‚Äî Upgrade Requests</h2>
      <div id="adminList">Loading admin data‚Ä¶</div>
      <hr/>
      <h3>Recent admin logs</h3>
      <div id="adminLogs">Loading logs‚Ä¶</div>
    </section>
  </div>

  <!-- Interstitial -->
  <div id="interstitial" class="interstitial"><div class="card"><h3>Ad (simulated)</h3><p>Will close in 3s...</p></div></div>

  <!-- Modal for upsell/info -->
  <div id="modal"><div class="dialog"><div id="modalContent"></div><div style="margin-top:12px;text-align:right;"><button id="modalClose" class="btn btn-ghost">Close</button><button id="modalUpgradeBtn" class="btn btn-primary" style="display:none;">Request Upgrade</button></div></div></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  // ---------- Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- DOM refs ----------
  const userEmailEl     = document.getElementById('userEmail');
  const planPill        = document.getElementById('planPill');
  const adArea          = document.getElementById('adArea');
  const interstitial    = document.getElementById('interstitial');
  const currentPlanEl   = document.getElementById('currentPlan');
  const planExpiryEl    = document.getElementById('planExpiry');
  const vehicleLimitEl  = document.getElementById('vehicleLimit');
  const upgradeToSilverBtn = document.getElementById('upgradeToSilver');
  const upgradeToGoldBtn   = document.getElementById('upgradeToGold');
  const requestStatusArea  = document.getElementById('requestStatusArea');
  const historyTbody    = document.getElementById('history');
  const exportCSVBtn    = document.getElementById('exportCSVBtn');
  const adminPanel      = document.getElementById('adminPanel');
  const adminList       = document.getElementById('adminList');
  const adminLogs       = document.getElementById('adminLogs');
  const modal           = document.getElementById('modal');
  const modalContent    = document.getElementById('modalContent');
  const modalClose      = document.getElementById('modalClose');
  const modalUpgradeBtn = document.getElementById('modalUpgradeBtn');

  let uidGlobal = null;
  let isAdmin = false;
  let localPlan = { plan:'basic', plan_expiry:null, vehicle_limit:1, exportCSV:false };

  // ---------- Plan policies ----------
  const PLAN_POLICIES = {
    basic: { historyDays:1, ads:'banner+interstitial', vehicle_limit:1, exportCSV:false },
    silver: { historyDays:7, ads:'banner-limited', vehicle_limit:3, exportCSV:true },
    gold: { historyDays:90, ads:'no-ads', vehicle_limit:3, exportCSV:true }
  };

  function prettyTS(iso) { if(!iso) return '-'; try{ return new Date(iso).toLocaleString(); } catch(e){ return iso; } }

  // -------------- Banner AD logic -------------------
  function loadBannerAdForUser(plan) {
      // Only show ads for Basic and Silver plans
      const showAd = plan !== 'gold';
      if (!showAd) {
          adArea.style.display = 'none';
          return;
      }
      db.ref('admin/ads').once('value').then(snap => {
          const ads = snap.val() || {};
          // Find first active dashboard banner
          const found = Object.values(ads).find(ad =>
              ad && ad.active && ad.type === 'banner' &&
              (ad.placement === 'dashboard_top' || ad.placement === 'dashboard_footer') &&
              ad.url
          );
          if (found) {
              adArea.innerHTML = `<img src="${found.url}" style="max-height:60px;border-radius:8px;">`;
              adArea.style.display = 'flex';
          } else {
              adArea.innerHTML = 'No active ad';
              adArea.style.display = 'flex';
          }
      }).catch(err => {
          adArea.innerHTML = 'Ad load error';
          adArea.style.display = 'flex';
          console.error('Ad fetch failed:', err);
      });
  }

  // ---------- Plan UI logic ----------
  function applyPlanToUI(udata) {
      const plan = udata.plan || 'basic';
      const plan_expiry = udata.plan_expiry || null;
      const vehicle_limit = (udata.vehicle_limit || PLAN_POLICIES[plan].vehicle_limit);
      const exportCSV = (typeof udata.exportCSV === 'boolean') ? udata.exportCSV : !!PLAN_POLICIES[plan].exportCSV;
      localPlan = { plan, plan_expiry, vehicle_limit, exportCSV };

      planPill.textContent = plan.toUpperCase();
      currentPlanEl.textContent = plan.toUpperCase();
      planExpiryEl.textContent = prettyTS(plan_expiry);
      vehicleLimitEl.textContent = vehicle_limit;
      exportCSVBtn.style.display = exportCSV ? 'inline-block' : 'none';

      // ------ Show database-powered ad banner -------
      loadBannerAdForUser(plan);

      // If there's a pending upgrade_request, show pending UI
      const req = udata.upgrade_request || null;
      renderRequestUI(req);
  }

  // ---------- Upgrade request UI logic ----------
  function renderRequestUI(upgradeRequest) {
      if (!upgradeRequest || !upgradeRequest.status) {
          requestStatusArea.innerHTML = '';
          upgradeToSilverBtn.style.display = 'inline-block';
          upgradeToGoldBtn.style.display = 'inline-block';
          return;
      }
      const s = upgradeRequest.status;
      if (s === 'pending') {
          upgradeToSilverBtn.style.display = 'none';
          upgradeToGoldBtn.style.display = 'none';
          requestStatusArea.innerHTML = `<span class="pending-pill">Upgrade to ${upgradeRequest.requestedPlan?.toUpperCase() || ''} ‚Äî PENDING APPROVAL</span>`;
      } else if (s === 'approved') {
          upgradeToSilverBtn.style.display = 'none';
          upgradeToGoldBtn.style.display = 'none';
          requestStatusArea.innerHTML = `<span class="approved-pill">Upgrade approved ‚Äî Enjoy your ${upgradeRequest.requestedPlan?.toUpperCase() || ''} plan</span>`;
      } else if (s === 'rejected') {
          upgradeToSilverBtn.style.display = 'inline-block';
          upgradeToGoldBtn.style.display = 'inline-block';
          requestStatusArea.innerHTML = `<span class="rejected-pill">Upgrade request rejected ‚Äî you may try again</span>`;
      } else if (s === 'cancelled') {
          upgradeToSilverBtn.style.display = 'inline-block';
          upgradeToGoldBtn.style.display = 'inline-block';
          requestStatusArea.innerHTML = `<span class="small-muted">Upgrade request cancelled</span>`;
      }
  }

  // ---------- Authentication + user loader ----------
  auth.onAuthStateChanged(async (user) => {
      if (!user) {
          location.href = 'login.html';
          return;
      }
      uidGlobal = user.uid;
      userEmailEl.textContent = user.email;

      // Load user record
      db.ref(`users/${uidGlobal}`).once('value').then(snap => {
          const udata = snap.val() || {};
          isAdmin = udata.role === 'super-admin' || udata.role === 'admin' || udata.admin === true || udata.isAdmin === true;
          applyPlanToUI(udata);
          // ... load map and history, etc ...
      }).catch(err => {
          userEmailEl.textContent = 'Error loading user';
      });
  });

  logoutBtn.onclick = () => auth.signOut().then(()=>location.href='login.html');

  // The rest of your logic for maps, history, etc. stays unchanged.

  </script>
</body>
</html>
