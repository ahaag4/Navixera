<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Public Transit Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <style>
    :root {
      --primary: #0d6efd;
      --page-bg: #f6f8fb;
      --card-bg: #ffffff;
      --card-shadow: 0 6px 24px rgba(0, 0, 0, 0.07);
      --border-radius: 0.75rem;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background-color: var(--page-bg);
      overflow: hidden; /* Prevent scrolling of the whole page */
    }
    .main-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .navbar-brand { font-weight: 600; }
    .content-wrapper {
      display: flex;
      flex-grow: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 380px;
      flex-shrink: 0;
      background: var(--card-bg);
      padding: 1.5rem;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    #map {
      flex-grow: 1;
      height: 100%;
    }
    .card-header {
      background-color: transparent;
      border-bottom: 1px solid #dee2e6;
    }
    #results ul {
        max-height: 250px;
        overflow-y: auto;
    }
    /* Responsive layout for mobile */
    @media (max-width: 992px) {
      .content-wrapper { flex-direction: column; }
      .sidebar { width: 100%; height: 45vh; flex-shrink: 1; }
      #map { height: 55vh; }
    }
  </style>
</head>
<body>

  <div class="main-container">
    <header>
      <nav class="navbar navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
          <a class="navbar-brand" href="#"><i class="bi bi-broadcast"></i> Live Public Transit Dashboard</a>
        </div>
      </nav>
    </header>

    <div class="content-wrapper">
      <aside class="sidebar">
        <div class="card border-0 mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-search"></i> Find Your Ride</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="busNo" class="form-label">Search by Vehicle Number</label>
              <div class="input-group">
                <input type="text" id="busNo" class="form-control" placeholder="e.g., 101">
                <button class="btn btn-outline-primary" type="button" onclick="app.searchByVehicleNumber()"><i class="bi bi-search"></i></button>
              </div>
            </div>
            <hr>
            <div class="mb-2">
              <label class="form-label">Search by Route</label>
              <input type="text" id="from" class="form-control mb-2" placeholder="From Stop">
              <input type="text" id="to" class="form-control" placeholder="To Stop">
            </div>
            <div class="d-grid"><button class="btn btn-primary" onclick="app.searchByRoute()">Find Routes</button></div>
          </div>
        </div>

        <div class="card border-0 flex-grow-1">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Details & Results</h5>
          </div>
          <div id="details-panel" class="card-body">
             <div id="results" class="text-muted">Click a vehicle on the map or use search to see details.</div>
          </div>
        </div>
        <div class="text-center mt-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="app.resetView()">
                <i class="bi bi-arrow-clockwise"></i> Reset View
            </button>
        </div>
      </aside>
      <main id="map"></main>
    </div>
  </div>

  <script>
    const app = {
      // --- STATE & CONFIG ---
      state: {
        map: null,
        vehicleMarkers: {},
        activeRouteLayers: [],
        allRoutesData: {},
        allVehiclesData: {}
      },
      config: {
        firebase: {
          apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
          authDomain: "svms-c0232.firebaseapp.com",
          databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
          projectId: "svms-c0232"
        },
        map: {
          initialCenter: [19.0760, 72.8777], // Mumbai
          initialZoom: 12
        },
        busIcon: L.icon({
            iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzBkNmVmZCIgd2lkdGg9IjM2cHgiIGhlaWdodD0iMzZweCI+PHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik00IDExdjVjMCAxLjEgLjkgMiAyIDJoMnYyYzAgLjU1LjQ1IDEgMSAxcy45OS0uNDUgMS0xdi0yaDR2MmMwIC41NS40NSAxIDEgMXMuOTktLjQ1IDEtMXYtMmgyYzEuMSAwIDItLjkgMi0yVjZoLTE4Yy0xLjIgMC0yIC44LTIgMi41IDAgMS42MyAxLjA3IDMgMi41IDN6bTE0LjUtNWMwIC44My0uNjcgMS41LTEuNSAxLjVTMTUgNi4zMyAxNSA1LjVzLjY3LTEuNSAxLjUtMS41UzE4LjUgNC42NyAxOC41IDUuNXptLTYuNSA3YzAgLjgzLS42NyAxLjUtMS41IDEuNVM5IDEzLjMzIDkgMTIuNXMuNjctMS41IDEuNS0xLjVTMTIgMTEuNjcgMTIgMTIuNXptLTYtN2MwIC44My0uNjcgMS41LTEuNSAxLjVTMyA2LjMzIDMgNS41cy42Ny0xLjUgMS41LTEuNVM2IDQuNjcgNiA1 HptMSA1djVjMCAuNTUuNDUgMSAxIDFoMTBjLjU1IDAgMS0uNDUgMS0xdi01aC0xMlptMS0yaDEwVjZoLTEwVjloMHYweiIvPjwvc3ZnPg==',
            iconSize: [36, 36], iconAnchor: [18, 18], popupAnchor: [0, -20]
        })
      },
      
      // --- INITIALIZATION ---
      init() {
        firebase.initializeApp(this.config.firebase);
        this.db = firebase.database();
        this.initMap();
        this.loadStaticData().then(() => {
            this.listenForLiveVehicleData();
        });
      },

      initMap() {
        this.state.map = L.map('map').setView(this.config.map.initialCenter, this.config.map.initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(this.state.map);
      },

      // --- DATA FETCHING & HANDLING ---
      async loadStaticData() {
        const snapshot = await this.db.ref('public_routes').once('value');
        this.state.allRoutesData = snapshot.val() || {};
      },

      listenForLiveVehicleData() {
        this.db.ref('public_vehicles').on('value', snapshot => {
          this.state.allVehiclesData = snapshot.val() || {};
          this.updateAllVehicleMarkers();
        });
      },

      // --- MAP & UI LOGIC ---
      updateAllVehicleMarkers() {
        Object.entries(this.state.allVehiclesData).forEach(([vehicleId, vehicle]) => {
          if (!vehicle.lat || !vehicle.lng) return;
          const latLng = [vehicle.lat, vehicle.lng];
          
          if (this.state.vehicleMarkers[vehicleId]) {
            this.state.vehicleMarkers[vehicleId].setLatLng(latLng);
          } else {
            const marker = L.marker(latLng, { icon: this.config.busIcon }).addTo(this.state.map);
            marker.on('click', () => this.showVehicleDetails(vehicleId));
            this.state.vehicleMarkers[vehicleId] = marker;
          }
        });
      },

      showVehicleDetails(vehicleId) {
        this.clearActiveRoute();
        const vehicle = this.state.allVehiclesData[vehicleId];
        if (!vehicle) return;
        
        const route = this.state.allRoutesData[vehicle.routeId];
        if (!route) {
            document.getElementById('results').innerHTML = `<div class="alert alert-warning">Route data not found for this vehicle.</div>`;
            return;
        }

        // Update details panel
        let stopsHtml = route.stops.map(s => `<li>${s.name}</li>`).join('');
        document.getElementById('results').innerHTML = `
            <h4>${route.routeName}</h4>
            <p><strong>Vehicle Number:</strong> ${vehicle.vehicleNumber} (${vehicle.type || 'N/A'})</p>
            <p><strong>Stops on this route:</strong></p>
            <ul class="list-unstyled">${stopsHtml}</ul>`;

        // Draw route path and stops on map
        if (route.path?.length) {
            const polyline = L.polyline(route.path, { color: 'var(--primary)', weight: 5 }).addTo(this.state.map);
            this.state.activeRouteLayers.push(polyline);
            this.state.map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
        }
        route.stops.forEach(stop => {
            const stopMarker = L.circleMarker(stop.latlng, { radius: 6, color: 'red', fillColor: '#f03', fillOpacity: 1 }).addTo(this.state.map).bindPopup(stop.name);
            this.state.activeRouteLayers.push(stopMarker);
        });
        
        this.state.vehicleMarkers[vehicleId]?.bindPopup(`<b>Bus ${vehicle.vehicleNumber}</b><br>${route.routeName}`).openPopup();
      },

      clearActiveRoute() {
        this.state.activeRouteLayers.forEach(layer => this.state.map.removeLayer(layer));
        this.state.activeRouteLayers = [];
      },

      resetView() {
        this.clearActiveRoute();
        document.getElementById('busNo').value = '';
        document.getElementById('from').value = '';
        document.getElementById('to').value = '';
        document.getElementById('results').innerHTML = '<div class="text-muted">Click a vehicle or search to see details.</div>';
        this.state.map.setView(this.config.map.initialCenter, this.config.map.initialZoom);
      },

      // --- SEARCH FUNCTIONALITY ---
      searchByVehicleNumber() {
        const busNo = document.getElementById('busNo').value.trim();
        if (!busNo) return;
        
        const found = Object.entries(this.state.allVehiclesData).find(([id, data]) => data.vehicleNumber === busNo);
        if (found) {
            this.showVehicleDetails(found[0]);
        } else {
            document.getElementById('results').innerHTML = `<div class="alert alert-danger">Vehicle number "${busNo}" not found.</div>`;
        }
      },

      searchByRoute() {
        const from = document.getElementById('from').value.trim().toLowerCase();
        const to = document.getElementById('to').value.trim().toLowerCase();
        if (!from || !to) return;

        const matchingRoutes = Object.entries(this.state.allRoutesData).filter(([id, data]) => {
            const stopNames = data.stops.map(s => s.name.toLowerCase());
            return stopNames.includes(from) && stopNames.includes(to);
        });
        
        const resultsDiv = document.getElementById('results');
        if (matchingRoutes.length > 0) {
            let html = `<h5>Matching Routes:</h5><ul class="list-group">`;
            matchingRoutes.forEach(([routeId, routeData]) => {
                const vehicle = Object.entries(this.state.allVehiclesData).find(([vId, vData]) => vData.routeId === routeId);
                if (vehicle) {
                    html += `<li class="list-group-item list-group-item-action" style="cursor:pointer;" onclick="app.showVehicleDetails('${vehicle[0]}')">
                        <strong>${routeData.routeName}</strong>
                        <br><small>Active Vehicle: #${vehicle[1].vehicleNumber}</small>
                    </li>`;
                }
            });
            html += `</ul>`;
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-warning">No direct routes found from "${from}" to "${to}".</div>`;
        }
      }
    };

    document.addEventListener('DOMContentLoaded', () => app.init());
  </script>
</body>
</html>
