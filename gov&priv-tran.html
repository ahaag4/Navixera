<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Company Admin Panel — Navixera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

  <style>
    :root {
      --primary: #0d6efd;
      --muted: #6c757d;
      --card-bg: #fff;
      --page-bg: #f6f8fb;
    }
    html, body { height: 100%; margin: 0; }
    body { background: var(--page-bg); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .navbar { background: linear-gradient(90deg, var(--primary), #1a7bff); }
    .navbar-brand { color: #fff !important; font-weight: 600; }
    .card { border: 0; border-radius: 12px; box-shadow: 0 6px 18px rgba(13, 110, 253, 0.06); }
    .stat-card { padding: 18px; border-radius: 10px; background: var(--card-bg); text-align: center; }
    .stat-card h3 { margin: 0; color: var(--primary); font-weight: 700; }
    .small-muted { color: var(--muted); font-size: .9rem; }
    .controls-row > * { margin-right: .5rem; margin-bottom: .5rem; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
    .stop-list { max-height: 200px; overflow-y: auto; }
    @media (max-width: 992px) {
      .controls-row > * { margin-right: 0; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-3">
    <div class="container">
      <a class="navbar-brand" href="#">Company Admin — Navixera</a>
      <div class="d-flex align-items-center ms-auto gap-2">
        <span id="currentUser" class="text-white small-muted"></span>
        <button id="logoutBtn" class="btn btn-light btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container mb-5">
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Companies</div>
          <h3 id="statCompanies">0</h3>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Vehicles</div>
          <h3 id="statVehicles">0</h3>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Active Deliveries</div>
          <h3 id="statDeliveries">0</h3>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Alerts Today</div>
          <h3 id="statAlerts">0</h3>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Manage Public Vehicles</h5>
        <div class="row controls-row">
          <div class="col-md-3">
            <input id="publicVehicleId" class="form-control" placeholder="Vehicle ID (e.g., MH-01-AB-1234)">
          </div>
          <div class="col-md-3">
            <input id="publicVehicleType" class="form-control" placeholder="Vehicle Type (e.g., Bus)">
          </div>
          <div class="col-md-3">
            <input id="publicVehicleGps" class="form-control" placeholder="GPS (lat,lng)">
          </div>
          <div class="col-md-3">
            <input id="publicRouteName" class="form-control" placeholder="Route Name (e.g., Route 101)">
          </div>
        </div>
        <div class="row controls-row mt-2">
          <div class="col-12">
            <h6>Add Stops</h6>
            <div class="input-group mb-2">
              <input id="stopName" class="form-control" placeholder="Stop Name">
              <input id="stopGps" class="form-control" placeholder="Stop GPS (lat,lng)">
              <button id="addStopBtn" class="btn btn-outline-primary">Add Stop</button>
            </div>
            <ul id="stopList" class="list-group stop-list"></ul>
          </div>
        </div>
        <div class="row controls-row mt-2">
          <div class="col-md-6">
            <button id="addPublicVehicleBtn" class="btn btn-primary">Add/Update Public Vehicle</button>
          </div>
          <div class="col-md-6">
            <button id="deletePublicVehicleBtn" class="btn btn-danger">Delete Public Vehicle</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Manage Bus Stops</h5>
        <div class="row controls-row">
          <div class="col-md-3">
            <input id="stopId" class="form-control" placeholder="Stop ID (e.g., STOP001)">
          </div>
          <div class="col-md-3">
            <input id="stopNameInput" class="form-control" placeholder="Stop Name (e.g., Central Station)">
          </div>
          <div class="col-md-3">
            <input id="stopGpsInput" class="form-control" placeholder="GPS (lat,lng)">
          </div>
          <div class="col-md-3">
            <input id="stopVehicleId" class="form-control" placeholder="Vehicle ID (optional)">
          </div>
        </div>
        <div class="row controls-row mt-2">
          <div class="col-md-3">
            <input id="stopVehicleRoute" class="form-control" placeholder="Route Name (optional)">
          </div>
          <div class="col-md-3">
            <input id="stopVehicleType" class="form-control" placeholder="Vehicle Type (e.g., AC)">
          </div>
          <div class="col-md-3">
            <input id="stopVehicleTimings" class="form-control" placeholder="Timings (e.g., Every 15 min)">
          </div>
          <div class="col-md-3">
            <button id="addStopVehicleBtn" class="btn btn-outline-primary">Add Vehicle to Stop</button>
          </div>
        </div>
        <div class="row controls-row mt-2">
          <div class="col-md-6">
            <button id="addBusStopBtn" class="btn btn-primary">Add/Update Bus Stop</button>
          </div>
          <div class="col-md-6">
            <button id="deleteBusStopBtn" class="btn btn-danger">Delete Bus Stop</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <script>
    /****************************************************************
     * Company Admin Panel — Navixera
     * - Manages public vehicles and bus stops for Live Transit Dashboard
     * - Uses Firebase compat (v9 compat scripts)
     ****************************************************************/

    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM References
    const currentUserEl = document.getElementById('currentUser');
    const logoutBtn = document.getElementById('logoutBtn');
    const statCompanies = document.getElementById('statCompanies');
    const statVehicles = document.getElementById('statVehicles');
    const statDeliveries = document.getElementById('statDeliveries');
    const statAlerts = document.getElementById('statAlerts');
    const publicVehicleId = document.getElementById('publicVehicleId');
    const publicVehicleType = document.getElementById('publicVehicleType');
    const publicVehicleGps = document.getElementById('publicVehicleGps');
    const publicRouteName = document.getElementById('publicRouteName');
    const stopName = document.getElementById('stopName');
    const stopGps = document.getElementById('stopGps');
    const addStopBtn = document.getElementById('addStopBtn');
    const stopList = document.getElementById('stopList');
    const addPublicVehicleBtn = document.getElementById('addPublicVehicleBtn');
    const deletePublicVehicleBtn = document.getElementById('deletePublicVehicleBtn');
    const stopId = document.getElementById('stopId');
    const stopNameInput = document.getElementById('stopNameInput');
    const stopGpsInput = document.getElementById('stopGpsInput');
    const stopVehicleId = document.getElementById('stopVehicleId');
    const stopVehicleRoute = document.getElementById('stopVehicleRoute');
    const stopVehicleType = document.getElementById('stopVehicleType');
    const stopVehicleTimings = document.getElementById('stopVehicleTimings');
    const addStopVehicleBtn = document.getElementById('addStopVehicleBtn');
    const addBusStopBtn = document.getElementById('addBusStopBtn');
    const deleteBusStopBtn = document.getElementById('deleteBusStopBtn');

    // Local State
    let uid = null;
    let companyName = null;
    let tempStops = [];
    let tempStopVehicles = [];

    // Toast Helper
    const showToast = (message, type = 'info', ttl = 3500) => {
      const div = document.createElement('div');
      div.className = `toast align-items-center text-bg-${type} border-0`;
      div.setAttribute('role', 'alert');
      div.setAttribute('aria-live', 'assertive');
      div.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>`;
      document.querySelector('.toast-container').appendChild(div);
      const t = new bootstrap.Toast(div, { delay: ttl });
      t.show();
      div.addEventListener('hidden.bs.toast', () => div.remove());
    };

    // Parse GPS
    const parseGps = (gps) => {
      if (!gps) return null;
      const parts = String(gps).split(',').map(s => s.trim());
      if (parts.length < 2) return null;
      const lat = Number(parts[0]), lng = Number(parts[1]);
      if (!isFinite(lat) || !isFinite(lng)) return null;
      if (lat === 0 && lng === 0) return null;
      return [lat, lng];
    };

    // Auth & Initialization
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        console.log('No user logged in, redirecting to login.html');
        window.location.href = 'login.html';
        return;
      }
      uid = user.uid;
      try {
        console.log('Fetching user data for UID:', uid);
        const snap = await db.ref(`users/${uid}`).once('value');
        const me = snap.val();
        if (!me) {
          console.error('User record not found for UID:', uid);
          showToast('User record not found', 'danger');
          auth.signOut();
          return;
        }
        if (me.role !== 'company') {
          console.error('User role is not company:', me.role);
          showToast('Unauthorized: Not a company account', 'danger');
          auth.signOut();
          return;
        }
        if (me.approved !== true) {
          console.error('User not approved:', me.approved);
          showToast('Waiting for approval', 'warning');
          auth.signOut();
          return;
        }
        companyName = me.companyName || 'default';
        currentUserEl.textContent = `${me.email || user.email} (${companyName})`;
        console.log('User initialized successfully:', { uid, companyName });

        loadStats();
        addStopBtn.addEventListener('click', handleAddStop);
        addPublicVehicleBtn.addEventListener('click', handleAddPublicVehicle);
        deletePublicVehicleBtn.addEventListener('click', handleDeletePublicVehicle);
        addStopVehicleBtn.addEventListener('click', handleAddStopVehicle);
        addBusStopBtn.addEventListener('click', handleAddBusStop);
        deleteBusStopBtn.addEventListener('click', handleDeleteBusStop);
        logoutBtn.addEventListener('click', () => {
          console.log('Logging out user:', uid);
          auth.signOut();
        });
      } catch (err) {
        console.error('Initialization error:', err);
        showToast(`Initialization failed: ${err.message}`, 'danger');
      }
    });

    // Handle Add Stop (for vehicle)
    const handleAddStop = () => {
      const name = stopName.value.trim();
      const gps = stopGps.value.trim();
      if (!name || !gps) {
        showToast('Enter stop name and GPS', 'warning');
        return;
      }
      if (!parseGps(gps)) {
        showToast('Invalid GPS format (use lat,lng)', 'warning');
        return;
      }
      tempStops.push({ name, gps });
      stopName.value = '';
      stopGps.value = '';
      renderStopList();
      console.log('Added stop:', { name, gps });
    };

    // Render Stop List (for vehicle)
    const renderStopList = () => {
      stopList.innerHTML = '';
      tempStops.forEach((stop, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `${stop.name} (${stop.gps})
          <button class="btn btn-sm btn-outline-danger" data-index="${index}">Remove</button>`;
        li.querySelector('button').addEventListener('click', () => {
          tempStops.splice(index, 1);
          renderStopList();
          console.log('Removed stop at index:', index);
        });
        stopList.appendChild(li);
      });
    };

    // Handle Add Public Vehicle
    const handleAddPublicVehicle = async () => {
      const vid = publicVehicleId.value.trim();
      const vtype = publicVehicleType.value.trim();
      const gps = publicVehicleGps.value.trim();
      const routeName = publicRouteName.value.trim();
      if (!vid || !vtype || !gps || !routeName) {
        showToast('Fill all fields', 'warning');
        return;
      }
      if (!parseGps(gps)) {
        showToast('Invalid GPS format (use lat,lng)', 'warning');
        return;
      }
      try {
        const fullRoutePath = tempStops.map(s => s.gps);
        const obj = {
          vehicleType: vtype,
          vehicleNumber: vid,
          gps,
          battery: Math.floor(Math.random() * 20) + 80,
          companyName,
          routeName,
          stops: tempStops,
          fullRoutePath
        };
        await db.ref(`public_transport/vehicles/${vid}`).update(obj);
        showToast('Public vehicle added/updated', 'success');
        publicVehicleId.value = '';
        publicVehicleType.value = '';
        publicVehicleGps.value = '';
        publicRouteName.value = '';
        tempStops = [];
        renderStopList();
        console.log('Added/updated public vehicle:', obj);
      } catch (err) {
        console.error('Failed to add public vehicle:', err);
        showToast(`Failed to add public vehicle: ${err.message}`, 'danger');
      }
    };

    // Handle Delete Public Vehicle
    const handleDeletePublicVehicle = async () => {
      const vid = publicVehicleId.value.trim();
      if (!vid) {
        showToast('Enter vehicle ID to delete', 'warning');
        return;
      }
      if (!confirm(`Delete public vehicle ${vid}?`)) return;
      try {
        await db.ref(`public_transport/vehicles/${vid}`).remove();
        showToast('Public vehicle deleted', 'success');
        publicVehicleId.value = '';
        tempStops = [];
        renderStopList();
        console.log('Deleted public vehicle:', vid);
      } catch (err) {
        console.error('Failed to delete public vehicle:', err);
        showToast(`Delete failed: ${err.message}`, 'danger');
      }
    };

    // Handle Add Vehicle to Stop
    const handleAddStopVehicle = () => {
      const vehicleId = stopVehicleId.value.trim();
      const routeName = stopVehicleRoute.value.trim();
      const type = stopVehicleType.value.trim();
      const timings = stopVehicleTimings.value.trim();
      if (!vehicleId || !routeName || !type) {
        showToast('Enter vehicle ID, route name, and type', 'warning');
        return;
      }
      tempStopVehicles.push({ vehicleId, routeName, type, timings });
      stopVehicleId.value = '';
      stopVehicleRoute.value = '';
      stopVehicleType.value = '';
      stopVehicleTimings.value = '';
      showToast('Vehicle added to stop (save stop to persist)', 'info');
    };

    // Handle Add Bus Stop
    const handleAddBusStop = async () => {
      const id = stopId.value.trim();
      const name = stopNameInput.value.trim();
      const gps = stopGpsInput.value.trim();
      if (!id || !name || !gps) {
        showToast('Fill all stop fields', 'warning');
        return;
      }
      if (!parseGps(gps)) {
        showToast('Invalid GPS format (use lat,lng)', 'warning');
        return;
      }
      try {
        const obj = {
          name,
          gps,
          vehicles: tempStopVehicles
        };
        await db.ref(`public_transport/stops/${id}`).update(obj);
        showToast('Bus stop added/updated', 'success');
        stopId.value = '';
        stopNameInput.value = '';
        stopGpsInput.value = '';
        tempStopVehicles = [];
        console.log('Added/updated bus stop:', obj);
      } catch (err) {
        console.error('Failed to add bus stop:', err);
        showToast(`Failed to add bus stop: ${err.message}`, 'danger');
      }
    };

    // Handle Delete Bus Stop
    const handleDeleteBusStop = async () => {
      const id = stopId.value.trim();
      if (!id) {
        showToast('Enter stop ID to delete', 'warning');
        return;
      }
      if (!confirm(`Delete bus stop ${id}?`)) return;
      try {
        await db.ref(`public_transport/stops/${id}`).remove();
        showToast('Bus stop deleted', 'success');
        stopId.value = '';
        tempStopVehicles = [];
        console.log('Deleted bus stop:', id);
      } catch (err) {
        console.error('Failed to delete bus stop:', err);
        showToast(`Delete failed: ${err.message}`, 'danger');
      }
    };

    // Load Stats
    const loadStats = async () => {
      try {
        const snap = await db.ref(`users/${uid}/vehicle/companies/${companyName}/vehicle`).once('value');
        const vehicles = snap.val() || {};
        const vehicleCount = Object.keys(vehicles).length;
        let deliveries = 0;
        let alerts = 0;
        const today = new Date().toDateString();
        Object.values(vehicles).forEach(v => {
          const d = v.deliveries || {};
          deliveries += Object.keys(d).length;
          const lt = v.last_trigger;
          if (lt && lt.status === 'alert' && lt.time && new Date(lt.time).toDateString() === today) alerts++;
        });
        statVehicles.innerText = vehicleCount;
        statDeliveries.innerText = deliveries;
        statAlerts.innerText = alerts;
        statCompanies.innerText = 1;
        console.log('Stats loaded:', { vehicleCount, deliveries, alerts });
      } catch (err) {
        console.error('Failed to load stats:', err);
        showToast(`Failed to load stats: ${err.message}`, 'danger');
      }
    };
  </script>
</body>
  </html>
