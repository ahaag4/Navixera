<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Company Admin Panel — Navixera</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root {
      --primary: #0d6efd;
      --muted: #6c757d;
      --card-bg: #fff;
      --page-bg: #f6f8fb;
    }
    html, body { height: 100%; }
    body { background: var(--page-bg); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .navbar { background: linear-gradient(90deg, var(--primary), #1a7bff); }
    .navbar-brand { color: #fff !important; font-weight: 600; }
    .card { border: 0; border-radius: 12px; box-shadow: 0 6px 18px rgba(13, 110, 253, 0.06); }
    .stat-card { padding: 18px; border-radius: 10px; background: var(--card-bg); text-align: center; }
    .stat-card h3 { margin: 0; color: var(--primary); font-weight: 700; }
    #map, #historyMap { height: 360px; border-radius: 10px; }
    .small-muted { color: var(--muted); font-size: .9rem; }
    .table-responsive { max-height: 350px; overflow: auto; }
    .controls-row > * { margin-right: .5rem; margin-bottom: .5rem; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 1080; }
    .stop-list { max-height: 200px; overflow-y: auto; }
    @media (max-width: 992px) {
      #map, #historyMap { height: 260px; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg mb-3">
    <div class="container">
      <a class="navbar-brand">Company Admin — Navixera</a>
      <div class="d-flex align-items-center ms-auto gap-2">
        <span id="currentUser" class="text-white small-muted"></span>
        <button id="logoutBtn" class="btn btn-light btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <main class="container mb-5">
    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Companies</div>
          <h3 id="statCompanies">0</h3>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Vehicles</div>
          <h3 id="statVehicles">0</h3>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Active Deliveries</div>
          <h3 id="statDeliveries">0</h3>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-card">
          <div class="small-muted">Alerts Today</div>
          <h3 id="statAlerts">0</h3>
        </div>
      </div>
    </div>

    <!-- Public Vehicle Management -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Manage Public Vehicles</h5>
        <div class="row controls-row">
          <div class="col-md-3">
            <input id="publicVehicleId" class="form-control" placeholder="Vehicle ID (e.g., MH-01-AB-1234)">
          </div>
          <div class="col-md-3">
            <input id="publicVehicleType" class="form-control" placeholder="Vehicle Type (e.g., Bus)">
          </div>
          <div class="col-md-3">
            <input id="publicVehicleGps" class="form-control" placeholder="GPS (lat,lng)">
          </div>
          <div class="col-md-3">
            <input id="publicRouteName" class="form-control" placeholder="Route Name (e.g., Route 101)">
          </div>
        </div>
        <div class="row controls-row mt-2">
          <div class="col-12">
            <h6>Add Stops</h6>
            <div class="input-group mb-2">
              <input id="stopName" class="form-control" placeholder="Stop Name">
              <input id="stopGps" class="form-control" placeholder="Stop GPS (lat,lng)">
              <button id="addStopBtn" class="btn btn-outline-primary">Add Stop</button>
            </div>
            <ul id="stopList" class="list-group stop-list"></ul>
          </div>
        </div>
        <div class="row controls-row mt-2">
          <div class="col-md-6">
            <button id="addPublicVehicleBtn" class="btn btn-primary">Add/Update Public Vehicle</button>
          </div>
          <div class="col-md-6">
            <button id="deletePublicVehicleBtn" class="btn btn-danger">Delete Public Vehicle</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Leaflet and Bootstrap JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /****************************************************************
     * Company Admin Panel — Navixera
     * - Extended to manage public vehicles for Live Transit Dashboard
     * - Uses Firebase compat (v9 compat scripts)
     ****************************************************************/

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM References
    const currentUserEl = document.getElementById('currentUser');
    const logoutBtn = document.getElementById('logoutBtn');
    const statCompanies = document.getElementById('statCompanies');
    const statVehicles = document.getElementById('statVehicles');
    const statDeliveries = document.getElementById('statDeliveries');
    const statAlerts = document.getElementById('statAlerts');
    const publicVehicleId = document.getElementById('publicVehicleId');
    const publicVehicleType = document.getElementById('publicVehicleType');
    const publicVehicleGps = document.getElementById('publicVehicleGps');
    const publicRouteName = document.getElementById('publicRouteName');
    const stopName = document.getElementById('stopName');
    const stopGps = document.getElementById('stopGps');
    const addStopBtn = document.getElementById('addStopBtn');
    const stopList = document.getElementById('stopList');
    const addPublicVehicleBtn = document.getElementById('addPublicVehicleBtn');
    const deletePublicVehicleBtn = document.getElementById('deletePublicVehicleBtn');

    // Local State
    let uid = null;
    let companyName = null;
    let map, historyMap;
    let markerGroup = L.featureGroup();
    const markers = {};
    let tempStops = []; // Temporary array for stops before saving

    // Toast Helper
    function showToast(message, type = 'info', ttl = 3500) {
      const div = document.createElement('div');
      div.className = `toast align-items-center text-bg-${type} border-0`;
      div.setAttribute('role', 'alert');
      div.setAttribute('aria-live', 'assertive');
      div.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="close"></button>
        </div>`;
      document.querySelector('.toast-container').appendChild(div);
      const t = new bootstrap.Toast(div, { delay: ttl });
      t.show();
      div.addEventListener('hidden.bs.toast', () => div.remove());
    }

    // Parse GPS
    function parseGps(gps) {
      if (!gps) return null;
      const parts = String(gps).split(',').map(s => s.trim());
      if (parts.length < 2) return null;
      const lat = Number(parts[0]), lng = Number(parts[1]);
      if (!isFinite(lat) || !isFinite(lng)) return null;
      if (lat === 0 && lng === 0) return null;
      return [lat, lng];
    }

    // Auth & Initialization
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      uid = user.uid;
      try {
        const snap = await db.ref(`users/${uid}`).once('value');
        const me = snap.val();
        if (!me) { showToast('User record not found', 'danger'); auth.signOut(); return; }
        if (me.role !== 'company') { showToast('Unauthorized', 'danger'); auth.signOut(); return; }
        if (me.approved !== true) { showToast('Waiting for approval', 'warning'); auth.signOut(); return; }
        companyName = me.companyName || 'default';
        currentUserEl.textContent = `${me.email || user.email} (${companyName})`;

        initMap();
        setupRealtimeListeners();
        loadStats();
        addStopBtn.addEventListener('click', handleAddStop);
        addPublicVehicleBtn.addEventListener('click', handleAddPublicVehicle);
        deletePublicVehicleBtn.addEventListener('click', handleDeletePublicVehicle);
        logoutBtn.addEventListener('click', () => auth.signOut());
      } catch (err) {
        console.error(err);
        showToast('Initialization failed', 'danger');
      }
    });

    // Initialize Map
    function initMap() {
      map = L.map('map').setView([19.2183, 72.9781], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
      markerGroup.addTo(map);

      historyMap = L.map('historyMap').setView([19.2183, 72.9781], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(historyMap);
    }

    // Realtime Vehicle Listeners (Existing)
    function setupRealtimeListeners() {
      const vehiclesRef = db.ref(`users/${uid}/vehicle/companies/${companyName}/vehicle`);
      vehiclesRef.on('value', snap => {
        const vehicles = snap.val() || {};
        const bounds = [];
        const present = new Set();

        Object.entries(vehicles).forEach(([vid, v]) => {
          present.add(vid);
          const coords = parseGps(v.gps);
          if (coords) {
            if (!markers[vid]) {
              const m = L.marker(coords, { title: vid }).addTo(markerGroup);
              m.bindPopup(vehiclePopupHtml(vid, v));
              markers[vid] = m;
            } else {
              markers[vid].setLatLng(coords);
              const popup = markers[vid].getPopup();
              if (popup) popup.setContent(vehiclePopupHtml(vid, v));
            }
            bounds.push(coords);
          }
        });

        Object.keys(markers).forEach(k => {
          if (!present.has(k)) {
            try { markerGroup.removeLayer(markers[k]); } catch (e) {}
            delete markers[k];
          }
        });

        if (bounds.length) {
          try { map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 }); } catch (e) {}
        }
      }, err => {
        console.error('Vehicles listener error:', err);
      });
    }

    function vehiclePopupHtml(vid, v) {
      return `<div><strong>${vid}</strong><div class="small text-muted">${v.vehicleType || 'Unknown'}</div>
              <div class="mt-2 small"><b>Battery:</b> ${v.battery ?? 'N/A'}%<br/><b>GPS:</b> ${v.gps || 'Unknown'}</div></div>`;
    }

    // Handle Add Stop
    function handleAddStop() {
      const name = stopName.value.trim();
      const gps = stopGps.value.trim();
      if (!name || !gps) {
        showToast('Enter stop name and GPS', 'warning');
        return;
      }
      if (!parseGps(gps)) {
        showToast('Invalid GPS format', 'warning');
        return;
      }
      tempStops.push({ name, gps });
      stopName.value = '';
      stopGps.value = '';
      renderStopList();
    }

    // Render Stop List
    function renderStopList() {
      stopList.innerHTML = '';
      tempStops.forEach((stop, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `${stop.name} (${stop.gps})
          <button class="btn btn-sm btn-outline-danger" data-index="${index}">Remove</button>`;
        li.querySelector('button').addEventListener('click', () => {
          tempStops.splice(index, 1);
          renderStopList();
        });
        stopList.appendChild(li);
      });
    }

    // Handle Add Public Vehicle
    async function handleAddPublicVehicle() {
      const vid = publicVehicleId.value.trim();
      const vtype = publicVehicleType.value.trim();
      const gps = publicVehicleGps.value.trim();
      const routeName = publicRouteName.value.trim();
      if (!vid || !vtype || !gps || !routeName) {
        showToast('Fill all fields', 'warning');
        return;
      }
      if (!parseGps(gps)) {
        showToast('Invalid GPS format', 'warning');
        return;
      }
      try {
        const fullRoutePath = tempStops.map(s => s.gps);
        const obj = {
          vehicleType: vtype,
          vehicleNumber: vid,
          gps,
          battery: Math.floor(Math.random() * 20) + 80,
          companyName,
          routeName,
          stops: tempStops,
          fullRoutePath
        };
        await db.ref(`public_transport/vehicles/${vid}`).update(obj);
        showToast('Public vehicle added/updated', 'success');
        publicVehicleId.value = '';
        publicVehicleType.value = '';
        publicVehicleGps.value = '';
        publicRouteName.value = '';
        tempStops = [];
        renderStopList();
      } catch (err) {
        console.error(err);
        showToast('Failed to add public vehicle', 'danger');
      }
    }

    // Handle Delete Public Vehicle
    async function handleDeletePublicVehicle() {
      const vid = publicVehicleId.value.trim();
      if (!vid) {
        showToast('Enter vehicle ID to delete', 'warning');
        return;
      }
      if (!confirm(`Delete public vehicle ${vid}?`)) return;
      try {
        await db.ref(`public_transport/vehicles/${vid}`).remove();
        showToast('Public vehicle deleted', 'success');
        publicVehicleId.value = '';
        tempStops = [];
        renderStopList();
      } catch (err) {
        console.error(err);
        showToast('Delete failed', 'danger');
      }
    }

    // Load Stats (Existing)
    async function loadStats() {
      try {
        const snap = await db.ref(`users/${uid}/vehicle/companies/${companyName}/vehicle`).once('value');
        const vehicles = snap.val() || {};
        const vehicleCount = Object.keys(vehicles).length;
        let deliveries = 0;
        let alerts = 0;
        const today = new Date().toDateString();

        Object.values(vehicles).forEach(v => {
          const d = v.deliveries || {};
          deliveries += Object.keys(d).length;
          const lt = v.last_trigger;
          if (lt && lt.status === 'alert' && lt.time && new Date(lt.time).toDateString() === today) alerts++;
        });

        statVehicles.innerText = vehicleCount;
        statDeliveries.innerText = deliveries;
        statAlerts.innerText = alerts;
        statCompanies.innerText = 1;
      } catch (err) {
        console.error(err);
      }
    }
  </script>
</body>
  </html>
