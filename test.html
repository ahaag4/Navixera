<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Tracker</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f7f9fc; }
    .dashboard { max-width: 1000px; margin: auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; background: #343a40; color: white; padding: 10px 20px; border-radius: 10px; }
    .logo { height: 40px; }
    .card { background: white; padding: 20px; margin: 20px 0; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; color: #343a40; }
    #map { height: 300px; width: 100%; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ccc; }
    .switch { position: relative; display: inline-block; width: 60px; height: 30px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(30px); }
    .view-btn { background-color: #007bff; color: white; padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .view-btn:hover { background-color: #0056b3; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    #logoutBtn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    .status-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; margin-top: 6px; }
    .badge { padding: 6px 10px; border-radius: 6px; font-weight: 600; font-size: 13px; color: #fff; }
    .badge.online { background: #28a745; }
    .badge.offline { background: #dc3545; }
    .components-list { margin-top: 10px; list-style: none; padding-left: 0; }
    .components-list li { padding: 6px 0; border-bottom: 1px dashed #eee; }
    .comp-ok { color: #28a745; font-weight: 600; }
    .comp-warn { color: #e67700; font-weight: 600; }
    .comp-bad { color: #c82333; font-weight: 600; }
    .comp-unknown { color: #6c757d; font-weight: 600; }
    #upgradeModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #upgradeModal .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
    #upgradeModal select, #upgradeModal button { margin: 10px 0; padding: 8px; width: 100%; border-radius: 5px; }
    #upgradeModal button { background: #007bff; color: white; border: none; cursor: pointer; }
    #upgradeModal button:hover { background: #0056b3; }
    #upgradeModal .close-btn { background: #dc3545; }
    #upgradeModal .close-btn:hover { background: #c82333; }
    .ad-placeholder { background: #e9ecef; padding: 10px; text-align: center; border-radius: 6px; margin: 10px 0; }
    .map-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .map-controls select, .map-controls button, .map-controls input { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
    .map-controls button { background: #007bff; color: white; border: none; cursor: pointer; }
    .map-controls button:hover { background: #0056b3; }
    .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    .filter-controls input, .filter-controls button { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }
    .filter-controls button { background: #007bff; color: white; border: none; cursor: pointer; }
    .filter-controls button:hover { background: #0056b3; }
    .export-btn { background: #28a745; color: white; padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .export-btn:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <img src="assets/logo.png" alt="Logo" class="logo"/>
      <h1>Smart Tracker</h1>
      <div class="user-info">
        <span id="userEmail">Loading...</span>
        <span>‚Äî</span>
        <button id="logoutBtn">Logout</button>
      </div>
    </header>

    <div class="ad-placeholder">Ad placeholder</div>

    <section class="card status-card">
      <h2>üîç Live Status</h2>
      <div class="status-row">
        <div><strong>Online:</strong> <span id="onlineStatus"><span class="badge offline">Checking...</span></span></div>
        <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
      </div>
      <p><strong>Location:</strong> <span id="location">Loading...</span></p>
      <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
      <p><strong>Alarm Last Trigger:</strong> <span id="alarmTrigger">No triggers</span></p>
      <div id="componentsBlock">
        <h4>Components</h4>
        <ul id="componentsList" class="components-list">
          <li class="comp-unknown">No data</li>
        </ul>
      </div>
    </section>

    <section class="card alarm-card">
      <h2>üîî Alarm</h2>
      <label class="switch">
        <input type="checkbox" id="alarmToggle">
        <span class="slider round"></span>
      </label>
      <p id="alarmStatusText">Loading alarm status...</p>
    </section>

    <section class="card subscription-card">
      <h2>üí≥ Subscription & Upgrades</h2>
      <p><strong>Plan:</strong> <span id="subscriptionPlan">Loading</span></p>
      <p><strong>Expiry:</strong> <span id="subscriptionExpiry">-</span></p>
      <p><strong>Vehicle limit:</strong> <span id="vehicleLimit">-</span></p>
      <div>
        <button id="requestSilverBtn">Request Silver (‚Çπ149/mo)</button>
        <button id="requestGoldBtn">Request Gold (‚Çπ249/mo)</button>
      </div>
      <p style="font-size: 14px; margin-top: 10px;">
        Plans: Basic (24h history, ads) ‚Ä¢ Silver (7d history, limited ads, CSV export) ‚Ä¢ Gold (90d, no ads, CSV & analytics)
      </p>
    </section>

    <section classCHEME-card map-card">
      <h2>üó∫ Live Map</h2>
      <div class="map-controls">
        <div>
          <label>Map:</label>
          <select id="mapType">
            <option value="street">Street</option>
            <option value="satellite">Satellite</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div>
          <label>Heatmap:</label>
          <input type="checkbox" id="heatmapToggle"/>
        </div>
        <div>
          <label>Marker Icon:</label>
          <input type="file" id="markerIcon" accept="image/png,image/jpeg"/>
          <span>PNG/JPG, ~32√ó32 works best</span>
        </div>
        <div>
          <button id="addZoneBtn">Add Zone</button>
          <button id="saveZonesBtn">Save Zones</button>
          <button id="clearZonesBtn">Clear Zones</button>
        </div>
      </div>
      <div id="map">Loading map...</div>
      <p>
        <strong>Distance:</strong> <span id="distance">0.00 km</span>
        <strong>Stops:</strong> <span id="stops">0</span>
        <strong>Refresh:</strong> <span id="refresh">‚Äî</span>
      </p>
    </section>

    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div class="filter-controls">
        <div>
          <label>From:</label>
          <input type="datetime-local" id="filterFrom"/>
        </div>
        <div>
          <label>To:</label>
          <input type="datetime-local" id="filterTo"/>
        </div>
        <button id="filterBtn">Filter</button>
        <button id="clearFilterBtn">Clear</button>
      </div>
      <p>Recent movements</p>
      <p><button class="export-btn" id="exportCsvBtn">Export CSV</button></p>
      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>

    <section class="card admin-card">
      <h2>üîß Admin Panel ‚Äî Upgrade Requests</h2>
      <p id="adminRequests">Loading admin data‚Ä¶</p>
      <p>Recent admin logs</p>
      <p id="adminLogs">Loading logs‚Ä¶</p>
    </section>
  </div>

  <div id="upgradeModal">
    <div class="modal-content">
      <h3>Request Upgrade</h3>
      <select id="upgradePlan">
        <option value="silver">Silver (‚Çπ149/mo)</option>
        <option value="gold">Gold (‚Çπ249/mo)</option>
      </select>
      <button id="confirmUpgradeBtn">Request Upgrade</button>
      <button class="close-btn" id="closeModalBtn">Close</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const locationEl = document.getElementById("location");
    const lastActiveEl = document.getElementById("lastActive");
    const statusEl = document.getElementById("status");
    const batteryHealthEl = document.getElementById("batteryHealth");
    const historyEl = document.getElementById("history");
    const alarmToggle = document.getElementById("alarmToggle");
    const alarmStatusText = document.getElementById("alarmStatusText");
    const alarmTriggerEl = document.getElementById("alarmTrigger");
    const onlineStatusEl = document.getElementById("onlineStatus");
    const lastSeenEl = document.getElementById("lastSeen");
    const componentsListEl = document.getElementById("componentsList");
    const subscriptionPlanEl = document.getElementById("subscriptionPlan");
    const subscriptionExpiryEl = document.getElementById("subscriptionExpiry");
    const vehicleLimitEl = document.getElementById("vehicleLimit");
    const adminRequestsEl = document.getElementById("adminRequests");
    const adminLogsEl = document.getElementById("adminLogs");
    const requestSilverBtn = document.getElementById("requestSilverBtn");
    const requestGoldBtn = document.getElementById("requestGoldBtn");
    const upgradeModal = document.getElementById("upgradeModal");
    const upgradePlan = document.getElementById("upgradePlan");
    const confirmUpgradeBtn = document.getElementById("confirmUpgradeBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const mapTypeSelect = document.getElementById("mapType");
    const heatmapToggle = document.getElementById("heatmapToggle");
    const markerIconInput = document.getElementById("markerIcon");
    const addZoneBtn = document.getElementById("addZoneBtn");
    const saveZonesBtn = document.getElementById("saveZonesBtn");
    const clearZonesBtn = document.getElementById("clearZonesBtn");
    const filterFrom = document.getElementById("filterFrom");
    const filterTo = document.getElementById("filterTo");
    const filterBtn = document.getElementById("filterBtn");
    const clearFilterBtn = document.getElementById("clearFilterBtn");
    const exportCsvBtn = document.getElementById("exportCsvBtn");
    const distanceEl = document.getElementById("distance");
    const stopsEl = document.getElementById("stops");
    const refreshEl = document.getElementById("refresh");

    let map, marker, heatmapLayer, zones = [], historyData = [];

    function getISTTime() {
      return new Date().toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' });
    }

    function updateOnlineStatus(isOnline, isStale = false, isError = false) {
      if (isError) {
        onlineStatusEl.innerHTML = '<span class="badge offline">ERROR</span>';
      } else if (isStale) {
        onlineStatusEl.innerHTML = '<span class="badge offline">OFFLINE (Stale)</span>';
      } else if (isOnline === true) {
        onlineStatusEl.innerHTML = '<span class="badge online">ONLINE</span>';
      } else {
        onlineStatusEl.innerHTML = '<span class="badge offline">OFFLINE</span>';
      }
      console.log(`[Dashboard] Updated online status: isOnline=${isOnline}, isStale=${isStale}, isError=${isError} at ${getISTTime()}`);
    }

    function updateMap(lat, lng, popupText = null) {
      if (!map) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
      } else {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 15);
      }
      if (popupText) marker.bindPopup(popupText).openPopup();
    }

    function focusOnMap(lat, lng) {
      updateMap(lat, lng, `üìç History Location<br>${lat}, ${lng}`);
    }

    function renderComponents(obj) {
      componentsListEl.innerHTML = "";
      if (!obj) {
        componentsListEl.innerHTML = '<li class="comp-unknown">No data</li>';
        return;
      }
      const order = Object.keys(obj);
      if (order.length === 0) {
        componentsListEl.innerHTML = '<li class="comp-unknown">No components</li>';
        return;
      }
      order.forEach(k => {
        const v = obj[k];
        let cls = "comp-unknown";
        if (v === "ok" || v === "activity") cls = "comp-ok";
        else if (v === "no_fix" || v === "idle") cls = "comp-warn";
        else if (v === "down") cls = "comp-bad";
        componentsListEl.innerHTML += `<li class="${cls}"><strong>${k}:</strong> ${v}</li>`;
      });
    }

    function calculateDistanceAndStops(history) {
      let distance = 0, stops = 0;
      const points = history.map(h => ({ lat: parseFloat(h.location.split(",")[0]), lng: parseFloat(h.location.split(",")[1]) }));
      for (let i = 1; i < points.length; i++) {
        const lat1 = points[i-1].lat, lon1 = points[i-1].lng, lat2 = points[i].lat, lon2 = points[i].lng;
        const d = L.latLng(lat1, lon1).distanceTo(L.latLng(lat2, lon2)) / 1000;
        distance += d;
        if (d < 0.01) stops++;
      }
      distanceEl.textContent = distance.toFixed(2) + " km";
      stopsEl.textContent = stops;
    }

    function updateHeatmap(history) {
      if (heatmapLayer) map.removeLayer(heatmapLayer);
      if (heatmapToggle.checked) {
        const points = history.map(h => [parseFloat(h.location.split(",")[0]), parseFloat(h.location.split(",")[1]), 1]);
        heatmapLayer = L.heatLayer(points, { radius: 25 }).addTo(map);
      }
    }

    function loadDashboard(uid) {
      const userRef = db.ref(`users/${uid}`);
      const vehicleRef = userRef.child("vehicle");

      // Initial online status fetch with retries
      function fetchInitialOnlineStatus(attempt = 1, maxAttempts = 3) {
        vehicleRef.child("online").get().then((snapshot) => {
          const on = snapshot.val();
          updateOnlineStatus(on === true, false, false);
          console.log(`[Dashboard] Initial online status fetch: ${on} (attempt ${attempt}) at ${getISTTime()}`);
        }).catch((error) => {
          console.error(`[Dashboard] Error fetching initial online status (attempt ${attempt}): ${error.message} at ${getISTTime()}`);
          if (attempt < maxAttempts) {
            setTimeout(() => fetchInitialOnlineStatus(attempt + 1, maxAttempts), 3000);
          } else {
            updateOnlineStatus(false, false, true);
            console.log(`[Dashboard] Max attempts reached for initial online fetch at ${getISTTime()}`);
          }
        });
      }
      fetchInitialOnlineStatus();

      // Enhanced online status listener
      let lastOnlineUpdate = Date.now();
      const STALE_TIMEOUT = 90000; // 90 seconds, matching NodeMCU ONLINE_TTL_MS
      const CHECK_INTERVAL = 10000; // Check every 10 seconds
      let isListenerActive = false;

      function setupOnlineListener() {
        vehicleRef.child("online").off(); // Clear existing listeners
        vehicleRef.child("online").on(
          "value",
          (snapshot) => {
            const on = snapshot.val();
            isListenerActive = true;
            if (on === true) {
              lastOnlineUpdate = Date.now();
            }
            updateOnlineStatus(on === true, false, false);
            console.log(`[Dashboard] Firebase online update: ${on} at ${getISTTime()}`);
          },
          (error) => {
            isListenerActive = false;
            console.error(`[Dashboard] Error in online listener: ${error.message} at ${getISTTime()}`);
            updateOnlineStatus(false, false, true);
            setTimeout(setupOnlineListener, 3000); // Retry after 3 seconds
          }
        );
      }
      setupOnlineListener();

      // Fallback polling for online status
      const pollingInterval = setInterval(() => {
        if (!isListenerActive) {
          vehicleRef.child("online").get().then((snapshot) => {
            const on = snapshot.val();
            updateOnlineStatus(on === true, false, false);
            console.log(`[Dashboard] Polling online status: ${on} at ${getISTTime()}`);
          }).catch((error) => {
            console.error(`[Dashboard] Polling error: ${error.message} at ${getISTTime()}`);
            updateOnlineStatus(false, false, true);
          });
        }
      }, 15000);

      // Monitor Firebase connection
      const connectedRef = db.ref(".info/connected");
      connectedRef.on("value", (snapshot) => {
        const isConnected = snapshot.val();
        console.log(`[Dashboard] Firebase connection state: ${isConnected ? "Connected" : "Disconnected"} at ${getISTTime()}`);
        if (!isConnected && isListenerActive) {
          isListenerActive = false;
          setupOnlineListener();
        }
      });

      vehicleRef.child("last_seen").on("value", (snapshot) => {
        const val = snapshot.val();
        lastSeenEl.textContent = val || "N/A";
        console.log(`[Dashboard] Firebase last_seen update: ${val} at ${getISTTime()}`);
      });

      vehicleRef.child("current").on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const { latitude, longitude, status, last_active, battery } = data;
        locationEl.textContent = `${latitude}, ${longitude}`;
        lastActiveEl.textContent = last_active || "Unknown";
        statusEl.textContent = status || "Unknown";
        batteryHealthEl.textContent = battery ? `${battery}%` : "N/A";
        updateMap(latitude, longitude);
        refreshEl.textContent = getISTTime();
      });

      vehicleRef.child("components").on("value", (snapshot) => {
        renderComponents(snapshot.val());
      });

      vehicleRef.child("alarm").on("value", (snapshot) => {
        const status = snapshot.val() || "off";
        alarmToggle.checked = (status === "on");
        alarmStatusText.textContent = `Alarm is ${status.toUpperCase()}`;
      });

      vehicleRef.child("last_trigger").on("value", (snapshot) => {
        const trigger = snapshot.val();
        if (trigger && trigger.time && trigger.status === "alert") {
          alarmTriggerEl.innerHTML = `<span style="color: red;">‚ö†Ô∏è ${trigger.time} at ${trigger.location}</span>`;
        } else {
          alarmTriggerEl.textContent = "No triggers";
        }
      });

      vehicleRef.child("history").on("value", (snapshot) => {
        const history = snapshot.val();
        historyData = history ? Object.values(history) : [];
        historyEl.innerHTML = "";
        if (historyData.length) {
          historyData.reverse().forEach(entry => {
            const [lat, lng] = entry.location.split(",");
            historyEl.innerHTML += `
              <tr>
                <td>${entry.time}</td>
                <td>${entry.location}</td>
                <td><button class="view-btn" onclick="focusOnMap(${lat}, ${lng})">View</button></td>
              </tr>`;
          });
          calculateDistanceAndStops(historyData);
          updateHeatmap(historyData);
        } else {
          historyEl.innerHTML = `<tr><td colspan="3">No history found.</td></tr>`;
        }
      });

      userRef.child("subscription").on("value", (snapshot) => {
        const sub = snapshot.val() || { plan: "Basic", expiry: "-", vehicleLimit: 1 };
        subscriptionPlanEl.textContent = sub.plan;
        subscriptionExpiryEl.textContent = sub.expiry;
        vehicleLimitEl.textContent = sub.vehicleLimit;
      });

      userRef.child("upgrade_requests").on("value", (snapshot) => {
        const requests = snapshot.val();
        adminRequestsEl.innerHTML = requests ? Object.values(requests).map(r => `Plan: ${r.plan}, Time: ${r.time}`).join("<br>") : "No requests";
      });

      userRef.child("admin_logs").on("value", (snapshot) => {
        const logs = snapshot.val();
        adminLogsEl.innerHTML = logs ? Object.values(logs).map(l => `Action: ${l.action}, Time: ${l.time}`).join("<br>") : "No logs";
      });

      alarmToggle.addEventListener("change", () => {
        const newState = alarmToggle.checked ? "on" : "off";
        vehicleRef.child("alarm").set(newState);
      });

      requestSilverBtn.addEventListener("click", () => {
        upgradePlan.value = "silver";
        upgradeModal.style.display = "flex";
      });

      requestGoldBtn.addEventListener("click", () => {
        upgradePlan.value = "gold";
        upgradeModal.style.display = "flex";
      });

      confirmUpgradeBtn.addEventListener("click", () => {
        const plan = upgradePlan.value;
        userRef.child("upgrade_requests").push({ plan, time: getISTTime() });
        upgradeModal.style.display = "none";
      });

      closeModalBtn.addEventListener("click", () => {
        upgradeModal.style.display = "none";
      });

      mapTypeSelect.addEventListener("change", () => {
        const type = mapTypeSelect.value;
        if (map) {
          map.eachLayer(layer => {
            if (layer instanceof L.TileLayer) map.removeLayer(layer);
          });
          if (type === "street") {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
          } else if (type === "satellite") {
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
          } else if (type === "dark") {
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png').addTo(map);
          }
        }
      });

      heatmapToggle.addEventListener("change", () => updateHeatmap(historyData));

      markerIconInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file && marker) {
          const reader = new FileReader();
          reader.onload = () => {
            marker.setIcon(L.icon({ iconUrl: reader.result, iconSize: [32, 32] }));
          };
          reader.readAsDataURL(file);
        }
      });

      addZoneBtn.addEventListener("click", () => {
        const center = map.getCenter();
        const zone = L.circle(center, { radius: 1000, color: '#ff7800' }).addTo(map);
        zones.push(zone);
      });

      saveZonesBtn.addEventListener("click", () => {
        const zoneData = zones.map(z => ({
          center: z.getLatLng(),
          radius: z.getRadius()
        }));
        userRef.child("zones").set(zoneData);
      });

      clearZonesBtn.addEventListener("click", () => {
        zones.forEach(z => map.removeLayer(z));
        zones = [];
        userRef.child("zones").remove();
      });

      filterBtn.addEventListener("click", () => {
        const from = new Date(filterFrom.value).getTime();
        const to = new Date(filterTo.value).getTime();
        const filtered = historyData.filter(h => {
          const time = new Date(h.time).getTime();
          return time >= from && time <= to;
        });
        historyEl.innerHTML = "";
        if (filtered.length) {
          filtered.reverse().forEach(entry => {
            const [lat, lng] = entry.location.split(",");
            historyEl.innerHTML += `
              <tr>
                <td>${entry.time}</td>
                <td>${entry.location}</td>
                <td><button class="view-btn" onclick="focusOnMap(${lat}, ${lng})">View</button></td>
              </tr>`;
          });
          calculateDistanceAndStops(filtered);
          updateHeatmap(filtered);
        } else {
          historyEl.innerHTML = `<tr><td colspan="3">No history found.</td></tr>`;
        }
      });

      clearFilterBtn.addEventListener("click", () => {
        filterFrom.value = "";
        filterTo.value = "";
        historyEl.innerHTML = "";
        if (historyData.length) {
          historyData.reverse().forEach(entry => {
            const [lat, lng] = entry.location.split(",");
            historyEl.innerHTML += `
              <tr>
                <td>${entry.time}</td>
                <td>${entry.location}</td>
                <td><button class="view-btn" onclick="focusOnMap(${lat}, ${lng})">View</button></td>
              </tr>`;
          });
          calculateDistanceAndStops(historyData);
          updateHeatmap(historyData);
        }
      });

      exportCsvBtn.addEventListener("click", () => {
        const csv = "Time,Location\n" + historyData.map(h => `"${h.time}","${h.location}"`).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "history.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      // Fallback for initial loading state
      setTimeout(() => {
        if (onlineStatusEl.innerHTML.includes("Checking")) {
          updateOnlineStatus(false, false, false);
          console.log(`[Dashboard] Initial online status timeout: set to OFFLINE at ${getISTTime()}`);
        }
      }, 10000);

      // Check for stale online status
      const staleCheckInterval = setInterval(() => {
        const timeSinceUpdate = Date.now() - lastOnlineUpdate;
        if (timeSinceUpdate > STALE_TIMEOUT && isListenerActive) {
          updateOnlineStatus(false, true, false);
          console.log(`[Dashboard] Status marked as OFFLINE (Stale) after ${timeSinceUpdate}ms at ${getISTTime()}`);
        }
      }, CHECK_INTERVAL);

      // Clean up listeners and intervals on logout
      document.getElementById("logoutBtn").onclick = () => {
        clearInterval(staleCheckInterval);
        clearInterval(pollingInterval);
        vehicleRef.child("online").off();
        vehicleRef.child("current").off();
        vehicleRef.child("history").off();
        vehicleRef.child("components").off();
        vehicleRef.child("last_seen").off();
        vehicleRef.child("alarm").off();
        vehicleRef.child("last_trigger").off();
        userRef.child("subscription").off();
        userRef.child("upgrade_requests").off();
        userRef.child("admin_logs").off();
        connectedRef.off();
        auth.signOut();
      };
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        loadDashboard(user.uid);
        document.getElementById("userEmail").textContent = user.email;
      } else {
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
