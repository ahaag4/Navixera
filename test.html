<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Tracker Dashboard</title>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f7f9fc; }
    .dashboard { max-width: 1080px; margin:28px auto; padding:0 24px 36px 24px; }
    header {
      background: #222c37;
      color: #fff;
      padding: 22px 24px;
      border-radius: 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 24px;
      box-shadow: 0 2px 16px rgba(0,0,0,.075);
    }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .logo { height:48px; }
    .app-title { font-size: 25px; font-weight: 800; letter-spacing: 0.015em; }
    .app-desc { font-size: 15px; color:#b3b8c7; margin-top: 2px; font-weight: 500; }
    .header-right { display: flex; align-items: center; gap: 18px;}
    .header-email { font-size:15px; color:#e2e6ed; font-weight: 500; }
    .plan-pill { background: linear-gradient(90deg,#2670ff,#31ffa7); color:#fff; font-weight:700; border-radius:20px; font-size:15px; padding:6px 18px; letter-spacing:0.04em; }
    .header-logout { background: #2636ad; color: #fff; font-weight:700; border:none;border-radius:8px;padding:8px 22px; cursor: pointer; font-size:15px;}
    .header-logout:hover { background:#386afa;}
    .card { background:#fff; padding:22px; margin:20px 0; border-radius:14px; box-shadow:0 2px 15px rgba(40,50,90,.09);}
    h2 { margin:0 0 10px 0; color:#191f2a; font-size:22px; font-weight:900;}
    .ad-banner { width:100%; min-height:70px; background:#e9ecef; display:flex; align-items:center; justify-content:center; border-radius:10px; margin:20px 0 22px 0; color:#333; font-weight:700; }
    #adArea img, #adArea video {border-radius:8px;object-fit:contain;display:block;max-width:100%;height:auto;}
    .switch { position: relative; display: inline-block; width: 60px; height: 30px; vertical-align:middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 30px;}
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%;}
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(30px); }
    .badge { padding:6px 14px; border-radius:8px; font-weight:600; font-size:13px; color:#fff; }
    .badge.online { background:#28a745; }
    .badge.offline { background:#dc3545; }
    .pending-pill { background:#ffd966; color:#4a2900; padding:7px 16px; border-radius:8px; font-weight:700; font-size:15px;}
    .approved-pill { background:#31ffa7; color:#167054; padding:7px 16px; border-radius:8px; font-weight:700; font-size:15px;}
    .rejected-pill { background:#f8d7da; color:#721c24; padding:7px 16px; border-radius:8px; font-weight:700; font-size:15px;}
    .small-muted { color:#6c757d; font-size:14px; }
    .components-list { margin-top:11px; list-style:none; padding-left:0; }
    .components-list li { padding:7px 0; border-bottom:1px dashed #f0f3fa; }
    .comp-ok { color:#25ad45; font-weight:700;}
    .comp-warn { color:#e67700; font-weight:700;}
    .comp-bad { color:#c82333; font-weight:700;}
    .comp-unknown { color:#6c757d; font-weight:700;}
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:11px; border-bottom:1px solid #f2f5fc; text-align:left; font-size:15px;}
    .view-btn { background:#2670ff; color:#fff; padding:7px 15px; border-radius:8px; border:none; cursor:pointer; font-size:15px; }
    .admin-panel, .analytics-card, .fleet-card { margin-top:12px;}
    .btn { padding:8px 15px; border-radius:7px; border:none; cursor:pointer; font-size:15px;}
    .btn-primary { background:#2670ff; color:#fff; font-weight:700;}
    .btn-warning { background:#ffd966; color:#4a2900; font-weight:700;}
    .btn-danger { background:#dc3545; color:#fff; font-weight:700;}
    .btn-ghost { background:transparent; border:1px solid #ddd; font-weight:700;}
    #modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:10000; }
    #modal .dialog { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:520px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:10px 0 12px 0;}
    .toolbar label { font-size:14px; color:#333; }
    .toolbar input[type="date"], .toolbar select { padding:6px 8px; border:1px solid #e5e9f2; border-radius:8px; font-size:14px;}
    .toolbar .inline { display:flex; gap:8px; align-items:center; }
    .kpi { display:flex; gap:14px; flex-wrap:wrap; margin-top:6px; }
    .kpi .pill { background:#f4f7ff; border:1px solid #e7ecff; padding:8px 12px; border-radius:10px; font-weight:700; color:#2b3a67; }
    .hint { font-size:12px; color:#6c757d; }
    .analytics-card canvas { max-width: 100%; height: 300px; margin-top: 10px; }
    .fleet-card ul { list-style: none; padding: 0; }
    .fleet-card ul li { padding: 8px 0; border-bottom: 1px solid #f2f5fc; }
    @media (max-width:600px) {
      .dashboard {padding:0 7px;}
      header {flex-direction:column;align-items:flex-start;padding:16px 5px;}
      .header-left{gap:10px;}
      .app-title{font-size:18px;}
      .plan-pill{font-size:13px;}
      .header-logout{font-size:13px;padding:7px 13px;}
      .card{padding:13px;}
      th,td{font-size:14px;}
      .pending-pill,.approved-pill,.rejected-pill{font-size:13px;}
      .toolbar {gap:6px;}
      .analytics-card canvas { height: 200px; }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div class="header-left">
        <img src="assets/logo.png" alt="Logo" class="logo"/>
        <div>
          <div class="app-title">Smart Tracker <span style="font-size:15px;font-weight:normal;background:rgba(38,112,255,.1);border-radius:7px;padding:2px 11px;color:#2670ff;margin-left:7px;" id="planPillHeader"></span></div>
        </div>
      </div>
      <div class="header-right">
        <span class="header-email" id="userEmail">Loading...</span>
        <span class="plan-pill" id="planPill">‚Äî</span>
        <button id="logoutBtn" class="header-logout">Logout</button>
      </div>
    </header>

    <div id="adArea" class="ad-banner">Ad placeholder</div>

    <section class="card status-card">
      <h2>üîç Live Status</h2>
      <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:2px;">
        <div><strong>Online:</strong> <span id="onlineStatus"><span class='badge offline'>Checking...</span></span></div>
        <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
      </div>
      <p><strong>Location:</strong> <span id="location">Loading...</span></p>
      <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
      <p><strong>Alarm Last Trigger:</strong> <span id="alarmTrigger">No triggers</span></p>
      <div id="componentsBlock">
        <h4 style="font-size:16px;border-bottom:1px solid #f3f6ff;">Components</h4>
        <ul id="componentsList" class="components-list">
          <li class="comp-unknown">No data</li>
        </ul>
      </div>
    </section>

    <section class="card alarm-card">
      <h2>üîî Alarm</h2>
      <label class="switch">
        <input type="checkbox" id="alarmToggle">
        <span class="slider round"></span>
      </label>
      <span id="alarmStatusText" style="margin-left:14px;">Loading alarm status...</span>
    </section>

    <section class="card subscription-card">
      <h2>üí≥ Subscription & Upgrades</h2>
      <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
        <div>Plan: <strong id="currentPlan">Loading</strong></div>
        <div class="small-muted">Expiry: <span id="planExpiry">-</span></div>
        <div class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></div>
        <div id="upgradeBtns" style="margin-left:auto;">
          <button id="upgradeToSilver" class="btn btn-warning">Request Silver (‚Çπ149/mo)</button>
          <button id="upgradeToGold" class="btn btn-primary">Request Gold (‚Çπ249/mo)</button>
        </div>
      </div>
      <div style="margin-top:10px;">
        <span id="requestStatusArea"></span>
      </div>
      <div style="margin-top:14px;" class="small-muted">
        Plans: Basic (24h history, ads) ‚Ä¢ Silver (7d history, limited ads, CSV export) ‚Ä¢ Gold (90d, no ads, CSV, analytics, fleet)
      </div>
    </section>

    <section class="card map-card">
      <h2>üó∫ Live Map</h2>
      <div class="toolbar" id="mapToolbar" style="display:flex;">
        <div class="inline" id="mapTypeBlock" style="display:none;">
          <label>Map:</label>
          <select id="mapType">
            <option value="street">Street</option>
            <option value="satellite">Satellite</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="inline" id="heatToggleBlock" style="display:none;">
          <label>Heatmap:</label>
          <label class="switch"><input type="checkbox" id="heatToggle"><span class="slider"></span></label>
        </div>
        <div class="inline" id="customIconBlock" style="display:none;">
          <label>Marker Icon:</label>
          <input type="file" id="iconUploader" accept="image/*"/>
          <span class="hint">PNG/JPG, ~32√ó32 works best</span>
        </div>
        <div class="inline" id="geofenceControls" style="display:none;">
          <button class="btn btn-ghost" id="gfEnableDraw">Add Zone</button>
          <button class="btn btn-ghost" id="gfSave">Save Zones</button>
          <button class="btn btn-ghost" id="gfClear">Clear Zones</button>
          <span class="hint" id="gfHint"></span>
        </div>
      </div>
      <div id="map" style="height:300px;border-radius:8px;">Loading map...</div>
      <div class="kpi">
        <div class="pill">Distance: <span id="kpiDistance">0.00 km</span></div>
        <div class="pill">Stops: <span id="kpiStops">0</span></div>
        <div class="pill">Refresh: <span id="kpiRefresh">‚Äî</span></div>
      </div>
    </section>

    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div class="toolbar" id="dateFilterSection" style="display:none;">
        <div class="inline">
          <label>From:</label><input type="date" id="startDate"/>
        </div>
        <div class="inline">
          <label>To:</label><input type="date" id="endDate"/>
        </div>
        <button class="btn btn-primary" id="applyFilterBtn">Filter</button>
        <button class="btn btn-ghost" id="clearFilterBtn">Clear</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="small-muted">Recent movements</div>
        <div>
          <button id="exportCSVBtn" class="btn btn-primary" style="display:none;">Export CSV</button>
          <button id="buyExportBtn" class="btn btn-warning" style="display:none;">Buy Export ($2)</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>

    <section class="card analytics-card" id="analyticsSection" style="display:none;">
      <h2>üìä Analytics Dashboard</h2>
      <div id="analyticsMessage" class="small-muted">Loading analytics...</div>
      <button id="buyAnalyticsBtn" class="btn btn-warning" style="display:none;">Buy Analytics ($5)</button>
      <canvas id="analyticsChart"></canvas>
    </section>

    <section class="card fleet-card" id="fleetSection" style="display:none;">
      <h2>üöó Fleet Management</h2>
      <div id="fleetMessage" class="small-muted">Loading fleet...</div>
      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <button id="addVehicleBtn" class="btn btn-primary" style="display:none;">Add Vehicle</button>
        <button id="buyFleetBtn" class="btn btn-warning" style="display:none;">Buy Fleet Access ($30)</button>
      </div>
      <ul id="fleetList"></ul>
    </section>

    <section id="adminPanel" class="card admin-panel" style="display:none;">
      <h2>üîß Admin Panel ‚Äî Upgrade Requests</h2>
      <div id="adminList">Loading admin data‚Ä¶</div>
      <hr/>
      <h3>Recent admin logs</h3>
      <div id="adminLogs">Loading logs‚Ä¶</div>
    </section>
  </div>

  <div id="modal">
    <div class="dialog">
      <div id="modalContent"></div>
      <div style="margin-top:12px;text-align:right;">
        <button id="modalClose" class="btn btn-ghost">Close</button>
        <button id="modalUpgradeBtn" class="btn btn-primary" style="display:none;">Request Upgrade</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const userEmailEl = document.getElementById('userEmail');
    const planPill = document.getElementById('planPill');
    const planPillHeader = document.getElementById('planPillHeader');
    const adArea = document.getElementById('adArea');
    const locationEl = document.getElementById("location");
    const lastActiveEl = document.getElementById("lastActive");
    const statusEl = document.getElementById("status");
    const batteryHealthEl = document.getElementById("batteryHealth");
    const historyTbody = document.getElementById("history");
    const exportCSVBtn = document.getElementById("exportCSVBtn");
    const buyExportBtn = document.getElementById("buyExportBtn");
    const alarmToggle = document.getElementById("alarmToggle");
    const alarmStatusText = document.getElementById("alarmStatusText");
    const alarmTriggerEl = document.getElementById("alarmTrigger");
    const onlineStatusEl = document.getElementById("onlineStatus");
    const lastSeenEl = document.getElementById("lastSeen");
    const componentsListEl = document.getElementById("componentsList");
    const currentPlanEl = document.getElementById('currentPlan');
    const planExpiryEl = document.getElementById('planExpiry');
    const vehicleLimitEl = document.getElementById('vehicleLimit');
    const upgradeBtns = document.getElementById('upgradeBtns');
    const upgradeToSilverBtn = document.getElementById('upgradeToSilver');
    const upgradeToGoldBtn = document.getElementById('upgradeToGold');
    const requestStatusArea = document.getElementById('requestStatusArea');
    const adminPanel = document.getElementById('adminPanel');
    const adminList = document.getElementById('adminList');
    const adminLogs = document.getElementById('adminLogs');
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    const modalUpgradeBtn = document.getElementById('modalUpgradeBtn');
    const analyticsSection = document.getElementById('analyticsSection');
    const analyticsMessage = document.getElementById('analyticsMessage');
    const buyAnalyticsBtn = document.getElementById('buyAnalyticsBtn');
    const fleetSection = document.getElementById('fleetSection');
    const fleetMessage = document.getElementById('fleetMessage');
    const addVehicleBtn = document.getElementById('addVehicleBtn');
    const buyFleetBtn = document.getElementById('buyFleetBtn');
    const fleetList = document.getElementById('fleetList');

    document.getElementById('logoutBtn').onclick = () => auth.signOut();

    const dateFilterSection = document.getElementById('dateFilterSection');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    const clearFilterBtn = document.getElementById('clearFilterBtn');
    const mapTypeBlock = document.getElementById('mapTypeBlock');
    const mapTypeSelect = document.getElementById('mapType');
    const heatToggleBlock = document.getElementById('heatToggleBlock');
    const heatToggle = document.getElementById('heatToggle');
    const customIconBlock = document.getElementById('customIconBlock');
    const iconUploader = document.getElementById('iconUploader');
    const geofenceControls = document.getElementById('geofenceControls');
    const gfEnableDrawBtn = document.getElementById('gfEnableDraw');
    const gfSaveBtn = document.getElementById('gfSave');
    const gfClearBtn = document.getElementById('gfClear');
    const gfHint = document.getElementById('gfHint');
    const kpiDistanceEl = document.getElementById('kpiDistance');
    const kpiStopsEl = document.getElementById('kpiStops');
    const kpiRefreshEl = document.getElementById('kpiRefresh');

    let uidGlobal = null;
    let isAdmin = false;
    let localPlan = { plan: 'basic', plan_expiry: null, vehicle_limit: 1, exportCSV: false, analytics: false, fleet: false };
    let chartInstance = null;

    const PLAN_POLICIES = {
      basic: { historyDays: 1, ads: 'banner+interstitial', vehicle_limit: 1, exportCSV: false, refreshMs: 30000, heatmap: false, mapSwitch: false, notify: false, geofences: 0, analytics: false, fleet: false },
      silver: { historyDays: 7, ads: 'banner-limited', vehicle_limit: 3, exportCSV: true, refreshMs: 20000, heatmap: false, mapSwitch: true, notify: true, geofences: 1, analytics: false, fleet: false },
      gold: { historyDays: 90, ads: 'no-ads', vehicle_limit: 3, exportCSV: true, refreshMs: 10000, heatmap: true, mapSwitch: true, notify: true, geofences: 999, analytics: true, fleet: true }
    };

    let adTimerInt = null, currentAdIndex = 0, adsList = [];
    function showAd(ad) {
      adArea.innerHTML = 'Loading...';
      if (ad.type === 'banner') {
        const img = new Image();
        img.src = ad.url;
        img.onload = () => { adArea.innerHTML = ''; adArea.appendChild(img); };
      } else if (ad.type === 'video') {
        const v = document.createElement('video');
        v.src = ad.url;
        v.controls = true;
        v.autoplay = true;
        v.muted = true;
        adArea.innerHTML = '';
        adArea.appendChild(v);
      }
    }

    function loadAdsForPlan(plan) {
      if (adTimerInt) clearInterval(adTimerInt);
      const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
      if (policy.ads === 'no-ads') { adArea.style.display = 'none'; adArea.innerHTML = ''; return; }
      adArea.style.display = 'flex';
      db.ref('admin/ads').once('value').then(snapshot => {
        const adsObj = snapshot.val() || {};
        adsList = Object.values(adsObj).filter(ad =>
          ad && ad.active && ad.url &&
          (ad.placement === 'dashboard_top' || ad.placement === 'dashboard_footer')
        );
        if (policy.ads === 'banner-limited' && adsList.length > 1) { adsList = adsList.slice(0, 1); }
        if (adsList.length) {
          showAd(adsList[currentAdIndex = 0]);
          adTimerInt = setInterval(() => {
            currentAdIndex = (currentAdIndex + 1) % adsList.length;
            showAd(adsList[currentAdIndex]);
          }, 15000);
        } else {
          adArea.innerHTML = 'No active ad';
        }
      }).catch(() => { adArea.innerHTML = 'Ad load error'; });
    }

    function renderAdsForPlan(plan) { loadAdsForPlan(plan); }

    function isPurchaseValid(purchase) {
      if (!purchase || !purchase.expiry) return false;
      const expiryMs = Date.parse(purchase.expiry);
      return !isNaN(expiryMs) && Date.now() < expiryMs;
    }

    async function buyFeature(feature, amount) {
      if (!uidGlobal) return alert('Not logged in');
      try {
        // Simulate payment (replace with Razorpay or similar)
        const paymentSuccess = confirm(`Simulate payment of $${amount} for ${feature}?`); // Replace with actual payment gateway
        if (!paymentSuccess) throw new Error('Payment cancelled');
        const expiry = new Date(Date.now() + (feature === 'export' ? 24 * 60 * 60 * 1000 : 30 * 24 * 60 * 60 * 1000)).toISOString();
        await db.ref(`users/${uidGlobal}/purchases/${feature}`).set({ feature, amount, expiry, purchase_time: new Date().toISOString() });
        alert(`Purchased ${feature} access until ${prettyTS(expiry)}`);
        // Re-fetch user data to update UI
        const snap = await db.ref(`users/${uidGlobal}`).once('value');
        applyPlanToUI(snap.val() || {});
      } catch (error) {
        console.error(`Failed to purchase ${feature}:`, error);
        alert(`Failed to purchase ${feature}. Please try again.`);
      }
    }

    function renderRequestUI(upgradeRequest, currentPlan) {
      upgradeToSilverBtn.style.display = 'none';
      upgradeToGoldBtn.style.display = 'none';
      let statusMsg = '';
      if (currentPlan === 'gold') {
        upgradeBtns.style.display = 'none';
        statusMsg = `<span class="approved-pill">You are on GOLD, the highest plan.</span>`;
      } else if (!upgradeRequest || !upgradeRequest.status) {
        upgradeBtns.style.display = 'block';
        upgradeToSilverBtn.style.display = 'inline-block';
        upgradeToGoldBtn.style.display = 'inline-block';
        statusMsg = '';
      } else if (upgradeRequest.status === 'pending') {
        upgradeBtns.style.display = 'none';
        statusMsg = `<span class="pending-pill">Upgrade to ${upgradeRequest.requestedPlan?.toUpperCase() || ''} ‚Äî PENDING APPROVAL</span>`;
      } else if (upgradeRequest.status === 'approved') {
        upgradeBtns.style.display = 'none';
        statusMsg = `<span class="approved-pill">Upgrade approved ‚Äî Enjoy your ${upgradeRequest.requestedPlan?.toUpperCase() || ''} plan</span>`;
      } else if (upgradeRequest.status === 'rejected') {
        upgradeBtns.style.display = 'block';
        upgradeToSilverBtn.style.display = 'inline-block';
        upgradeToGoldBtn.style.display = 'inline-block';
        statusMsg = `<span class="rejected-pill">Upgrade request rejected ‚Äî you may try again</span>`;
      } else if (upgradeRequest.status === 'cancelled') {
        upgradeBtns.style.display = 'block';
        upgradeToSilverBtn.style.display = 'inline-block';
        upgradeToGoldBtn.style.display = 'inline-block';
        statusMsg = `<span class="small-muted">Upgrade request cancelled</span>`;
      }
      requestStatusArea.innerHTML = statusMsg;
    }

    function prettyTS(iso) {
      if (!iso) return '-';
      try {
        return new Date(iso).toLocaleString();
      } catch (e) {
        return iso;
      }
    }

    function applyPlanToUI(udata) {
      console.log('Applying plan to UI:', udata);
      const plan = udata.plan || 'basic';
      const plan_expiry = udata.plan_expiry || null;
      const vehicle_limit = (udata.vehicle_limit || PLAN_POLICIES[plan].vehicle_limit);
      const exportCSV = (typeof udata.exportCSV === 'boolean') ? udata.exportCSV : !!PLAN_POLICIES[plan].exportCSV;
      const analytics = PLAN_POLICIES[plan].analytics || (udata.purchases?.analytics && isPurchaseValid(udata.purchases.analytics));
      const fleet = PLAN_POLICIES[plan].fleet || (udata.purchases?.fleet && isPurchaseValid(udata.purchases.fleet));
      localPlan = { plan, plan_expiry, vehicle_limit, exportCSV, analytics, fleet };
      console.log('Local plan:', localPlan);

      planPill.textContent = plan.toUpperCase();
      currentPlanEl.textContent = plan.toUpperCase();
      planPillHeader.textContent = plan.toUpperCase();
      planExpiryEl.textContent = prettyTS(plan_expiry);
      vehicleLimitEl.textContent = vehicle_limit;
      exportCSVBtn.style.display = exportCSV || (udata.purchases?.export && isPurchaseValid(udata.purchases.export)) ? 'inline-block' : 'none';
      buyExportBtn.style.display = (!exportCSV && !(udata.purchases?.export && isPurchaseValid(udata.purchases.export))) ? 'inline-block' : 'none';
      renderAdsForPlan(plan);

      const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
      dateFilterSection.style.display = ['silver', 'gold'].includes(plan) ? 'flex' : 'none';
      mapTypeBlock.style.display = policy.mapSwitch ? 'flex' : 'none';
      heatToggleBlock.style.display = (plan === 'gold') ? 'flex' : 'none';
      customIconBlock.style.display = plan !== 'basic' ? 'flex' : 'none';
      geofenceControls.style.display = policy.geofences > 0 ? 'flex' : 'none';
      gfHint.textContent = plan === 'silver' ? 'Max 1 zone' : (plan === 'gold' ? 'Multiple zones allowed' : '');

      analyticsSection.style.display = analytics ? 'block' : 'none';
      buyAnalyticsBtn.style.display = (!analytics && plan !== 'gold') ? 'inline-block' : 'none';
      analyticsMessage.textContent = analytics ? 'Speed trend analytics' : 'Analytics loading failed';
      if (analytics && fullHistory) renderAnalyticsChart(fullHistory);

      fleetSection.style.display = fleet ? 'block' : 'none';
      addVehicleBtn.style.display = fleet ? 'inline-block' : 'none';
      buyFleetBtn.style.display = (!fleet && plan !== 'gold') ? 'inline-block' : 'none';
      fleetMessage.textContent = fleet ? 'Manage your vehicles' : 'Fleet loading failed';

      kpiRefreshEl.textContent = (policy.refreshMs / 1000) + 's';
      setRefreshIntervals(policy.refreshMs);

      if (policy.notify && 'Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().catch(() => {});
      }

      renderRequestUI(udata.upgrade_request || null, plan);
    }

    function createUpgradeRequest(uid, desiredPlan) {
      const now = new Date().toISOString();
      const req = { status: 'pending', requestedPlan: desiredPlan, request_time: now };
      const updates = {};
      updates[`users/${uid}/upgrade_request`] = req;
      const adminKey = `req_${uid}_${Date.now()}`;
      updates[`admin/upgrade_requests/${adminKey}`] = { uid, requestedPlan: desiredPlan, status: 'pending', request_time: now };
      return db.ref().update(updates);
    }

    async function adminApproveRequest(adminUid, adminName, adminReqKey, adminReqObj) {
      const targetUid = adminReqObj.uid;
      const plan = adminReqObj.requestedPlan || 'silver';
      const now = new Date();
      const expiry = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
      const updates = {};
      updates[`users/${targetUid}/plan`] = plan;
      updates[`users/${targetUid}/plan_expiry`] = expiry.toISOString();
      updates[`users/${targetUid}/vehicle_limit`] = PLAN_POLICIES[plan].vehicle_limit;
      updates[`users/${targetUid}/exportCSV`] = true;
      updates[`users/${targetUid}/upgrade_request/status`] = 'approved';
      updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'approved';
      updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, plan, approvedAt: new Date().toISOString(), adminNameDisplay: adminName || adminUid };
      await db.ref().update(updates);
      alert('User upgraded to ' + plan.toUpperCase());
    }

    async function adminRejectRequest(adminUid, adminName, adminReqKey, adminReqObj) {
      const targetUid = adminReqObj.uid;
      const updates = {};
      updates[`users/${targetUid}/upgrade_request/status`] = 'rejected';
      updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'rejected';
      updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, status: 'rejected', processedAt: new Date().toISOString() };
      await db.ref().update(updates);
      alert('Request rejected.');
    }

    function checkAndAutoDowngrade(uid, udata) {
      if (!udata || !udata.plan || !udata.plan_expiry) return;
      const expiryMs = Date.parse(udata.plan_expiry);
      if (isNaN(expiryMs)) return;
      if (Date.now() >= expiryMs && udata.plan !== 'basic') {
        const updates = {
          [`users/${uid}/plan`]: 'basic',
          [`users/${uid}/plan_expiry`]: null,
          [`users/${uid}/vehicle_limit`]: PLAN_POLICIES.basic.vehicle_limit,
          [`users/${uid}/exportCSV`]: false,
          [`users/${uid}/upgrade_request/status`]: 'cancelled'
        };
        db.ref().update(updates).then(() => {
          const k = `downgrade_${uid}_${Date.now()}`;
          db.ref(`admin/downgrades/${k}`).set({ uid, old_plan: udata.plan, new_plan: 'basic', time: new Date().toISOString(), reason: 'expired_auto_downgrade' });
        });
      }
    }

    let map, liveMarker, baseLayer, baseLayers = {};
    let routeLayer = null, startMarker = null, endMarker = null, heatLayer = null;
    let customMarkerIcon = null;

    function createBaseLayers() {
      baseLayers.street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 });
      baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20 });
      baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 });
    }

    function updateBaseLayer(type) {
      if (!map) return;
      if (baseLayer) map.removeLayer(baseLayer);
      baseLayer = baseLayers[type] || baseLayers.street;
      baseLayer.addTo(map);
    }

    function updateMap(lat, lng, popupText = null) {
      if (!(typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng))) return;
      if (!map) {
        map = L.map('map').setView([lat, lng], 14);
        createBaseLayers();
        updateBaseLayer('street');
        liveMarker = L.marker([lat, lng], customMarkerIcon ? { icon: customMarkerIcon } : undefined).addTo(map);
        setupDrawTools();
      } else {
        if (!liveMarker) liveMarker = L.marker([lat, lng], customMarkerIcon ? { icon: customMarkerIcon } : undefined).addTo(map);
        liveMarker.setLatLng([lat, lng]);
      }
      if (popupText) liveMarker.bindPopup(popupText).openPopup();
    }

    window.focusOnMap = function(lat, lng) {
      lat = parseFloat(lat);
      lng = parseFloat(lng);
      if (!isNaN(lat) && !isNaN(lng)) {
        updateMap(lat, lng, `üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        map.setView([lat, lng], 15);
      }
    };

    let fullHistory = null;
    let filteredHistory = null;

    function parseEntry(entry) {
      const loc = entry.location || '';
      const [lat, lng] = (loc.split(',') || []).map(s => parseFloat(s.trim()));
      const tms = Date.parse(entry.time || '');
      return { lat, lng, time: entry.time || '', ts: isNaN(tms) ? null : tms, speed: typeof entry.speed === 'number' ? entry.speed : null };
    }

    function renderHistoryTable(list) {
      historyTbody.innerHTML = '';
      if (!list || !list.length) {
        historyTbody.innerHTML = '<tr><td colspan="3">No history found.</td></tr>';
        return;
      }
      list.forEach(entry => {
        const canFocus = !(isNaN(entry.lat) || isNaN(entry.lng));
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${entry.time || ''}</td><td>${(isFinite(entry.lat) && isFinite(entry.lng)) ? (entry.lat + ',' + entry.lng) : ''}</td>
          <td><button class="view-btn"${canFocus ? ` onclick="focusOnMap(${entry.lat},${entry.lng})"` : ' disabled style="opacity:.65;"'}>View</button></td>`;
        historyTbody.appendChild(tr);
      });
    }

    function haversineKm(a, b) {
      const R = 6371;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLng / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(s));
    }

    function computeKPIs(list) {
      if (!list || list.length < 2) {
        kpiDistanceEl.textContent = '0.00 km';
        kpiStopsEl.textContent = '0';
        return;
      }
      let dist = 0;
      for (let i = 1; i < list.length; i++) {
        const p = list[i - 1], q = list[i];
        if (isFinite(p.lat) && isFinite(p.lng) && isFinite(q.lat) && isFinite(q.lng)) {
          dist += haversineKm(p, q);
        }
      }
      let stops = 0;
      const SPEED_KMH_THRESHOLD = 2;
      const STOP_MS = 5 * 60 * 1000;
      let blockStart = null, lastPoint = null;
      for (let i = 0; i < list.length; i++) {
        const p = list[i];
        const slowOrStatic = (p.speed !== null && p.speed <= SPEED_KMH_THRESHOLD) ||
                             (lastPoint && p.ts && lastPoint.ts && haversineKm(p, lastPoint) < 0.015);
        if (slowOrStatic) {
          if (!blockStart) blockStart = p;
        } else {
          if (blockStart && p.ts && blockStart.ts && (p.ts - blockStart.ts >= STOP_MS)) stops++;
          blockStart = null;
        }
        lastPoint = p;
      }
      if (blockStart && lastPoint && blockStart.ts && lastPoint.ts && (lastPoint.ts - blockStart.ts >= STOP_MS)) stops++;
      kpiDistanceEl.textContent = dist.toFixed(2) + ' km';
      kpiStopsEl.textContent = String(stops);
    }

    function clearRouteLayers() {
      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
      if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
      if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
    }

    function plotRoute(list) {
      if (!map || !list || !list.length) return;
      clearRouteLayers();
      const coords = list.filter(p => isFinite(p.lat) && isFinite(p.lng)).map(p => [p.lat, p.lng]);
      if (!coords.length) return;
      routeLayer = L.polyline(coords, { weight: 4 }).addTo(map);
      const startIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png', iconSize: [25, 41], iconAnchor: [12, 41] });
      const endIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-2x.png', iconSize: [25, 41], iconAnchor: [12, 41] });
      startMarker = L.marker(coords[0], { icon: startIcon }).addTo(map).bindPopup('Start');
      endMarker = L.marker(coords[coords.length - 1], { icon: endIcon }).addTo(map).bindPopup('End');
      map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
    }

    function updateHeatmap(list) {
      if (!map) return;
      if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
      if (!list || !list.length || !heatToggle.checked) return;
      const heatData = list.filter(p => isFinite(p.lat) && isFinite(p.lng)).map(p => [p.lat, p.lng, 0.5]);
      if (heatData.length) heatLayer = L.heatLayer(heatData, { radius: 25 }).addTo(map);
    }

    function applyDateFilter(list) {
      const plan = localPlan.plan;
      const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
      const cutoffMs = Date.now() - policy.historyDays * 86400000;
      const hasDate = startDateInput.value || endDateInput.value;
      let s = startDateInput.value ? Date.parse(startDateInput.value + 'T00:00:00') : null;
      let e = endDateInput.value ? Date.parse(endDateInput.value + 'T23:59:59') : null;
      return (list || []).filter(p => {
        if (!p.ts) return false;
        if (p.ts < cutoffMs) return false;
        if (!hasDate) return true;
        if (s && p.ts < s) return false;
        if (e && p.ts > e) return false;
        return true;
      });
    }

    function renderAnalyticsChart(history) {
      console.log('Rendering analytics chart with history:', history);
      if (!history || !history.length) {
        analyticsMessage.textContent = 'No data available for analytics';
        return;
      }
      const ctx = document.getElementById('analyticsChart').getContext('2d');
      const data = history.filter(h => h.speed !== null && h.time).map(h => ({
        x: new Date(h.time).toLocaleTimeString(),
        y: h.speed
      }));
      if (data.length === 0) {
        analyticsMessage.textContent = 'No speed data available';
        return;
      }
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Speed (km/h)',
            data: data,
            borderColor: '#2670ff',
            backgroundColor: 'rgba(38, 112, 255, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Time' } },
            y: { title: { display: true, text: 'Speed (km/h)' }, beginAtZero: true }
          }
        }
      });
      analyticsMessage.textContent = 'Speed trend analytics';
    }

    async function renderFleetList() {
      if (!uidGlobal) return;
      fleetMessage.textContent = 'Loading fleet...';
      try {
        const snap = await db.ref(`users/${uidGlobal}/vehicles`).once('value');
        const vehicles = snap.val() || {};
        fleetList.innerHTML = '';
        const vehicleArray = Object.entries(vehicles).map(([id, v]) => ({ id, ...v }));
        if (vehicleArray.length === 0) {
          fleetList.innerHTML = '<li>No vehicles added</li>';
          fleetMessage.textContent = 'Manage your vehicles';
          return;
        }
        vehicleArray.forEach(v => {
          const li = document.createElement('li');
          li.textContent = `${v.name || 'Vehicle ' + v.id} (ID: ${v.id})`;
          fleetList.appendChild(li);
        });
        fleetMessage.textContent = `Managing ${vehicleArray.length} vehicle(s)`;
      } catch (error) {
        console.error('Failed to load fleet:', error);
        fleetMessage.textContent = 'Failed to load fleet';
      }
    }

    async function addVehicle() {
      if (!uidGlobal) return alert('Not logged in');
      const snap = await db.ref(`users/${uidGlobal}/vehicles`).once('value');
      const vehicles = snap.val() || {};
      const vehicleCount = Object.keys(vehicles).length;
      if (vehicleCount >= localPlan.vehicle_limit) {
        showModal(`Vehicle limit (${localPlan.vehicle_limit}) reached. Upgrade or purchase fleet access.`, true);
        return;
      }
      const name = prompt('Enter vehicle name:');
      if (!name) return;
      const id = `veh_${Date.now()}`;
      await db.ref(`users/${uidGlobal}/vehicles/${id}`).set({ name, added: new Date().toISOString() });
      renderFleetList();
    }

    const ONLINE_TTL_MS = 90000;
    function parseTimestampToMs(ts) {
      if (!ts) return null;
      const parts = ts.split(' ');
      if (parts.length < 2) return null;
      const [y, m, d] = parts[0].split('-').map(n => parseInt(n));
      const [hh, mm, ss] = parts[1].split(':').map(n => parseInt(n));
      return new Date(y, m - 1, d, hh, mm, ss).getTime();
    }

    function computeOnlineDisplay(flag, lastActiveStr) {
      const lastActiveMs = parseTimestampToMs(lastActiveStr);
      if (!lastActiveMs) return !!flag;
      return (Date.now() - lastActiveMs <= ONLINE_TTL_MS) && !!flag;
    }

    function renderOnlineAndLastActive(flag, lastActiveStr) {
      const isOn = computeOnlineDisplay(flag, lastActiveStr);
      onlineStatusEl.innerHTML = isOn ? '<span class="badge online">ONLINE</span>' : '<span class="badge offline">OFFLINE</span>';
      lastActiveEl.textContent = lastActiveStr || "Unknown";
      maybeNotifyStatus(isOn);
    }

    let lastActivePoller = null;
    function setRefreshIntervals(ms) {
      if (lastActivePoller) clearInterval(lastActivePoller);
      lastActivePoller = setInterval(() => {
        if (!uidGlobal) return;
        const ref = db.ref(`users/${uidGlobal}/vehicle`);
        ref.child("current/last_active").once('value').then(lastSnap => {
          const lastActive = lastSnap.val();
          ref.child("online").once('value').then(flagSnap => renderOnlineAndLastActive(flagSnap.val(), lastActive));
        });
      }, ms);
    }

    let lastOnlineState = null;
    function maybeNotifyStatus(isOnline) {
      const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
      if (!policy.notify || !('Notification' in window) || Notification.permission !== 'granted') return;
      if (lastOnlineState === null) { lastOnlineState = isOnline; return; }
      if (isOnline !== lastOnlineState) {
        new Notification("Vehicle Status", { body: isOnline ? "Vehicle is ONLINE" : "Vehicle is OFFLINE" });
        lastOnlineState = isOnline;
      }
    }

    function maybeNotifyBattery(battPercent) {
      const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
      if (!policy.notify || !('Notification' in window) || Notification.permission !== 'granted') return;
      if (typeof battPercent === 'number' && battPercent <= 20) {
        new Notification("Low Battery", { body: `Vehicle battery low (${battPercent}%)` });
      }
    }

    let drawControl, drawnItems;
    let geofenceState = { lastInsideAny: null };

    function setupDrawTools() {
      if (!map) return;
      if (drawnItems) return;
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      drawControl = new L.Control.Draw({
        position: 'topright',
        draw: {
          rectangle: true,
          polygon: true,
          circle: true,
          circlemarker: false,
          marker: false,
          polyline: false
        },
        edit: { featureGroup: drawnItems }
      });
    }

    function enableDrawing() {
      if (!map || !drawControl) return;
      map.addControl(drawControl);
    }

    function disableDrawing() {
      if (!map || !drawControl) return;
      map.removeControl(drawControl);
    }

    function geofenceToJSON(layer) {
      if (layer instanceof L.Circle) {
        const c = layer.getLatLng();
        return { type: 'circle', center: [c.lat, c.lng], radius: layer.getRadius() };
      } else if (layer instanceof L.Polygon) {
        const latlngs = layer.getLatLngs()[0].map(p => [p.lat, p.lng]);
        return { type: 'polygon', points: latlngs };
      } else if (layer instanceof L.Rectangle) {
        const latlngs = layer.getLatLngs()[0].map(p => [p.lat, p.lng]);
        return { type: 'polygon', points: latlngs };
      }
      return null;
    }

    function layerFromJSON(obj) {
      if (!obj) return null;
      if (obj.type === 'circle') {
        return L.circle(obj.center, { radius: obj.radius });
      }
      if (obj.type === 'polygon' && Array.isArray(obj.points)) {
        return L.polygon(obj.points);
      }
      return null;
    }

    async function saveGeofences() {
      if (!uidGlobal) return;
      const plan = localPlan.plan;
      const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
      const layers = [];
      drawnItems.eachLayer(l => {
        const j = geofenceToJSON(l);
        if (j) layers.push(j);
      });
      if (plan === 'silver' && layers.length > policy.geofences) {
        alert('Silver plan allows only 1 geofence');
        return;
      }
      await db.ref(`users/${uidGlobal}/geofences`).set(layers);
      alert('Geofences saved');
    }

    async function loadGeofences() {
      if (!uidGlobal || !map) return;
      const snap = await db.ref(`users/${uidGlobal}/geofences`).once('value');
      const arr = snap.val() || [];
      drawnItems.clearLayers();
      arr.forEach(obj => {
        const layer = layerFromJSON(obj);
        if (layer) { drawnItems.addLayer(layer); }
      });
    }

    function pointInsideGeofences(lat, lng) {
      if (!drawnItems) return false;
      let inside = false;
      drawnItems.eachLayer(layer => {
        if (inside) return;
        if (layer instanceof L.Circle) {
          const c = layer.getLatLng();
          inside = map.distance([lat, lng], c) <= layer.getRadius();
        } else if (layer instanceof L.Polygon) {
          inside = leafletPipPointInLayer([lat, lng], layer);
        }
      });
      return inside;
    }

    function leafletPipPointInLayer(point, polygonLayer) {
      const x = point[1], y = point[0];
      const poly = polygonLayer.getLatLngs()[0].map(p => [p.lng, p.lat]);
      let inside = false;
      for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        const xi = poly[i][0], yi = poly[i][1];
        const xj = poly[j][0], yj = poly[j][1];
        const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function exportHistoryCSV(histArray) {
      if (!localPlan.exportCSV && !(udata && udata.purchases?.export && isPurchaseValid(udata.purchases.export))) {
        showModal('CSV export is not available on your current plan. Purchase access or upgrade to Silver/Gold.', true);
        return;
      }
      if (!histArray || !Array.isArray(histArray) || histArray.length === 0) {
        alert('No history data available to export.');
        return;
      }
      try {
        const rows = [['time', 'location', 'speed']];
        histArray.forEach(entry => {
          const location = (isFinite(entry.lat) && isFinite(entry.lng)) ? `${entry.lat},${entry.lng}` : '';
          rows.push([entry.time || '', location, entry.speed !== null ? String(entry.speed) : '']);
        });
        const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `history_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '')}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('CSV export failed:', error);
        alert('Failed to export history. Please try again.');
      }
    }

    function renderComponents(obj) {
      componentsListEl.innerHTML = "";
      if (!obj || !Object.keys(obj).length) {
        componentsListEl.innerHTML = '<li class="comp-unknown">No components</li>';
        return;
      }
      for (let k in obj) {
        const v = obj[k];
        let cls = "comp-unknown";
        if (v === "ok" || v === "activity") cls = "comp-ok";
        else if (v === "no_fix" || v === "idle") cls = "comp-warn";
        else if (v === "down") cls = "comp-bad";
        componentsListEl.innerHTML += `<li class="${cls}"><strong>${k}:</strong> ${v}</li>`;
      }
    }

    function showModal(html, showUpgrade = false) {
      modalContent.innerHTML = html;
      modal.style.display = 'flex';
      modalUpgradeBtn.style.display = showUpgrade ? 'inline-block' : 'none';
    }

    modalClose.onclick = () => modal.style.display = 'none';
    modalUpgradeBtn.onclick = () => { modal.style.display = 'none'; };

    let udata = null; // Store user data globally for exportCSV check
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = 'login.html'; return; }
      uidGlobal = user.uid;
      userEmailEl.textContent = user.email || user.uid;

      db.ref(`users/${uidGlobal}`).on('value', snap => {
        udata = snap.val() || {};
        console.log('User data fetched:', udata);
        applyPlanToUI(udata);
        checkAndAutoDowngrade(uidGlobal, udata);
        if (udata.custom_marker_icon) {
          customMarkerIcon = L.icon({ iconUrl: udata.custom_marker_icon, iconSize: [32, 32], iconAnchor: [16, 30] });
          if (liveMarker) liveMarker.setIcon(customMarkerIcon);
        }
        if (udata.admin === true) { isAdmin = true; adminPanel.style.display = 'block'; }
        else { isAdmin = false; adminPanel.style.display = 'none'; }
        if (udata.purchases?.fleet || localPlan.fleet) renderFleetList();
      });

      const ref = db.ref(`users/${uidGlobal}/vehicle`);
      ref.child("current").on("value", snap => {
        const d = snap.val();
        if (!d) return;
        locationEl.textContent = d.latitude && d.longitude ? `${d.latitude}, ${d.longitude}` : "No location";
        if (d.latitude && d.longitude) {
          updateMap(parseFloat(d.latitude), parseFloat(d.longitude));
          const inside = pointInsideGeofences(parseFloat(d.latitude), parseFloat(d.longitude));
          if (geofenceState.lastInsideAny === null) geofenceState.lastInsideAny = inside;
          if (geofenceState.lastInsideAny && !inside) {
            showModal('<b>Geofence Alert:</b> Vehicle left the zone.', false);
            const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
            if (policy.notify && 'Notification' in window && Notification.permission === 'granted') {
              new Notification('Geofence Alert', { body: 'Vehicle left the zone' });
            }
          }
          geofenceState.lastInsideAny = inside;
        }
        lastActiveEl.textContent = d.last_active || "Unknown";
        statusEl.textContent = d.status || "Unknown";
        const batt = (typeof d.battery !== 'undefined') ? Number(d.battery) : null;
        batteryHealthEl.textContent = (batt !== null && !isNaN(batt)) ? `${batt}%` : "N/A";
        if (batt !== null) maybeNotifyBattery(batt);
        ref.child("online").once('value').then(s => renderOnlineAndLastActive(s.val(), d.last_active));
      });

      ref.child("history").on("value", snap => {
        const raw = snap.val() || null;
        fullHistory = raw ? Object.values(raw).slice().reverse().map(parseEntry) : [];
        applyHistoryPipeline();
        if (localPlan.analytics) renderAnalyticsChart(fullHistory);
      });

      ref.child("components").on("value", snap => renderComponents(snap.val()));
      ref.child("online").on("value", snap => {
        ref.child("current/last_active").once("value").then(s2 => renderOnlineAndLastActive(snap.val(), s2.val()));
      });
      ref.child("last_seen").on("value", s => lastSeenEl.textContent = s.val() || "N/A");
      ref.child("alarm").on("value", s => {
        const st = s.val() || "off";
        alarmToggle.checked = st === "on";
        alarmStatusText.textContent = `Alarm is ${st.toUpperCase()}`;
      });
      ref.child("last_trigger").on("value", s => {
        const t = s.val();
        if (t && t.time && t.status === "alert") {
          alarmTriggerEl.innerHTML = `<span style="color:red;">‚ö†Ô∏è ${t.time} at ${t.location}</span>`;
        } else alarmTriggerEl.textContent = "No triggers";
      });
      alarmToggle.addEventListener("change", () => {
        ref.child("alarm").set(alarmToggle.checked ? "on" : "off");
      });

      db.ref('admin/upgrade_requests').on('value', snap => {
        if (!isAdmin) return;
        const reqs = snap.val() || {};
        adminList.innerHTML = '<table style="width:100%"><thead><tr><th>User</th><th>Plan</th><th>When</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>';
        const tbody = adminList.querySelector('tbody');
        tbody.innerHTML = '';
        Object.entries(reqs).reverse().forEach(([key, val]) => {
          const tr = document.createElement('tr');
          const when = val.request_time || '-';
          const status = val.status || '-';
          tr.innerHTML = `<td>${val.uid}</td><td>${val.requestedPlan || ''}</td><td>${when}</td><td>${status}</td><td></td>`;
          const actionsTd = tr.querySelector('td:last-child');
          if (status === 'pending') {
            const aBtn = document.createElement('button');
            aBtn.textContent = 'Approve';
            aBtn.className = 'btn btn-primary';
            aBtn.onclick = () => {
              adminApproveRequest(uidGlobal, user.email || uidGlobal, key, val);
            };
            const rBtn = document.createElement('button');
            rBtn.textContent = 'Reject';
            rBtn.className = 'btn btn-danger';
            rBtn.style.marginLeft = '8px';
            rBtn.onclick = () => {
              if (!confirm('Reject this upgrade request?')) return;
              adminRejectRequest(uidGlobal, user.email || uidGlobal, key, val);
            };
            actionsTd.appendChild(aBtn);
            actionsTd.appendChild(rBtn);
          } else {
            actionsTd.textContent = 'Processed';
          }
          tbody.appendChild(tr);
        });
      });

      db.ref('admin/approvals').limitToLast(50).on('value', snap => {
        if (!isAdmin) return;
        const logs = snap.val() || {};
        adminLogs.innerHTML = '<ul style="padding-left:16px;margin:0;">' +
          Object.entries(logs).reverse().map(([k, v]) =>
            `<li style="margin-bottom:6px;"><b>${v.adminName || v.adminUid || 'admin'}</b> ‚Üí ${v.uid} : ${v.plan || v.status} (${v.approvedAt || v.processedAt || v.time || ''})</li>`
          ).join('') + '</ul>';
      });

      await loadGeofences();
      await renderFleetList();
    });

    function applyHistoryPipeline(plotPolyline = false) {
      if (!fullHistory) {
        historyTbody.innerHTML = '<tr><td colspan="3">No history</td></tr>';
        return;
      }
      filteredHistory = applyDateFilter(fullHistory);
      renderHistoryTable(filteredHistory);
      computeKPIs(filteredHistory);
      if (plotPolyline) plotRoute(filteredHistory);
      updateHeatmap(filteredHistory);
      if (localPlan.analytics) renderAnalyticsChart(filteredHistory);
    }

    applyFilterBtn.addEventListener('click', () => applyHistoryPipeline(true));
    clearFilterBtn.addEventListener('click', () => {
      startDateInput.value = '';
      endDateInput.value = '';
      applyHistoryPipeline();
    });

    exportCSVBtn.addEventListener('click', () => exportHistoryCSV(filteredHistory));
    buyExportBtn.addEventListener('click', () => buyFeature('export', 2));

    buyAnalyticsBtn.addEventListener('click', () => buyFeature('analytics', 5));
    buyFleetBtn.addEventListener('click', () => buyFeature('fleet', 30));
    addVehicleBtn.addEventListener('click', addVehicle);

    mapTypeSelect.addEventListener('change', (e) => {
      updateBaseLayer(e.target.value);
    });

    heatToggle.addEventListener('change', () => updateHeatmap(filteredHistory));

    iconUploader.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file || !uidGlobal) return;
      const reader = new FileReader();
      reader.onload = async () => {
        const dataUrl = reader.result;
        await db.ref(`users/${uidGlobal}/custom_marker_icon`).set(dataUrl);
        customMarkerIcon = L.icon({ iconUrl: dataUrl, iconSize: [32, 32], iconAnchor: [16, 30] });
        if (liveMarker) liveMarker.setIcon(customMarkerIcon);
        alert('Custom marker icon saved.');
      };
      reader.readAsDataURL(file);
    });

    gfEnableDrawBtn.addEventListener('click', () => {
      enableDrawing();
    });

    gfSaveBtn.addEventListener('click', () => {
      saveGeofences();
      disableDrawing();
    });

    gfClearBtn.addEventListener('click', async () => {
      if (!uidGlobal) return;
      drawnItems.clearLayers();
      await db.ref(`users/${uidGlobal}/geofences`).set([]);
      alert('Geofences cleared');
    });

    upgradeToSilverBtn.addEventListener('click', () => {
      if (!uidGlobal) return alert('Not logged in');
      createUpgradeRequest(uidGlobal, 'silver').then(() => {
        upgradeToSilverBtn.style.display = 'none';
        upgradeToGoldBtn.style.display = 'none';
        requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
      }).catch(() => { alert('Failed to send request'); });
    });

    upgradeToGoldBtn.addEventListener('click', () => {
      if (!uidGlobal) return alert('Not logged in');
      createUpgradeRequest(uidGlobal, 'gold').then(() => {
        upgradeToSilverBtn.style.display = 'none';
        upgradeToGoldBtn.style.display = 'none';
        requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
      }).catch(() => { alert('Failed to send request'); });
    });
  </script>
</body>
</html>
