<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Tracker Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* ... Your styles remain unchanged ... */
    /* (You can keep your style tag as is) */
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- ... all your card sections up to Movement History are unchanged ... -->
    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div style="margin-bottom: 10px;">
        <label>From: <input type="datetime-local" id="filterFrom"></label>
        <label style="margin-left:10px;">To: <input type="datetime-local" id="filterTo"></label>
        <button id="applyFilterBtn" class="view-btn" style="margin-left:10px;">Apply</button>
        <button id="resetFilterBtn" class="view-btn" style="background:#6c757d;margin-left:5px;">Reset</button>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>
  </div>

  <!-- ... your scripts ... -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ... All your globals and helper functions as before ...

    let map, marker, routePolyline = null, startMarker = null, endMarker = null;
    let fullHistory = [];
    let shownHistory = [];

    // ... All your render and update functions ...

    function clearRouteLayers() {
      if (routePolyline) { try { map.removeLayer(routePolyline); } catch(e){} routePolyline = null; }
      if (startMarker) { try { map.removeLayer(startMarker); } catch(e){} startMarker = null; }
      if (endMarker) { try { map.removeLayer(endMarker); } catch(e){} endMarker = null; }
    }
    function plotRoute(points) {
      clearRouteLayers();
      if (!map || !points || points.length === 0) return;
      if (points.length > 1) {
        routePolyline = L.polyline(points, {color:"blue",weight:5,opacity:0.8}).addTo(map);
        map.fitBounds(routePolyline.getBounds(), {padding:[40,40]});
        startMarker = L.marker(points[0], {
          icon: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png',iconSize:[32,32],iconAnchor:[16,32]})
        }).addTo(map).bindPopup('Start').openPopup();
        endMarker = L.marker(points[points.length-1], {
          icon: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png',iconSize:[32,32],iconAnchor:[16,32]})
        }).addTo(map).bindPopup('End');
      } else if (points.length === 1) {
        map.setView(points[0], 15);
        startMarker = L.marker(points[0], {
          icon: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',iconSize:[32,32],iconAnchor:[16,32]})
        }).addTo(map).bindPopup('Location');
      }
    }

    function renderHistoryTable(arr) {
      historyEl.innerHTML = "";
      if (!arr || !arr.length) {
        historyEl.innerHTML = `<tr><td colspan="3">No history found.</td></tr>`;
        return;
      }
      arr.slice().reverse().forEach(entry => {
        const loc = entry.location || "";
        const time = entry.time || "";
        const [lat, lng] = (loc + "").split(",");
        const safeLat = parseFloat(lat) || 0;
        const safeLng = parseFloat(lng) || 0;
        historyEl.innerHTML += `
          <tr>
            <td>${time}</td>
            <td>${loc}</td>
            <td><button class="view-btn" onclick="focusOnMap(${safeLat}, ${safeLng})">View</button></td>
          </tr>`;
      });
    }

    // --- Filtering & Map update: plot only after filter, NOT initially! ---
    function applyFilter() {
      const fromMs = parseDateTimeLocalToMs(filterFrom.value);
      const toMs = parseDateTimeLocalToMs(filterTo.value);
      shownHistory = fullHistory.filter(entry => {
        if (!entry.time || !entry.location) return false;
        const entryMs = parseTimestampToMs(entry.time);
        if (entryMs === null) return false;
        if ((fromMs && entryMs < fromMs) || (toMs && entryMs > toMs)) return false;
        const arr = entry.location.split(',').map(Number);
        return arr[0] !== 0 && arr[1] !== 0;
      });
      renderHistoryTable(shownHistory);
      plotRoute(shownHistory.map(h => h.location.split(",").map(Number)));
    }
    function resetFilter() {
      filterFrom.value = "";
      filterTo.value = "";
      shownHistory = fullHistory.slice();
      renderHistoryTable(shownHistory);
      clearRouteLayers(); // <-- Only clear the map, do NOT auto-plot!
    }
    applyFilterBtn.addEventListener("click", applyFilter);
    resetFilterBtn.addEventListener("click", resetFilter);

    // --------- load dashboard & db listeners ----------
    function loadDashboard(uid) {
      uidGlobal = uid;
      const vehicleRef = db.ref(`users/${uid}/vehicle`);
      vehicleRef.child("current").on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const { latitude, longitude, status, last_active, battery } = data;
        if (typeof latitude !== 'undefined' && typeof longitude !== 'undefined') {
          locationEl.textContent = `${latitude}, ${longitude}`;
          updateMap(latitude, longitude);
        } else { locationEl.textContent = "No location"; }
        lastActiveEl.textContent = last_active || "Unknown";
        statusEl.textContent = status || "Unknown";
        batteryHealthEl.textContent = (typeof battery !== 'undefined') ? `${battery}%` : "N/A";
        vehicleRef.child("online").once("value").then(snap => {
          renderOnlineAndLastActive(snap.val(), last_active);
        });
      });
      vehicleRef.child("history").on("value", (snapshot) => {
        const historyObj = snapshot.val();
        fullHistory = [];
        if (historyObj) {
          // Oldest-to-newest for plotting
          fullHistory = Object.values(historyObj)
            .filter(e=> e && e.location && e.time)
            .sort((a, b) => parseTimestampToMs(a.time)-parseTimestampToMs(b.time));
        }
        // DO NOT autofilter or autoplot on init/load: just reset table, clear map
        shownHistory = fullHistory.slice();
        renderHistoryTable(shownHistory);
        clearRouteLayers();
      });
      // ... the rest of your dashboard event handlers unchanged ...
      vehicleRef.child("components").on("value", (snap) => renderComponents(snap.val()));
      vehicleRef.child("online").on("value", (snapshot) => {
        vehicleRef.child("current/last_active").once("value").then(snap2 => {
          renderOnlineAndLastActive(snapshot.val(), snap2.val());
        });
      });
      vehicleRef.child("last_seen").on("value", (snapshot) => {
        lastSeenEl.textContent = snapshot.val() || "N/A";
      });
      vehicleRef.child("alarm").on("value", (snap) => {
        const status = snap.val() || "off";
        alarmToggle.checked = (status === "on");
        alarmStatusText.textContent = `Alarm is ${status.toUpperCase()}`;
      });
      vehicleRef.child("last_trigger").on("value", (snap) => {
        const t = snap.val();
        alarmTriggerEl.innerHTML = (t && t.time && t.status === "alert") ? `<span style="color:red;">‚ö†Ô∏è ${t.time} at ${t.location}</span>` : "No triggers";
      });
      vehicleRef.child("current/status").on("value", (snap) => {
        if (snap.val()) statusEl.textContent = snap.val();
      });
      alarmToggle.addEventListener("change", () => {
        vehicleRef.child("alarm").set(alarmToggle.checked ? "on" : "off").catch(console.error);
      });
      startLastActivePoll(uid);
    }
    auth.onAuthStateChanged((user) => {
      if (user) {
        loadDashboard(user.uid);
        document.getElementById("userEmail").textContent = user.email;
        document.getElementById("logoutBtn").onclick = () => auth.signOut();
      } else {
        window.location.href = "login.html";
      }
    });

    // -- rest unchanged --
    function renderComponents(obj) { /* ... */ }
    function parseTimestampToMs(ts) { /* ... as above ... */ }
    function computeOnlineDisplay(firebaseOnlineFlag, lastActiveStr) { /* ... */ }
    function renderOnlineAndLastActive(firebaseOnlineFlag, lastActiveStr) { /* ... */ }
    function startLastActivePoll(uid) { /* ... */ }
    function parseDateTimeLocalToMs(dtLocal) { if (!dtLocal) return null; return new Date(dtLocal).getTime(); }
  </script>
</body>
</html>
