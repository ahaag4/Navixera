<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Tracker Dashboard ‚Äì Premium Features</title>
<link rel="icon" href="assets/favicon.ico"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<style>
  body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f7f9fc; }
  .dashboard { max-width: 1080px; margin:28px auto; padding:0 24px 36px 24px; }
  header { background: #222c37; color: #fff; padding: 22px 24px; border-radius: 18px; display:flex; align-items:center; justify-content:space-between; margin-bottom: 24px; box-shadow: 0 2px 16px rgba(0,0,0,.075); flex-wrap:wrap; }
  .header-left { display:flex; align-items:center; gap:20px; }
  .logo { height:48px; }
  .app-title { font-size:25px; font-weight:800; }
  .header-right { display:flex; align-items:center; gap:18px; }
  .plan-pill { background:linear-gradient(90deg,#2670ff,#31ffa7); padding:6px 18px; color:#fff; border-radius:20px; font-weight:700; }
  .header-logout { background:#2636ad; padding:8px 22px; color:#fff; border:none; border-radius:8px; cursor:pointer; }
  .card { background:#fff; padding:22px; margin:20px 0; border-radius:14px; box-shadow:0 2px 15px rgba(40,50,90,.09); }
  h2 { margin:0 0 10px 0; color:#191f2a; }
  .badge { padding:6px 14px; border-radius:8px; font-weight:600; color:#fff; font-size:13px; }
  .badge.online { background:#28a745; } .badge.offline { background:#dc3545; }
  .components-list { list-style:none; padding:0; }
  .components-list li.comp-ok { color:#25ad45; font-weight:700; }
  .components-list li.comp-warn { color:#e67700; font-weight:700; }
  .components-list li.comp-bad { color:#c82333; font-weight:700; }
  .components-list li.comp-unknown { color:#6c757d; font-weight:700; }
  .view-btn { background:#2670ff; color:#fff; padding:7px 15px; border:none; border-radius:8px; cursor:pointer; }

  .map-controls, .toolbar { margin:8px 0; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .toolbar label { font-size:14px; color:#333; margin-right:4px; }
  .toolbar input[type="date"], .toolbar select, .toolbar button { padding:6px 10px; border:1px solid #e5e9f2; border-radius:8px; font-size:14px; cursor:pointer; }
  .btn { padding:8px 15px; border-radius:7px; border:none; cursor:pointer; font-size:15px; }
  .btn-primary { background:#2670ff; color:#fff; font-weight:700; }
  .btn-warning { background:#ffd966; color:#4a2900; font-weight:700; }
  .btn-danger { background:#dc3545; color:#fff; font-weight:700; }
  .btn-ghost { background:transparent; border:1px solid #ddd; font-weight:700; }
  .hint { font-size:12px; color:#6c757d; margin-left:8px; }
  table { width:100%; border-collapse:collapse; }
  th,td { padding:10px; border-bottom:1px solid #f2f5fc; text-align:left; font-size:15px; }
  #map { height: 300px; border-radius: 8px; }
  .kpi { display:flex; gap:14px; margin-top:6px; flex-wrap:wrap; }
  .kpi .pill { background:#f4f7ff; border:1px solid #e7ecff; padding:8px 12px; border-radius:10px; font-weight:700; color:#2b3a67; }

  /* Modal */
  #modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:10000; }
  #modal .dialog { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:520px; }

  @media (max-width:600px) {
    .dashboard {padding:0 7px;}
    header {flex-direction:column;align-items:flex-start;padding:16px 5px;}
    .header-left{gap:10px;}
    .app-title{font-size:18px;}
    .plan-pill{font-size:13px;}
    .header-logout{font-size:13px;padding:7px 13px;}
    .card{padding:13px;}
    th,td{font-size:14px;}
    .pending-pill,.approved-pill,.rejected-pill{font-size:13px;}
    .toolbar {gap:6px;}
  }
</style>
</head>
<body>
<div class="dashboard">

<header>
  <div class="header-left">
    <img src="assets/logo.png" alt="Logo" class="logo"/>
    <div class="app-title">Smart Tracker <span id="planPillHeader"></span></div>
  </div>
  <div class="header-right">
    <span id="userEmail">Loading...</span>
    <span class="plan-pill" id="planPill">‚Äî</span>
    <button id="logoutBtn" class="header-logout">Logout</button>
  </div>
</header>

<div id="adArea" class="card">Ad placeholder</div>

<section class="card status-card">
  <h2>üîç Live Status</h2>
  <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:2px;">
    <div><strong>Online:</strong> <span id="onlineStatus"><span class='badge offline'>Checking...</span></span></div>
    <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
  </div>
  <p><strong>Location:</strong> <span id="location">Loading...</span></p>
  <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
  <p><strong>Status:</strong> <span id="status">Loading...</span></p>
  <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
  <p><strong>Alarm Last Trigger:</strong> <span id="alarmTrigger">No triggers</span></p>
  <div id="componentsBlock">
    <h4 style="font-size:16px;border-bottom:1px solid #f3f6ff;">Components</h4>
    <ul id="componentsList" class="components-list">
      <li class="comp-unknown">No data</li>
    </ul>
  </div>
</section>

<section class="card alarm-card">
  <h2>üîî Alarm</h2>
  <label class="switch">
    <input type="checkbox" id="alarmToggle">
    <span class="slider round"></span>
  </label>
  <span id="alarmStatusText" style="margin-left:14px;">Loading alarm status...</span>
</section>

<section class="card subscription-card">
  <h2>üí≥ Subscription & Upgrades</h2>
  <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
    <div>Plan: <strong id="currentPlan">Loading</strong></div>
    <div class="small-muted">Expiry: <span id="planExpiry">-</span></div>
    <div class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></div>
    <div id="upgradeBtns" style="margin-left:auto;">
      <button id="upgradeToSilver" class="btn btn-warning">Request Silver (‚Çπ149/mo)</button>
      <button id="upgradeToGold" class="btn btn-primary">Request Gold (‚Çπ249/mo)</button>
    </div>
  </div>
  <div style="margin-top:10px;">
    <span id="requestStatusArea"></span>
  </div>
  <div style="margin-top:14px;" class="small-muted">
    Plans: Basic (24h history, ads) ‚Ä¢ Silver (7d history, limited ads, CSV export) ‚Ä¢ Gold (90d, no ads, CSV & analytics, advanced features)
  </div>
</section>

<section class="card map-card">
  <h2>üó∫ Live Map</h2>
  <div class="toolbar" id="mapToolbar" style="display:flex; flex-wrap:wrap;">
    <div class="inline" id="mapTypeBlock" style="display:none;">
      <label for="mapType">Map:</label>
      <select id="mapType">
        <option value="street">Street</option>
        <option value="satellite">Satellite</option>
        <option value="dark">Dark</option>
      </select>
    </div>
    <div class="inline" id="heatToggleBlock" style="display:none; margin-left:12px;">
      <label>Heatmap:</label>
      <label class="switch" style="margin-left:4px;">
        <input type="checkbox" id="heatToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="inline" id="customIconBlock" style="display:none; margin-left:12px;">
      <label for="iconUploader">Marker Icon:</label>
      <input type="file" id="iconUploader" accept="image/*" style="margin-left:8px;"/>
      <span class="hint">PNG/JPG, ~32√ó32 recommended</span>
    </div>
    <div class="inline" id="geofenceControls" style="display:none; margin-left:12px;">
      <button class="btn btn-ghost" id="gfEnableDraw">Add Zone</button>
      <button class="btn btn-ghost" id="gfSave">Save Zones</button>
      <button class="btn btn-ghost" id="gfClear">Clear Zones</button>
      <span class="hint" id="gfHint" style="margin-left:8px;"></span>
    </div>
  </div>
  <div id="map" style="height:300px;border-radius:8px;">Loading map...</div>
  <div class="kpi" style="margin-top:10px;">
    <div class="pill">Distance: <span id="kpiDistance">0.00 km</span></div>
    <div class="pill">Stops: <span id="kpiStops">0</span></div>
    <div class="pill">Refresh: <span id="kpiRefresh">‚Äî</span></div>
  </div>
</section>

<section class="card history-card">
  <h2>üìà Movement History</h2>
  <div class="toolbar" id="dateFilterSection" style="display:none;">
    <div class="inline">
      <label for="startDate">From:</label>
      <input type="date" id="startDate" />
    </div>
    <div class="inline" style="margin-left:8px;">
      <label for="endDate">To:</label>
      <input type="date" id="endDate" />
    </div>
    <button class="btn btn-primary" id="applyFilterBtn" style="margin-left:12px;">Filter</button>
    <button class="btn btn-ghost" id="clearFilterBtn" style="margin-left:8px;">Clear</button>
  </div>
  <div style="display:flex;justify-content:space-between;align-items:center; margin-top:8px;">
    <div class="small-muted">Recent movements</div>
    <div>
      <button id="exportCSVBtn" class="btn btn-primary" style="display:none;">Export CSV</button>
    </div>
  </div>
  <table>
    <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
    <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
  </table>
</section>

<section id="adminPanel" class="card admin-panel" style="display:none;">
  <h2>üîß Admin Panel ‚Äî Upgrade Requests</h2>
  <div id="adminList">Loading admin data‚Ä¶</div>
  <hr/>
  <h3>Recent admin logs</h3>
  <div id="adminLogs">Loading logs‚Ä¶</div>
</section>

</div>

<div id="modal">
  <div class="dialog">
    <div id="modalContent"></div>
    <div style="margin-top:12px;text-align:right;">
      <button id="modalClose" class="btn btn-ghost">Close</button>
      <button id="modalUpgradeBtn" class="btn btn-primary" style="display:none;">Request Upgrade</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM Elements
  const userEmailEl = document.getElementById('userEmail');
  const planPill = document.getElementById('planPill');
  const planPillHeader = document.getElementById('planPillHeader');
  const adArea = document.getElementById('adArea');
  const locationEl = document.getElementById("location");
  const lastActiveEl = document.getElementById("lastActive");
  const statusEl = document.getElementById("status");
  const batteryHealthEl = document.getElementById("batteryHealth");
  const historyTbody = document.getElementById("history");
  const exportCSVBtn = document.getElementById("exportCSVBtn");
  const alarmToggle = document.getElementById("alarmToggle");
  const alarmStatusText = document.getElementById("alarmStatusText");
  const alarmTriggerEl = document.getElementById("alarmTrigger");
  const onlineStatusEl = document.getElementById("onlineStatus");
  const lastSeenEl = document.getElementById("lastSeen");
  const componentsListEl = document.getElementById("componentsList");
  const currentPlanEl = document.getElementById('currentPlan');
  const planExpiryEl = document.getElementById('planExpiry');
  const vehicleLimitEl = document.getElementById('vehicleLimit');
  const upgradeBtns = document.getElementById('upgradeBtns');
  const upgradeToSilverBtn = document.getElementById('upgradeToSilver');
  const upgradeToGoldBtn = document.getElementById('upgradeToGold');
  const requestStatusArea = document.getElementById('requestStatusArea');
  const adminPanel = document.getElementById('adminPanel');
  const adminList = document.getElementById('adminList');
  const adminLogs = document.getElementById('adminLogs');
  const modal = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const modalClose = document.getElementById('modalClose');
  const modalUpgradeBtn = document.getElementById('modalUpgradeBtn');
  document.getElementById('logoutBtn').onclick = () => auth.signOut();

  // New UI Controls
  const dateFilterSection = document.getElementById('dateFilterSection');
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const applyFilterBtn = document.getElementById('applyFilterBtn');
  const clearFilterBtn = document.getElementById('clearFilterBtn');

  const mapTypeBlock = document.getElementById('mapTypeBlock');
  const mapTypeSelect = document.getElementById('mapType');
  const heatToggleBlock = document.getElementById('heatToggleBlock');
  const heatToggle = document.getElementById('heatToggle');
  const customIconBlock = document.getElementById('customIconBlock');
  const iconUploader = document.getElementById('iconUploader');

  const geofenceControls = document.getElementById('geofenceControls');
  const gfEnableDrawBtn = document.getElementById('gfEnableDraw');
  const gfSaveBtn = document.getElementById('gfSave');
  const gfClearBtn = document.getElementById('gfClear');
  const gfHint = document.getElementById('gfHint');

  const kpiDistanceEl = document.getElementById('kpiDistance');
  const kpiStopsEl = document.getElementById('kpiStops');
  const kpiRefreshEl = document.getElementById('kpiRefresh');

  let uidGlobal = null;
  let isAdmin = false;
  let localPlan = { plan: 'basic', plan_expiry: null, vehicle_limit: 1, exportCSV: false };

  const PLAN_POLICIES = {
    basic: { historyDays: 1, ads: 'banner+interstitial', vehicle_limit: 1, exportCSV: false, refreshMs: 30000, heatmap: false, mapSwitch: false, notify: false, geofences: 0 },
    silver: { historyDays: 7, ads: 'banner-limited', vehicle_limit: 3, exportCSV: true, refreshMs: 20000, heatmap: false, mapSwitch: true, notify: true, geofences: 1 },
    gold: { historyDays: 90, ads: 'no-ads', vehicle_limit: 3, exportCSV: true, refreshMs: 10000, heatmap: true, mapSwitch: true, notify: true, geofences: 999 }
  };

  // Ad display
  let adTimerInt = null, currentAdIndex = 0, adsList = [];
  function showAd(ad) {
    adArea.innerHTML = 'Loading...';
    if (ad.type === 'banner') {
      const img = new Image(); img.src = ad.url;
      img.onload = () => { adArea.innerHTML = ''; adArea.appendChild(img); };
    } else if (ad.type === 'video') {
      const v = document.createElement('video'); v.src = ad.url; v.controls = true; v.autoplay = true; v.muted = true;
      adArea.innerHTML = ''; adArea.appendChild(v);
    }
  }
  function loadAdsForPlan(plan) {
    if (adTimerInt) clearInterval(adTimerInt);
    const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
    if (policy.ads === 'no-ads') { adArea.style.display = 'none'; adArea.innerHTML = ''; return; }
    adArea.style.display = 'flex';
    db.ref('admin/ads').once('value').then(snapshot => {
      const adsObj = snapshot.val() || {};
      adsList = Object.values(adsObj).filter(ad =>
        ad && ad.active && ad.url &&
        (ad.placement === 'dashboard_top' || ad.placement === 'dashboard_footer')
      );
      if (policy.ads === 'banner-limited' && adsList.length > 1) { adsList = adsList.slice(0, 1); }
      if (adsList.length) {
        showAd(adsList[currentAdIndex = 0]);
        adTimerInt = setInterval(() => {
          currentAdIndex = (currentAdIndex + 1) % adsList.length;
          showAd(adsList[currentAdIndex]);
        }, 15000);
      } else {
        adArea.innerHTML = 'No active ad';
      }
    }).catch(() => { adArea.innerHTML = 'Ad load error'; });
  }
  function renderAdsForPlan(plan) { loadAdsForPlan(plan); }

  // Plan upgrade UI render
  function renderRequestUI(upgradeRequest, currentPlan) {
    upgradeToSilverBtn.style.display = 'none';
    upgradeToGoldBtn.style.display = 'none';
    let statusMsg = '';
    if (currentPlan === 'gold') {
      upgradeBtns.style.display = 'none';
      statusMsg = `<span class="approved-pill">You are on GOLD, the highest plan.</span>`;
    } else if (!upgradeRequest || !upgradeRequest.status) {
      upgradeBtns.style.display = 'block';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      statusMsg = '';
    } else if (upgradeRequest.status === 'pending') {
      upgradeBtns.style.display = 'none';
      statusMsg = `<span class="pending-pill">Upgrade to ${upgradeRequest.requestedPlan?.toUpperCase() || ''} ‚Äî PENDING APPROVAL</span>`;
    } else if (upgradeRequest.status === 'approved') {
      upgradeBtns.style.display = 'none';
      statusMsg = `<span class="approved-pill">Upgrade approved ‚Äî Enjoy your ${upgradeRequest.requestedPlan?.toUpperCase() || ''} plan</span>`;
    } else if (upgradeRequest.status === 'rejected') {
      upgradeBtns.style.display = 'block';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      statusMsg = `<span class="rejected-pill">Upgrade request rejected ‚Äî you may try again</span>`;
    } else if (upgradeRequest.status === 'cancelled') {
      upgradeBtns.style.display = 'block';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      statusMsg = `<span class="small-muted">Upgrade request cancelled</span>`;
    }
    requestStatusArea.innerHTML = statusMsg;
  }

  function prettyTS(iso) { if (!iso) return '-'; try { return new Date(iso).toLocaleString(); } catch (e) { return iso; } }

  function applyPlanToUI(udata) {
    const plan = udata.plan || 'basic';
    const plan_expiry = udata.plan_expiry || null;
    const vehicle_limit = (udata.vehicle_limit || PLAN_POLICIES[plan].vehicle_limit);
    const exportCSV = (typeof udata.exportCSV === 'boolean') ? udata.exportCSV : !!PLAN_POLICIES[plan].exportCSV;
    localPlan = { plan, plan_expiry, vehicle_limit, exportCSV };
    planPill.textContent = plan.toUpperCase();
    currentPlanEl.textContent = plan.toUpperCase();
    planPillHeader.textContent = plan.toUpperCase();
    planExpiryEl.textContent = prettyTS(plan_expiry); vehicleLimitEl.textContent = vehicle_limit;
    exportCSVBtn.style.display = exportCSV ? 'inline-block' : 'none';
    renderAdsForPlan(plan);
    renderRequestUI(udata.upgrade_request || null, plan);

    // Gated UI elements
    const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
    dateFilterSection.style.display = ['silver', 'gold'].includes(plan) ? 'flex' : 'none';
    mapTypeBlock.style.display = policy.mapSwitch ? 'flex' : 'none';
    heatToggleBlock.style.display = (plan === 'gold') ? 'flex' : 'none';
    customIconBlock.style.display = plan !== 'basic' ? 'flex' : 'none';
    geofenceControls.style.display = policy.geofences > 0 ? 'flex' : 'none';
    gfHint.textContent = plan === 'silver' ? 'Max 1 zone' : (plan === 'gold' ? 'Multiple zones allowed' : '');

    kpiRefreshEl.textContent = (policy.refreshMs / 1000) + 's';
    setRefreshIntervals(policy.refreshMs);

    if (policy.notify && 'Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().catch(() => { });
    }
  }

  // Upgrade requests (DB ops)
  function createUpgradeRequest(uid, desiredPlan) {
    const now = new Date().toISOString();
    const req = { status: 'pending', requestedPlan: desiredPlan, request_time: now };
    const updates = {};
    updates[`users/${uid}/upgrade_request`] = req;
    const adminKey = `req_${uid}_${Date.now()}`;
    updates[`admin/upgrade_requests/${adminKey}`] = { uid, requestedPlan: desiredPlan, status: 'pending', request_time: now };
    return db.ref().update(updates);
  }
  async function adminApproveRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const plan = adminReqObj.requestedPlan || 'silver';
    const now = new Date();
    const expiry = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
    const updates = {};
    updates[`users/${targetUid}/plan`] = plan;
    updates[`users/${targetUid}/plan_expiry`] = expiry.toISOString();
    updates[`users/${targetUid}/vehicle_limit`] = PLAN_POLICIES[plan].vehicle_limit;
    updates[`users/${targetUid}/exportCSV`] = true;
    updates[`users/${targetUid}/upgrade_request/status`] = 'approved';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'approved';
    updates[`admin/approvals/${adminReqKey}`] = {
      adminUid, adminName, uid: targetUid, plan, approvedAt: new Date().toISOString(), adminNameDisplay: adminName || adminUid
    };
    await db.ref().update(updates);
    alert('User upgraded to ' + plan.toUpperCase());
  }
  async function adminRejectRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const updates = {};
    updates[`users/${targetUid}/upgrade_request/status`] = 'rejected';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'rejected';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, status: 'rejected', processedAt: new Date().toISOString() };
    await db.ref().update(updates);
    alert('Request rejected.');
  }
  function checkAndAutoDowngrade(uid, udata) {
    if (!udata || !udata.plan || !udata.plan_expiry) return;
    const expiryMs = Date.parse(udata.plan_expiry);
    if (isNaN(expiryMs)) return;
    if (Date.now() >= expiryMs && udata.plan !== 'basic') {
      const updates = {
        [`users/${uid}/plan`]: 'basic',
        [`users/${uid}/plan_expiry`]: null,
        [`users/${uid}/vehicle_limit`]: PLAN_POLICIES.basic.vehicle_limit,
        [`users/${uid}/exportCSV`]: false,
        [`users/${uid}/upgrade_request/status`]: 'cancelled'
      };
      db.ref().update(updates).then(() => {
        const k = `downgrade_${uid}_${Date.now()}`;
        db.ref(`admin/downgrades/${k}`).set({ uid, old_plan: udata.plan, new_plan: 'basic', time: new Date().toISOString(), reason: 'expired_auto_downgrade' });
      });
    }
  }

  // Map setup & layers
  let map = null;
  let liveMarker = null;
  let baseLayer = null;
  const baseLayers = {
    street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }),
    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20 }),
    dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }),
  };

  let routeLayer = null, startMarker = null, endMarker = null, heatLayer = null;

  // Custom icon (Leaflet Icon instance)
  let customMarkerIcon = null;

  function createLeafletIcon(url) {
    return L.icon({
      iconUrl: url,
      iconSize: [32, 37],
      iconAnchor: [16, 37],
      popupAnchor: [0, -28],
      shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
      shadowSize: [41, 41],
      shadowAnchor: [14, 41]
    });
  }

  function initMap(lat, lng) {
    map = L.map('map').setView([lat, lng], 14);
    baseLayer = baseLayers.street;
    baseLayer.addTo(map);
    liveMarker = L.marker([lat, lng], { icon: customMarkerIcon || undefined }).addTo(map);
    setupDrawTools();
  }

  function updateBaseLayer(type) {
    if (!map) return;
    if (baseLayer) map.removeLayer(baseLayer);
    baseLayer = baseLayers[type] || baseLayers.street;
    baseLayer.addTo(map);
  }

  function updateMap(lat, lng, popupText = null) {
    if (!(typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng))) return;
    if (!map) {
      initMap(lat, lng);
    } else {
      if (!liveMarker) liveMarker = L.marker([lat, lng], { icon: customMarkerIcon || undefined }).addTo(map);
      else liveMarker.setLatLng([lat, lng]);
      map.setView([lat, lng], 14);
    }
    if (popupText) liveMarker.bindPopup(popupText).openPopup();
  }

  window.focusOnMap = function (lat, lng) {
    lat = parseFloat(lat); lng = parseFloat(lng);
    if (!isNaN(lat) && !isNaN(lng)) {
      updateMap(lat, lng, `üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
      map.setView([lat, lng], 15);
    }
  };

  // History & filtering
  let fullHistory = [];
  let filteredHistory = [];

  function parseEntry(entry) {
    const loc = entry.location || '';
    const [lat, lng] = (loc.split(',') || []).map(s => parseFloat(s.trim()));
    const tms = Date.parse(entry.time || '');
    return { lat, lng, time: entry.time || '', ts: isNaN(tms) ? null : tms, speed: typeof entry.speed === 'number' ? entry.speed : null };
  }

  function renderHistoryTable(list) {
    historyTbody.innerHTML = '';
    if (!list || !list.length) {
      historyTbody.innerHTML = '<tr><td colspan="3">No history found.</td></tr>';
      return;
    }
    list.forEach(entry => {
      const canFocus = !(isNaN(entry.lat) || isNaN(entry.lng));
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${entry.time || ''}</td><td>${(isFinite(entry.lat) && isFinite(entry.lng)) ? (entry.lat + ',' + entry.lng) : ''}</td>
        <td><button class="view-btn"${canFocus ? ` onclick="focusOnMap(${entry.lat},${entry.lng})"` : ' disabled style="opacity:.65;"'}>View</button></td>`;
      historyTbody.appendChild(tr);
    });
  }

  function haversineKm(a, b) {
    const R = 6371;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const s = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLng / 2) ** 2;
    return 2 * R * Math.asin(Math.sqrt(s));
  }

  function computeKPIs(list) {
    if (!list || list.length < 2) {
      kpiDistanceEl.textContent = '0.00 km';
      kpiStopsEl.textContent = '0';
      return;
    }
    let dist = 0;
    for (let i = 1; i < list.length; i++) {
      const p = list[i - 1], q = list[i];
      if (isFinite(p.lat) && isFinite(p.lng) && isFinite(q.lat) && isFinite(q.lng)) {
        dist += haversineKm(p, q);
      }
    }
    // Stops detection: speed < 2km/h or almost no movement over >=5min
    let stops = 0;
    const SPEED_KMH_THRESHOLD = 2;
    const STOP_MS = 5 * 60 * 1000;
    let blockStart = null, lastPoint = null;
    for (let i = 0; i < list.length; i++) {
      const p = list[i];
      const slowOrStatic = (p.speed !== null && p.speed <= SPEED_KMH_THRESHOLD) ||
        (lastPoint && p.ts && lastPoint.ts && haversineKm(p, lastPoint) < 0.015); // ~15m drift
      if (slowOrStatic) {
        if (!blockStart) blockStart = p;
      } else {
        if (blockStart && p.ts && blockStart.ts && (p.ts - blockStart.ts >= STOP_MS)) stops++;
        blockStart = null;
      }
      lastPoint = p;
    }
    if (blockStart && lastPoint && blockStart.ts && lastPoint.ts && (lastPoint.ts - blockStart.ts >= STOP_MS)) stops++;

    kpiDistanceEl.textContent = dist.toFixed(2) + ' km';
    kpiStopsEl.textContent = String(stops);
  }

  function clearRouteLayers() {
    if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
    if (startMarker) { map.removeLayer(startMarker); startMarker = null; }
    if (endMarker) { map.removeLayer(endMarker); endMarker = null; }
  }

  function plotRoute(list) {
    if (!map || !list || !list.length) return;
    clearRouteLayers();
    const coords = list.filter(p => isFinite(p.lat) && isFinite(p.lng)).map(p => [p.lat, p.lng]);
    if (!coords.length) return;
    routeLayer = L.polyline(coords, { weight: 4, color: 'blue' }).addTo(map);
    const startIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png', iconSize: [25, 41], iconAnchor: [12, 41] });
    const endIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-2x.png', iconSize: [25, 41], iconAnchor: [12, 41] });
    startMarker = L.marker(coords[0], { icon: startIcon }).addTo(map).bindPopup('Start');
    endMarker = L.marker(coords[coords.length - 1], { icon: endIcon }).addTo(map).bindPopup('End');
    map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
  }

  function updateHeatmap(list) {
    if (!map) return;
    if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
    if (!list || !list.length || !heatToggle.checked) return;
    const heatData = list.filter(p => isFinite(p.lat) && isFinite(p.lng)).map(p => [p.lat, p.lng, 0.5]);
    if (heatData.length) heatLayer = L.heatLayer(heatData, { radius: 25 }).addTo(map);
  }

  function applyDateFilter(list) {
    const plan = localPlan.plan;
    const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
    const cutoffMs = Date.now() - policy.historyDays * 86400000;

    const hasDate = startDateInput.value || endDateInput.value;
    let s = startDateInput.value ? Date.parse(startDateInput.value + 'T00:00:00') : null;
    let e = endDateInput.value ? Date.parse(endDateInput.value + 'T23:59:59') : null;

    return (list || []).filter(p => {
      if (!p.ts) return false;
      if (p.ts < cutoffMs) return false; // plan window
      if (!hasDate) return true;
      if (s && p.ts < s) return false;
      if (e && p.ts > e) return false;
      return true;
    });
  }

  // Online / refresh / notifications
  const ONLINE_TTL_MS = 90000;
  function parseTimestampToMs(ts) {
    if (!ts) return null;
    const parts = ts.split(' ');
    if (parts.length < 2) return null;
    const [y, m, d] = parts[0].split('-').map(n => parseInt(n));
    const [hh, mm, ss] = parts[1].split(':').map(n => parseInt(n));
    return new Date(y, m - 1, d, hh, mm, ss).getTime();
  }
  function computeOnlineDisplay(flag, lastActiveStr) {
    const lastActiveMs = parseTimestampToMs(lastActiveStr);
    if (!lastActiveMs) return !!flag;
    return (Date.now() - lastActiveMs <= ONLINE_TTL_MS) && !!flag;
  }
  function renderOnlineAndLastActive(flag, lastActiveStr) {
    const isOn = computeOnlineDisplay(flag, lastActiveStr);
    onlineStatusEl.innerHTML = isOn ? '<span class="badge online">ONLINE</span>' : '<span class="badge offline">OFFLINE</span>';
    lastActiveEl.textContent = lastActiveStr || "Unknown";
    maybeNotifyStatus(isOn);
  }
  let lastActivePoller = null;
  function setRefreshIntervals(ms) {
    if (lastActivePoller) clearInterval(lastActivePoller);
    lastActivePoller = setInterval(() => {
      if (!uidGlobal) return;
      const ref = db.ref(`users/${uidGlobal}/vehicle`);
      ref.child("current/last_active").once('value').then(lastSnap => {
        const lastActive = lastSnap.val();
        ref.child("online").once('value').then(flagSnap => renderOnlineAndLastActive(flagSnap.val(), lastActive));
      });
    }, ms);
  }
  let lastOnlineState = null;
  function maybeNotifyStatus(isOnline) {
    const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
    if (!policy.notify || !('Notification' in window) || Notification.permission !== 'granted') return;
    if (lastOnlineState === null) { lastOnlineState = isOnline; return; }
    if (isOnline !== lastOnlineState) {
      new Notification("Vehicle Status", { body: isOnline ? "Vehicle is ONLINE" : "Vehicle is OFFLINE" });
      lastOnlineState = isOnline;
    }
  }
  function maybeNotifyBattery(battPercent) {
    const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
    if (!policy.notify || !('Notification' in window) || Notification.permission !== 'granted') return;
    if (typeof battPercent === 'number' && battPercent <= 20) {
      new Notification("Low Battery", { body: `Vehicle battery low (${battPercent}%)` });
    }
  }

  // Alarm toggle
  alarmToggle.addEventListener('change', () => {
    if (!uidGlobal) return;
    const ref = db.ref(`users/${uidGlobal}/vehicle/alarm`);
    ref.set(alarmToggle.checked ? "on" : "off").catch(err => console.error("Failed to set alarm:", err));
  });

  // CSV Export
  exportCSVBtn.addEventListener('click', () => {
    if (!uidGlobal) return;
    db.ref(`users/${uidGlobal}/vehicle/history`).once('value').then(snap => {
      exportHistoryCSV(snap.val());
    });
  });
  function exportHistoryCSV(histObj) {
    if (!localPlan.exportCSV) {
      showModal('CSV export is not available on your current plan. Request upgrade to Silver or Gold.', true);
      return;
    }
    if (!histObj) { alert('No history'); return; }
    const rows = [['time', 'location', 'speed']];
    Object.values(histObj).forEach(e => rows.push([e.time || '', '' + (e.location || ''), (e.speed ?? '')]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `history_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '')}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // Components rendering
  function renderComponents(obj) {
    componentsListEl.innerHTML = "";
    if (!obj || !Object.keys(obj).length) {
      componentsListEl.innerHTML = '<li class="comp-unknown">No components</li>';
      return;
    }
    for (let k in obj) {
      const v = obj[k];
      let cls = "comp-unknown";
      if (v === "ok" || v === "activity") cls = "comp-ok";
      else if (v === "no_fix" || v === "idle") cls = "comp-warn";
      else if (v === "down") cls = "comp-bad";
      componentsListEl.innerHTML += `<li class="${cls}"><strong>${k}:</strong> ${v}</li>`;
    }
  }

  // Modal controls
  function showModal(html, showUpgrade = false) {
    modalContent.innerHTML = html;
    modal.style.display = 'flex';
    modalUpgradeBtn.style.display = showUpgrade ? 'inline-block' : 'none';
  }
  modalClose.onclick = () => modal.style.display = 'none';
  modalUpgradeBtn.onclick = () => modal.style.display = 'none';

  // Geofencing with Leaflet.draw
  let drawControl, drawnItems;
  geofenceState = { lastInsideAny: null };

  function setupDrawTools() {
    if (!map) return;
    if (drawnItems) return;
    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    drawControl = new L.Control.Draw({
      position: 'topright',
      draw: {
        rectangle: true,
        polygon: true,
        circle: true,
        circlemarker: false,
        marker: false,
        polyline: false
      },
      edit: { featureGroup: drawnItems }
    });
    // Don't add control by default, enable manually when needed
  }

  gfEnableDrawBtn.onclick = () => {
    if (!map || !drawControl) return;
    if (map.hasControl) {
      map.removeControl(drawControl);
      gfEnableDrawBtn.textContent = "Add Zone";
    } else {
      map.addControl(drawControl);
      gfEnableDrawBtn.textContent = "Stop Drawing";
    }
  };

  gfSaveBtn.onclick = async () => {
    if (!uidGlobal) return;
    const plan = localPlan.plan;
    const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
    const layers = [];
    drawnItems.eachLayer(l => {
      const j = geofenceToJSON(l);
      if (j) layers.push(j);
    });
    if (plan === 'silver' && layers.length > policy.geofences) {
      alert('Silver plan allows only 1 geofence');
      return;
    }
    await db.ref(`users/${uidGlobal}/geofences`).set(layers);
    alert('Geofences saved');
  };

  gfClearBtn.onclick = () => {
    if (!drawnItems) return;
    drawnItems.clearLayers();
  };

  async function loadGeofences() {
    if (!uidGlobal || !map) return;
    const snap = await db.ref(`users/${uidGlobal}/geofences`).once('value');
    const arr = snap.val() || [];
    drawnItems.clearLayers();
    arr.forEach(obj => {
      const layer = layerFromJSON(obj);
      if (layer) drawnItems.addLayer(layer);
    });
  }

  function geofenceToJSON(layer) {
    if (layer instanceof L.Circle) {
      const c = layer.getLatLng();
      return { type: 'circle', center: [c.lat, c.lng], radius: layer.getRadius() };
    } else if (layer instanceof L.Polygon) {
      const latlngs = layer.getLatLngs()[0].map(p => [p.lat, p.lng]);
      return { type: 'polygon', points: latlngs };
    }
    return null;
  }

  function layerFromJSON(obj) {
    if (!obj) return null;
    if (obj.type === 'circle') {
      return L.circle(obj.center, { radius: obj.radius });
    }
    if (obj.type === 'polygon' && Array.isArray(obj.points)) {
      return L.polygon(obj.points);
    }
    return null;
  }

  function checkGeofence(lat, lng) {
    if (localPlan.plan === 'basic') return;
    const zones = (localPlan.plan === 'silver') ? drawnItems.getLayers().slice(0, 1) : drawnItems.getLayers();
    let insideAny = false;
    for (const layer of zones) {
      if (layer instanceof L.Circle) {
        insideAny = insideAny || map.distance([lat, lng], layer.getLatLng()) <= layer.getRadius();
      } else if (layer instanceof L.Polygon) {
        insideAny = insideAny || leafletPipPointInLayer([lat, lng], layer);
      }
    }
    if (geofenceState.lastInsideAny !== null && geofenceState.lastInsideAny && !insideAny) {
      alert('Alert: Vehicle left the geofenced area!');
    }
    geofenceState.lastInsideAny = insideAny;
  }

  function leafletPipPointInLayer(point, polygonLayer) {
    const x = point[1], y = point[0]; // lon, lat
    const poly = polygonLayer.getLatLngs()[0].map(p => [p.lng, p.lat]);
    let inside = false;
    for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
      const xi = poly[i][0], yi = poly[i][1];
      const xj = poly[j][0], yj = poly[j][1];
      const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
      if (intersect) inside = !inside;
    }
    return inside;
  }

  // Custom Marker Icon Upload
  iconUploader.onchange = e => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = evt => {
        customMarkerIcon = createLeafletIcon(evt.target.result);
        if (liveMarker) liveMarker.setIcon(customMarkerIcon);
      };
      reader.readAsDataURL(file);
    }
  };

  // Filter buttons
  applyFilterBtn.onclick = () => {
    filteredHistory = applyDateFilter(fullHistory);
    renderHistoryTable(filteredHistory);
    plotRoute(filteredHistory);
    updateHeatmap(filteredHistory);
    computeKPIs(filteredHistory);
  };
  clearFilterBtn.onclick = () => {
    startDateInput.value = '';
    endDateInput.value = '';
    filteredHistory = fullHistory;
    renderHistoryTable(filteredHistory);
    plotRoute(filteredHistory);
    updateHeatmap(filteredHistory);
    computeKPIs(filteredHistory);
  };

  // Map layer switching
  mapTypeSelect.onchange = e => {
    updateBaseLayer(e.target.value);
  };

  heatToggle.onchange = () => {
    updateHeatmap(filteredHistory);
  };

  // Auth and Data Loading
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    uidGlobal = user.uid;
    userEmailEl.textContent = user.email || user.uid;

    // Load user data, plan, upgrades, admin flag
    db.ref(`users/${uidGlobal}`).on('value', snap => {
      const udata = snap.val() || {};
      applyPlanToUI(udata);
      checkAndAutoDowngrade(uidGlobal, udata);
      if (udata.admin === true) {
        isAdmin = true;
        adminPanel.style.display = 'block';
      } else {
        isAdmin = false;
        adminPanel.style.display = 'none';
      }
    });

    // Vehicle references
    const vref = db.ref(`users/${uidGlobal}/vehicle`);

    // Current vehicle info
    vref.child('current').on('value', snap => {
      const d = snap.val();
      if (!d) return;
      if (d.latitude && d.longitude) {
        updateMap(parseFloat(d.latitude), parseFloat(d.longitude));
        locationEl.textContent = `${d.latitude}, ${d.longitude}`;
        checkGeofence(parseFloat(d.latitude), parseFloat(d.longitude));
      } else {
        locationEl.textContent = "No location";
      }
      lastActiveEl.textContent = d.last_active || "Unknown";
      statusEl.textContent = d.status || "Unknown";
      batteryHealthEl.textContent = typeof d.battery !== 'undefined' ? `${d.battery}%` : "N/A";
      maybeNotifyBattery(typeof d.battery === 'number' ? d.battery : null);
      // Optionally update popup too
      if (liveMarker) liveMarker.bindPopup(`üìç ${locationEl.textContent}`).closePopup();
    });

    // Vehicle online status
    vref.child("online").on("value", snap => {
      vref.child("current/last_active").once("value").then(s2 => renderOnlineAndLastActive(snap.val(), s2.val()));
    });

    // Last seen update
    vref.child("last_seen").on("value", s => lastSeenEl.textContent = s.val() || "N/A");

    // Alarm status
    vref.child("alarm").on("value", s => {
      const st = s.val() || "off";
      alarmToggle.checked = st === "on";
      alarmStatusText.textContent = `Alarm is ${st.toUpperCase()}`;
    });

    // Alarm last trigger
    vref.child("last_trigger").on("value", s => {
      const t = s.val();
      if (t && t.time && t.status === "alert") {
        alarmTriggerEl.innerHTML = `<span style="color:red;">‚ö†Ô∏è ${t.time} at ${t.location}</span>`;
      } else alarmTriggerEl.textContent = "No triggers";
    });

    // Components status
    vref.child("components").on("value", snap => {
      renderComponents(snap.val());
    });

    // Vehicle history
    vref.child("history").on("value", snap => {
      const rawHistory = snap.val() || {};
      fullHistory = Object.values(rawHistory).map(parseEntry).sort((a, b) => (a.ts || 0) - (b.ts || 0));
      filteredHistory = applyDateFilter(fullHistory);
      renderHistoryTable(filteredHistory);
      plotRoute(filteredHistory);
      updateHeatmap(filteredHistory);
      computeKPIs(filteredHistory);
    });

    // Admin upgrade requests
    db.ref('admin/upgrade_requests').on('value', snap => {
      if (!isAdmin) return;
      const reqs = snap.val() || {};
      adminList.innerHTML = '<table style="width:100%"><thead><tr><th>User</th><th>Plan</th><th>When</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>';
      const tbody = adminList.querySelector('tbody');
      tbody.innerHTML = '';
      Object.entries(reqs).reverse().forEach(([key, val]) => {
        const tr = document.createElement('tr');
        const when = val.request_time || '-';
        const status = val.status || '-';
        tr.innerHTML = `<td>${val.uid}</td><td>${val.requestedPlan || ''}</td><td>${when}</td><td>${status}</td><td></td>`;
        const actionsTd = tr.querySelector('td:last-child');
        if (status === 'pending') {
          const aBtn = document.createElement('button');
          aBtn.textContent = 'Approve';
          aBtn.className = 'btn btn-primary';
          aBtn.onclick = () => {
            adminApproveRequest(uidGlobal, userEmailEl.textContent || uidGlobal, key, val);
          };
          const rBtn = document.createElement('button');
          rBtn.textContent = 'Reject';
          rBtn.className = 'btn btn-danger';
          rBtn.style.marginLeft = '8px';
          rBtn.onclick = () => {
            if (!confirm('Reject this upgrade request?')) return;
            adminRejectRequest(uidGlobal, userEmailEl.textContent || uidGlobal, key, val);
          };
          actionsTd.appendChild(aBtn);
          actionsTd.appendChild(rBtn);
        } else {
          actionsTd.textContent = 'Processed';
        }
        tbody.appendChild(tr);
      });
    });

    // Admin logs
    db.ref('admin/approvals').limitToLast(50).on('value', snap => {
      if (!isAdmin) return;
      const logs = snap.val() || {};
      adminLogs.innerHTML = '<ul style="padding-left:16px;margin:0;">' +
        Object.entries(logs).reverse().map(([k, v]) =>
          `<li style="margin-bottom:6px;"><b>${v.adminName || v.adminUid || 'admin'}</b> ‚Üí ${v.uid} : ${v.plan || v.status} (${v.approvedAt || v.processedAt || v.time || ''})</li>`
        ).join('') + '</ul>';
    });

    // Load geofences for user
    setupDrawTools();
    await loadGeofences();
  });

  // Upgrade buttons
  upgradeToSilverBtn.addEventListener('click', () => {
    if (!uidGlobal) return alert('Not logged in');
    createUpgradeRequest(uidGlobal, 'silver').then(() => {
      upgradeToSilverBtn.style.display = 'none'; upgradeToGoldBtn.style.display = 'none';
      requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
    }).catch(() => { alert('Failed to send request'); });
  });
  upgradeToGoldBtn.addEventListener('click', () => {
    if (!uidGlobal) return alert('Not logged in');
    createUpgradeRequest(uidGlobal, 'gold').then(() => {
      upgradeToSilverBtn.style.display = 'none'; upgradeToGoldBtn.style.display = 'none';
      requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
    }).catch(() => { alert('Failed to send request'); });
  });

</script>
</body>
</html>
