<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Tracker Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="assets/favicon.ico"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f7f9fc;
    }
    .dashboard {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #343a40;
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
    }
    .logo { height: 40px; }
    .card {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; color: #343a40; }
    #map { height: 300px; width: 100%; border-radius: 10px; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    th, td {
      padding: 10px; text-align: left; border-bottom: 1px solid #ccc;
    }
    .switch {
      position: relative; display: inline-block; width: 60px; height: 30px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 30px;
    }
    .slider:before {
      position: absolute; content: "";
      height: 22px; width: 22px; left: 4px; bottom: 4px;
      background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .slider { background-color: #28a745; }
    input:checked + .slider:before { transform: translateX(30px); }
    .view-btn {
      background-color: #007bff; color: white; padding: 5px 12px;
      border: none; border-radius: 6px; cursor: pointer; font-size: 14px;
    }
    .view-btn:hover { background-color: #0056b3; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    #logoutBtn {
      background: #dc3545; color: white; border: none;
      padding: 6px 12px; border-radius: 6px; cursor: pointer;
    }
    /* small styles for new components/online display */
    .status-row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .badge { padding:6px 10px; border-radius:6px; font-weight:600; font-size:13px; color:#fff; }
    .badge.online { background:#28a745; }
    .badge.offline { background:#dc3545; }
    .components-list { margin-top:10px; list-style:none; padding-left:0; }
    .components-list li { padding:6px 0; border-bottom:1px dashed #eee; }
    .comp-ok { color:#28a745; font-weight:600 }
    .comp-warn { color:#e67700; font-weight:600 }
    .comp-bad { color:#c82333; font-weight:600 }
    .comp-unknown { color:#6c757d; font-weight:600 }

    /* Subscription / earnings layout */
    .subscription-row { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .small-muted { color:#6c757d; font-size:13px; }
    #exportCSVBtn { background:#17a2b8; color:white; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
    #requestUpgradeBtn { background:#ffc107; color:#212529; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
    .earning-card { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    .earning-actions button { margin-left:8px; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <img src="assets/logo.png" alt="Logo" class="logo"/>
      <h1>Smart Tracker</h1>
      <div class="user-info">
        <span id="userEmail">Loading...</span>
        <button id="logoutBtn">Logout</button>
      </div>
    </header>

    <!-- Status card (existing) -->
    <section class="card status-card">
      <h2>üîç Live Status</h2>

      <div class="status-row">
        <div><strong>Online:</strong> <span id="onlineStatus"><span class="badge offline">Checking...</span></span></div>
        <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
      </div>

      <p><strong>Location:</strong> <span id="location">Loading...</span></p>
      <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
      <p><strong>Alarm Last Trigger:</strong> <span id="alarmTrigger">No triggers</span></p>

      <div id="componentsBlock">
        <h4>Components</h4>
        <ul id="componentsList" class="components-list">
          <li class="comp-unknown">No data</li>
        </ul>
      </div>
    </section>

    <!-- Alarm card (existing) -->
    <section class="card alarm-card">
      <h2>üîî Alarm</h2>
      <label class="switch">
        <input type="checkbox" id="alarmToggle">
        <span class="slider round"></span>
      </label>
      <p id="alarmStatusText">Loading alarm status...</p>
    </section>

    <!-- Subscription & earnings card (NEW) -->
    <section class="card subscription-card">
      <h2>üí≥ Subscription & Upgrades</h2>
      <div class="subscription-row">
        <div>
          <p>Current Plan: <strong id="currentPlan">Loading...</strong></p>
          <p class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></p>
          <p class="small-muted">CSV Export: <span id="csvAllowed">-</span></p>
        </div>

        <div id="subscriptionActions">
          <button id="requestUpgradeBtn">Request Upgrade</button>
          <button id="cancelUpgradeBtn" style="display:none; background:#6c757d; color:white; padding:6px 10px; border:none; border-radius:6px; cursor:pointer;">Cancel Request</button>
        </div>
      </div>

      <div id="upgradeStatus" style="margin-top:8px;color:#333;">&nbsp;</div>

      <hr style="margin:12px 0;">

      <div class="earning-card">
        <div>
          <h4>More earning models / Upsells</h4>
          <p class="small-muted">Add paid features later: extra vehicle slots, extended history retention, one-time CSV export for basic users, premium alerts, analytics.</p>
        </div>
        <div class="earning-actions">
          <!-- Placeholder actions - wire these to payment processors later -->
          <button id="buyOneTimeExportBtn" style="background:#007bff;color:#fff;">Buy CSV Export</button>
          <button id="buyExtraVehicleBtn" style="background:#28a745;color:#fff;">Buy +1 Vehicle</button>
        </div>
      </div>
    </section>

    <!-- Map card (existing) -->
    <section class="card map-card">
      <h2>üóº Live Map</h2>
      <div id="map">Loading map...</div>
    </section>

    <!-- History card (existing) + CSV export control (NEW) -->
    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><small class="small-muted">Recent movements are shown below.</small></div>
        <div>
          <button id="exportCSVBtn" style="display:none;">Export CSV</button>
        </div>
      </div>

      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // ===========================
    // Existing Firebase config
    // ===========================
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // ===========================
    // DOM refs
    // ===========================
    const locationEl = document.getElementById("location");
    const lastActiveEl = document.getElementById("lastActive");
    const statusEl = document.getElementById("status");
    const batteryHealthEl = document.getElementById("batteryHealth");
    const historyEl = document.getElementById("history");
    const alarmToggle = document.getElementById("alarmToggle");
    const alarmStatusText = document.getElementById("alarmStatusText");
    const alarmTriggerEl = document.getElementById("alarmTrigger");

    // new DOM refs
    const onlineStatusEl = document.getElementById("onlineStatus");
    const lastSeenEl = document.getElementById("lastSeen");
    const componentsListEl = document.getElementById("componentsList");
    const currentPlanEl = document.getElementById("currentPlan");
    const vehicleLimitEl = document.getElementById("vehicleLimit");
    const csvAllowedEl = document.getElementById("csvAllowed");
    const requestUpgradeBtn = document.getElementById("requestUpgradeBtn");
    const cancelUpgradeBtn = document.getElementById("cancelUpgradeBtn");
    const upgradeStatusEl = document.getElementById("upgradeStatus");
    const exportCSVBtn = document.getElementById("exportCSVBtn");
    const buyOneTimeExportBtn = document.getElementById("buyOneTimeExportBtn");
    const buyExtraVehicleBtn = document.getElementById("buyExtraVehicleBtn");

    let map, marker;
    const ONLINE_TTL_MS = 90000;        // must match NodeMCU ONLINE_TTL_MS
    const LAST_ACTIVE_POLL_MS = 30000;  // update every 30 seconds
    let uidGlobal = null;

    // local cached plan info for enforcement
    let localPlan = { plan: 'basic', vehicle_limit: 1, exportCSV: false };

    // ===========================
    // small helpers
    // ===========================
    function updateMap(lat, lng, popupText = null) {
      if (!lat || !lng) return;
      if (!map) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
      } else {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng], 15);
      }
      if (popupText) marker.bindPopup(popupText).openPopup();
    }

    function focusOnMap(lat, lng) {
      updateMap(lat, lng, `üìç History Location<br>${lat}, ${lng}`);
    }

    function renderComponents(obj) {
      componentsListEl.innerHTML = "";
      if (!obj) {
        componentsListEl.innerHTML = '<li class="comp-unknown">No data</li>';
        return;
      }
      const order = Object.keys(obj);
      if (order.length === 0) {
        componentsListEl.innerHTML = '<li class="comp-unknown">No components</li>';
        return;
      }
      order.forEach(k => {
        const v = obj[k];
        let cls = "comp-unknown";
        if (v === "ok" || v === "activity") cls = "comp-ok";
        else if (v === "no_fix" || v === "idle") cls = "comp-warn";
        else if (v === "down") cls = "comp-bad";
        componentsListEl.innerHTML += `<li class="${cls}"><strong>${k}:</strong> ${v}</li>`;
      });
    }

    // parse "YYYY-MM-DD HH:MM:SS" into milliseconds (local timezone)
    function parseTimestampToMs(ts) {
      if (!ts || typeof ts !== 'string') return null;
      const parts = ts.trim().split(' ');
      if (parts.length < 2) {
        const fallback = Date.parse(ts);
        return isNaN(fallback) ? null : fallback;
      }
      const dateParts = parts[0].split('-');
      const timeParts = parts[1].split(':');
      if (dateParts.length < 3 || timeParts.length < 3) return null;
      const y = parseInt(dateParts[0], 10);
      const m = parseInt(dateParts[1], 10) - 1;
      const d = parseInt(dateParts[2], 10);
      const hh = parseInt(timeParts[0], 10);
      const mm = parseInt(timeParts[1], 10);
      const ss = parseInt(timeParts[2], 10);
      const dt = new Date(y, m, d, hh, mm, ss);
      return dt.getTime();
    }

    function computeOnlineDisplay(firebaseOnlineFlag, lastActiveStr) {
      const lastActiveMs = parseTimestampToMs(lastActiveStr);
      if (!lastActiveMs) {
        return !!firebaseOnlineFlag;
      }
      const age = Date.now() - lastActiveMs;
      if (age > ONLINE_TTL_MS) {
        return false;
      }
      return !!firebaseOnlineFlag;
    }

    function renderOnlineAndLastActive(firebaseOnlineFlag, lastActiveStr) {
      const isOnline = computeOnlineDisplay(firebaseOnlineFlag, lastActiveStr);
      if (isOnline) {
        onlineStatusEl.innerHTML = '<span class="badge online">ONLINE</span>';
      } else {
        onlineStatusEl.innerHTML = '<span class="badge offline">OFFLINE</span>';
      }
      lastActiveEl.textContent = lastActiveStr || "Unknown";
    }

    // ===========================
    // Plan / subscription helper functions
    // ===========================
    function applyPlanToUI(planObj) {
      // planObj = { plan: "basic"|"premium", vehicle_limit: number, exportCSV: boolean }
      localPlan = Object.assign({}, localPlan, planObj || {});
      currentPlanEl.textContent = (localPlan.plan || 'basic').toUpperCase();
      vehicleLimitEl.textContent = localPlan.vehicle_limit || 1;
      csvAllowedEl.textContent = (localPlan.exportCSV ? 'Allowed' : 'Not allowed');

      // control upgrade button visibility & text
      if ((localPlan.plan || 'basic') === 'premium') {
        requestUpgradeBtn.style.display = 'none';
        cancelUpgradeBtn.style.display = 'none';
        upgradeStatusEl.textContent = 'You are on the PREMIUM plan.';
      } else {
        requestUpgradeBtn.style.display = 'inline-block';
      }

      // export button visibility
      exportCSVBtn.style.display = localPlan.exportCSV ? 'inline-block' : 'none';
    }

    function showUpgradeStatusText(status) {
      if (!status) {
        upgradeStatusEl.textContent = '';
        return;
      }
      const s = status.toLowerCase();
      if (s === 'pending') {
        upgradeStatusEl.textContent = 'Upgrade request pending approval by admin.';
        requestUpgradeBtn.style.display = 'none';
        cancelUpgradeBtn.style.display = 'inline-block';
      } else if (s === 'approved') {
        upgradeStatusEl.textContent = 'Upgrade approved. Your plan has been updated.';
        requestUpgradeBtn.style.display = 'none';
        cancelUpgradeBtn.style.display = 'none';
      } else if (s === 'rejected') {
        upgradeStatusEl.textContent = 'Upgrade request rejected by admin.';
        requestUpgradeBtn.style.display = 'inline-block';
        cancelUpgradeBtn.style.display = 'none';
      } else {
        upgradeStatusEl.textContent = `Upgrade status: ${status}`;
      }
    }

    // ===========================
    // History rendering with plan enforcement
    // ===========================
    // If plan is basic -> show only 1 most recent record.
    function renderHistoryWithPlan(historyObj) {
      historyEl.innerHTML = '';
      if (!historyObj) {
        historyEl.innerHTML = '<tr><td colspan="3">No history found.</td></tr>';
        return;
      }
      // convert object to array with stable ordering: we'll use keys->values
      const entries = Object.values(historyObj).slice().reverse(); // most recent first
      let toShow = entries;
      if (!localPlan.exportCSV) {
        // basic mode: limit to 1
        toShow = entries.slice(0, 1);
      }
      if (!toShow.length) {
        historyEl.innerHTML = '<tr><td colspan="3">No history found.</td></tr>';
        return;
      }
      toShow.forEach(entry => {
        const loc = entry.location || '';
        const time = entry.time || '';
        const [lat, lng] = (loc && loc.split(',')) || [0,0];
        const safeLat = parseFloat(lat) || 0;
        const safeLng = parseFloat(lng) || 0;
        historyEl.innerHTML += `
          <tr>
            <td>${time}</td>
            <td>${loc}</td>
            <td><button class="view-btn" onclick="focusOnMap(${safeLat}, ${safeLng})">View</button></td>
          </tr>`;
      });
    }

    // ===========================
    // CSV Export
    // ===========================
    function exportHistoryToCSV(historyObj) {
      if (!localPlan.exportCSV) {
        alert('CSV export not allowed on your plan. Upgrade to enable this feature.');
        return;
      }
      if (!historyObj) {
        alert('No history to export.');
        return;
      }
      // flatten entries into CSV lines
      const rows = [];
      rows.push(['time','location','latitude','longitude']);
      const entries = Object.values(historyObj);
      entries.forEach(e => {
        const time = e.time || '';
        const loc = e.location || '';
        const [lat, lng] = loc.split(',').map(s => s ? s.trim() : '');
        rows.push([time, loc, lat || '', lng || '']);
      });
      // convert to CSV string
      const csvContent = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      // create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date();
      const filename = `history_${now.toISOString().slice(0,19).replace(/[:T]/g,'')}.csv`;
      a.setAttribute('download', filename);
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ===========================
    // Upgrade request flow
    // ===========================
    requestUpgradeBtn.addEventListener('click', () => {
      if (!uidGlobal) return alert('Not logged in');
      const now = new Date().toISOString();
      // set user's upgrade_request to pending
      db.ref(`users/${uidGlobal}/upgrade_request`).set({
        status: 'pending',
        request_time: now
      }).then(() => {
        // duplicate a minimal request in admin node so admin panel can list all requests easily
        const adminReqKey = `${uidGlobal}_${Date.now()}`;
        db.ref(`admin/upgrade_requests/${adminReqKey}`).set({
          uid: uidGlobal,
          request_time: now,
          requested_plan: 'premium',
          status: 'pending'
        });
        upgradeStatusEl.textContent = 'Upgrade Request Sent (Pending Approval)';
        requestUpgradeBtn.style.display = 'none';
        cancelUpgradeBtn.style.display = 'inline-block';
      }).catch(err => {
        console.error('Failed to send upgrade request:', err);
        alert('Failed to send upgrade request. Try again later.');
      });
    });

    cancelUpgradeBtn.addEventListener('click', () => {
      if (!uidGlobal) return;
      // cancel user's upgrade request
      db.ref(`users/${uidGlobal}/upgrade_request/status`).set('cancelled').then(() => {
        // Optionally remove admin request: here we mark status cancelled (admin must clean up)
        // Admin node may contain duplicate entries; we won't try to find & remove them here to avoid dangerous writes.
        upgradeStatusEl.textContent = 'Upgrade request cancelled.';
        requestUpgradeBtn.style.display = 'inline-block';
        cancelUpgradeBtn.style.display = 'none';
      }).catch(err => {
        console.error('Failed to cancel upgrade request', err);
        alert('Failed to cancel request.');
      });
    });

    // Placeholders for upsell actions - to wire to payments later
    buyOneTimeExportBtn.addEventListener('click', () => {
      alert('Buy CSV Export: payment integration placeholder. Implement your payment flow (e.g., Razorpay/Stripe) and on success set users/{uid}/exportCSV to true for a limited time.');
    });
    buyExtraVehicleBtn.addEventListener('click', () => {
      alert('Buy Extra Vehicle: payment integration placeholder. Implement a payment flow and on success increment users/{uid}/vehicle_limit.');
    });

    // Export button click (we need to fetch the history snapshot first)
    exportCSVBtn.addEventListener('click', () => {
      if (!uidGlobal) return alert('Not logged in.');
      const histRef = db.ref(`users/${uidGlobal}/vehicle/history`);
      histRef.once('value').then(snap => {
        const hist = snap.val();
        exportHistoryToCSV(hist);
      }).catch(err => {
        console.error('CSV export failed', err);
        alert('Failed to export CSV.');
      });
    });

    // ===========================
    // Dashboard loader
    // ===========================
    function startLastActivePoll(uid) {
      if (!uid) return;
      const currentRef = db.ref(`users/${uid}/vehicle/current/last_active`);
      setInterval(() => {
        currentRef.once('value').then(snap => {
          const lastActive = snap.val();
          db.ref(`users/${uid}/vehicle/online`).once('value').then(onlineSnap => {
            const onlineFlag = onlineSnap.val();
            renderOnlineAndLastActive(onlineFlag, lastActive);
          });
        });
      }, LAST_ACTIVE_POLL_MS);
    }

    function loadDashboard(uid) {
      uidGlobal = uid;
      const vehicleRef = db.ref(`users/${uid}/vehicle`);

      // load user's plan details (subscribe to changes)
      const userPlanRef = db.ref(`users/${uid}`);
      userPlanRef.on('value', snap => {
        const udata = snap.val() || {};
        // default plan values if missing
        const planObj = {
          plan: (udata.plan || 'basic'),
          vehicle_limit: (udata.vehicle_limit || 1),
          exportCSV: !!udata.exportCSV
        };
        applyPlanToUI(planObj);

        // reflect upgrade_request status UI
        if (udata.upgrade_request && udata.upgrade_request.status) {
          showUpgradeStatusText(udata.upgrade_request.status);
        } else {
          showUpgradeStatusText(null);
        }
      });

      // current block (existing behavior retained)
      vehicleRef.child("current").on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        const { latitude, longitude, status, last_active, battery } = data;

        if (typeof latitude !== 'undefined' && typeof longitude !== 'undefined') {
          locationEl.textContent = `${latitude}, ${longitude}`;
          updateMap(latitude, longitude);
        } else {
          locationEl.textContent = "No location";
        }

        lastActiveEl.textContent = last_active || "Unknown";
        statusEl.textContent = status || "Unknown";
        batteryHealthEl.textContent = (typeof battery !== 'undefined') ? `${battery}%` : "N/A";

        vehicleRef.child("online").once("value").then(onlineSnap => {
          const onlineFlag = onlineSnap.val();
          renderOnlineAndLastActive(onlineFlag, last_active);
        });
      });

      // history block (enforced by plan on render)
      vehicleRef.child("history").on("value", (snapshot) => {
        const history = snapshot.val();
        // Enforce plan when rendering (basic -> only latest; premium -> all)
        renderHistoryWithPlan(history);
      });

      // components block
      vehicleRef.child("components").on("value", (snapshot) => {
        const comps = snapshot.val();
        renderComponents(comps);
      });

      // online flag listener
      vehicleRef.child("online").on("value", (snapshot) => {
        const onlineFlag = snapshot.val();
        vehicleRef.child("current/last_active").once("value").then(snap => {
          const lastActive = snap.val();
          renderOnlineAndLastActive(onlineFlag, lastActive);
        });
      });

      // last_seen
      vehicleRef.child("last_seen").on("value", (snapshot) => {
        const lastSeenVal = snapshot.val();
        lastSeenEl.textContent = lastSeenVal || "N/A";
      });

      // alarm value (toggle UI)
      vehicleRef.child("alarm").on("value", (snapshot) => {
        const status = snapshot.val() || "off";
        alarmToggle.checked = (status === "on");
        alarmStatusText.textContent = `Alarm is ${status.toUpperCase()}`;
      });

      // last_trigger
      vehicleRef.child("last_trigger").on("value", (snapshot) => {
        const trigger = snapshot.val();
        if (trigger && trigger.time && trigger.status === "alert") {
          alarmTriggerEl.innerHTML = `<span style="color: red;">‚ö†Ô∏è ${trigger.time} at ${trigger.location}</span>`;
        } else {
          alarmTriggerEl.textContent = "No triggers";
        }
      });

      // status node
      vehicleRef.child("current/status").on("value", (snapshot) => {
        const s = snapshot.val();
        if (s) statusEl.textContent = s;
      });

      // allow operator to toggle alarm from web UI
      alarmToggle.addEventListener("change", () => {
        const newState = alarmToggle.checked ? "on" : "off";
        vehicleRef.child("alarm").set(newState).catch(err => {
          console.error("Failed to set alarm:", err);
        });
      });

      // start periodic poll for last_active
      startLastActivePoll(uid);
    }

    // ===========================
    // Auth state
    // ===========================
    auth.onAuthStateChanged((user) => {
      if (user) {
        loadDashboard(user.uid);
        document.getElementById("userEmail").textContent = user.email;
        document.getElementById("logoutBtn").onclick = () => auth.signOut();
      } else {
        window.location.href = "login.html";
      }
    });

    // Expose focusOnMap to global scope (used by inline onclick)
    window.focusOnMap = focusOnMap;

    // ===========================
    // Admin notes (for implementer)
    // ===========================
    /*
      Admin panel MUST:
      - Listen to admin/upgrade_requests to view pending requests.
      - On approve, update user's nodes:
          users/{uid}/plan = "premium"
          users/{uid}/vehicle_limit = 3
          users/{uid}/exportCSV = true
          users/{uid}/upgrade_request/status = "approved"
        Optionally set an expiry if this is a paid upgrade.
      - On rejection set users/{uid}/upgrade_request/status = "rejected" (and optionally admin/upgrade_requests/{key}/status = "rejected")
    */

    // ===========================
    // Additional enforcement example (when adding new vehicles)
    // ===========================
    // If you have UI to add vehicles, check user's vehicle_limit before creating.
    // Example (not wired to any button here):
    async function canCreateNewVehicle(uid) {
      const uSnap = await db.ref(`users/${uid}`).once('value');
      const u = uSnap.val() || {};
      const limit = u.vehicle_limit || 1;
      // count existing vehicles (if you store vehicles under users/{uid}/vehicles)
      const vehiclesSnap = await db.ref(`users/${uid}/vehicles`).once('value');
      const count = vehiclesSnap.exists() ? Object.keys(vehiclesSnap.val() || {}).length : 0;
      return count < limit;
    }

  </script>
</body>
</html>
