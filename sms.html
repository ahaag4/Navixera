<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Smart Tracker ‚Äî Subscription + Admin</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    /* --- basic styles (kept consistent with previous UI) --- */
    body { font-family: Arial, sans-serif; margin:0; background:#f7f9fc; color:#222; }
    .dashboard { max-width:1100px; margin:18px auto; padding:18px; }
    header { display:flex; align-items:center; gap:12px; justify-content:space-between; background:#343a40; color:#fff; padding:12px 20px; border-radius:10px; }
    .logo { height:40px; }
    .card { background:#fff; padding:16px; margin:18px 0; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    h2 { margin:0 0 8px 0; color:#343a40; }
    .plan-pill { padding:6px 10px; border-radius:8px; background:#f2f2f2; font-weight:700; }
    .ad-banner { width:100%; height:60px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:8px; margin-top:12px; color:#333; font-weight:700; }
    .interstitial { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:9999; }
    .interstitial .card { width:86%; max-width:420px; text-align:center; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; }
    .btn-primary { background:#007bff; color:#fff; }
    .btn-warning { background:#ffc107; color:#212529; }
    .btn-danger { background:#dc3545; color:#fff; }
    .btn-ghost { background:transparent; border:1px solid #ddd; }
    .small-muted { color:#6c757d; font-size:13px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th,td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    .view-btn { background:#007bff; color:#fff; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
    .admin-panel { margin-top:12px; }
    .pending-pill { background:#ffd966; color:#4a2900; padding:6px 10px; border-radius:6px; font-weight:700; }
    .approved-pill { background:#d4edda; color:#155724; padding:6px 10px; border-radius:6px; font-weight:700; }
    .rejected-pill { background:#f8d7da; color:#721c24; padding:6px 10px; border-radius:6px; font-weight:700; }
    #modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:10000; }
    #modal .dialog { background:#fff; padding:18px; border-radius:10px; width:92%; max-width:520px; }
  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="assets/logo.png" alt="Logo" class="logo"/>
        <div>
          <div style="font-size:20px;font-weight:700;">Smart Tracker</div>
          <div style="font-size:12px;color:#ddd;">Vehicle tracking & fleet dashboard</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="userEmail" class="small-muted">Loading...</div>
        <div id="planPill" class="plan-pill">‚Äî</div>
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </header>

    <!-- Ad area -->
    <div id="adArea" class="ad-banner">Ad placeholder</div>

    <!-- Status card -->
    <section class="card status-card">
      <h2>üîç Live Status</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <div><strong>Online:</strong> <span id="onlineStatus">Checking...</span></div>
        <div><strong>Last seen:</strong> <span id="lastSeen">N/A</span></div>
      </div>
      <p><strong>Location:</strong> <span id="location">Loading...</span></p>
      <p><strong>Last Active:</strong> <span id="lastActive">Loading...</span></p>
      <p><strong>Status:</strong> <span id="status">Loading...</span></p>
      <p><strong>Battery Health:</strong> <span id="batteryHealth">Loading...</span></p>
    </section>

    <!-- Subscription + upgrade request -->
    <section class="card subscription-card">
      <h2>üí≥ Subscription & Upgrades</h2>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div>Plan: <strong id="currentPlan">Loading</strong></div>
        <div class="small-muted">Expiry: <span id="planExpiry">-</span></div>
        <div class="small-muted">Vehicle limit: <span id="vehicleLimit">-</span></div>

        <div style="margin-left:auto;">
          <button id="upgradeToSilver" class="btn btn-warning">Request Silver (‚Çπ149/mo)</button>
          <button id="upgradeToGold" class="btn btn-primary">Request Gold (‚Çπ249/mo)</button>
        </div>
      </div>

      <div style="margin-top:10px;">
        <span id="requestStatusArea"></span>
      </div>

      <div style="margin-top:12px;" class="small-muted">
        Plans: Basic (24h history, ads) ‚Ä¢ Silver (7d history, limited ads, CSV export) ‚Ä¢ Gold (90d, no ads, CSV & analytics)
      </div>
    </section>

    <!-- Map -->
    <section class="card map-card">
      <h2>üó∫ Live Map</h2>
      <div id="map" style="height:300px;border-radius:8px;">Loading map...</div>
    </section>

    <!-- History -->
    <section class="card history-card">
      <h2>üìà Movement History</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div class="small-muted">Recent movements</div>
        <div>
          <button id="exportCSVBtn" class="btn btn-primary" style="display:none;">Export CSV</button>
        </div>
      </div>
      <table>
        <thead><tr><th>Time</th><th>Location</th><th>Map</th></tr></thead>
        <tbody id="history"><tr><td colspan="3">Loading...</td></tr></tbody>
      </table>
    </section>

    <!-- Admin panel (visible only to admin users) -->
    <section id="adminPanel" class="card admin-panel" style="display:none;">
      <h2>üîß Admin Panel ‚Äî Upgrade Requests</h2>
      <div id="adminList">Loading admin data‚Ä¶</div>
      <hr/>
      <h3>Recent admin logs</h3>
      <div id="adminLogs">Loading logs‚Ä¶</div>
    </section>
  </div>

  <!-- Interstitial -->
  <div id="interstitial" class="interstitial"><div class="card"><h3>Ad (simulated)</h3><p>Will close in 3s...</p></div></div>

  <!-- Modal for upsell/info -->
  <div id="modal"><div class="dialog"><div id="modalContent"></div><div style="margin-top:12px;text-align:right;"><button id="modalClose" class="btn btn-ghost">Close</button><button id="modalUpgradeBtn" class="btn btn-primary" style="display:none;">Request Upgrade</button></div></div></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
  /*****************************************************************
   * Full dashboard + upgrade request + admin approve/reject
   * IMPORTANT: Client-side enforcement only ‚Äî add server-side rules/webhooks for production.
   *****************************************************************/

  // ---------- Firebase config (same as before) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // ---------- DOM refs ----------
  const userEmailEl = document.getElementById('userEmail');
  const planPill = document.getElementById('planPill');
  const adArea = document.getElementById('adArea');
  const interstitial = document.getElementById('interstitial');

  const currentPlanEl = document.getElementById('currentPlan');
  const planExpiryEl = document.getElementById('planExpiry');
  const vehicleLimitEl = document.getElementById('vehicleLimit');
  const upgradeToSilverBtn = document.getElementById('upgradeToSilver');
  const upgradeToGoldBtn = document.getElementById('upgradeToGold');
  const requestStatusArea = document.getElementById('requestStatusArea');

  const historyTbody = document.getElementById('history');
  const exportCSVBtn = document.getElementById('exportCSVBtn');

  const adminPanel = document.getElementById('adminPanel');
  const adminList = document.getElementById('adminList');
  const adminLogs = document.getElementById('adminLogs');

  const modal = document.getElementById('modal');
  const modalContent = document.getElementById('modalContent');
  const modalClose = document.getElementById('modalClose');
  const modalUpgradeBtn = document.getElementById('modalUpgradeBtn');

  let uidGlobal = null;
  let isAdmin = false;
  let localPlan = { plan:'basic', plan_expiry:null, vehicle_limit:1, exportCSV:false };

  // ---------- Plan policies ----------
  const PLAN_POLICIES = {
    basic: { historyDays:1, ads:'banner+interstitial', vehicle_limit:1, exportCSV:false },
    silver: { historyDays:7, ads:'banner-limited', vehicle_limit:3, exportCSV:true },
    gold: { historyDays:90, ads:'no-ads', vehicle_limit:3, exportCSV:true }
  };

  // ---------- small helpers ----------
  function prettyTS(iso) { if(!iso) return '-'; try{ return new Date(iso).toLocaleString(); } catch(e){ return iso; } }

  function applyPlanToUI(udata) {
    const plan = udata.plan || 'basic';
    const plan_expiry = udata.plan_expiry || null;
    const vehicle_limit = (udata.vehicle_limit || PLAN_POLICIES[plan].vehicle_limit);
    const exportCSV = (typeof udata.exportCSV === 'boolean') ? udata.exportCSV : !!PLAN_POLICIES[plan].exportCSV;

    localPlan = { plan, plan_expiry, vehicle_limit, exportCSV };

    planPill.textContent = plan.toUpperCase();
    currentPlanEl.textContent = plan.toUpperCase();
    planExpiryEl.textContent = prettyTS(plan_expiry);
    vehicleLimitEl.textContent = vehicle_limit;
    exportCSVBtn.style.display = exportCSV ? 'inline-block' : 'none';

    // Ads render
    renderAdsForPlan(plan);

    // If there's a pending upgrade_request, show pending UI
    const req = udata.upgrade_request || null;
    renderRequestUI(req);
  }

  function renderAdsForPlan(plan) {
    const policy = PLAN_POLICIES[plan] || PLAN_POLICIES.basic;
    if (policy.ads === 'no-ads') {
      adArea.style.display = 'none';
    } else {
      adArea.style.display = 'flex';
      adArea.textContent = policy.ads === 'banner-limited' ? 'Limited banner ad (Silver)' : 'Banner ad (Basic)';
    }
  }

  // ---------- Upgrade request UI logic ----------
  function renderRequestUI(upgradeRequest) {
    // upgradeRequest: { status: 'pending'|'approved'|'rejected'|null, requestedPlan: 'silver'|'gold', request_time: ISO }
    if (!upgradeRequest || !upgradeRequest.status) {
      // normal -> show upgrade buttons
      requestStatusArea.innerHTML = '';
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      return;
    }

    const s = upgradeRequest.status;
    if (s === 'pending') {
      // hide upgrade buttons; show pending message
      upgradeToSilverBtn.style.display = 'none';
      upgradeToGoldBtn.style.display = 'none';
      requestStatusArea.innerHTML = `<span class="pending-pill">Upgrade to ${upgradeRequest.requestedPlan?.toUpperCase() || ''} ‚Äî PENDING APPROVAL</span>`;
    } else if (s === 'approved') {
      upgradeToSilverBtn.style.display = 'none';
      upgradeToGoldBtn.style.display = 'none';
      requestStatusArea.innerHTML = `<span class="approved-pill">Upgrade approved ‚Äî Enjoy your ${upgradeRequest.requestedPlan?.toUpperCase() || ''} plan</span>`;
    } else if (s === 'rejected') {
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      requestStatusArea.innerHTML = `<span class="rejected-pill">Upgrade request rejected ‚Äî you may try again</span>`;
    } else if (s === 'cancelled') {
      upgradeToSilverBtn.style.display = 'inline-block';
      upgradeToGoldBtn.style.display = 'inline-block';
      requestStatusArea.innerHTML = `<span class="small-muted">Upgrade request cancelled</span>`;
    }
  }

  // ---------- request actions ----------
  function createUpgradeRequest(uid, desiredPlan) {
    // writes user's upgrade_request and creates an admin entry at admin/upgrade_requests
    const now = new Date().toISOString();
    const req = { status:'pending', requestedPlan:desiredPlan, request_time:now };
    const updates = {};
    updates[`users/${uid}/upgrade_request`] = req;
    const adminKey = `req_${uid}_${Date.now()}`;
    updates[`admin/upgrade_requests/${adminKey}`] = { uid, requestedPlan: desiredPlan, status:'pending', request_time: now };
    // Do a multi-path update
    return db.ref().update(updates);
  }

  function cancelUpgradeRequest(uid) {
    return db.ref(`users/${uid}/upgrade_request/status`).set('cancelled');
  }

  // ---------- Admin functions (approve/reject) ----------
  async function adminApproveRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    // adminReqObj: { uid, requestedPlan, status, request_time }
    const targetUid = adminReqObj.uid;
    const plan = adminReqObj.requestedPlan || 'silver';
    const now = new Date();
    const expiry = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000)); // 30 days
    // Prepare updates:
    const updates = {};
    updates[`users/${targetUid}/plan`] = plan;
    updates[`users/${targetUid}/plan_expiry`] = expiry.toISOString();
    updates[`users/${targetUid}/vehicle_limit`] = PLAN_POLICIES[plan].vehicle_limit;
    updates[`users/${targetUid}/exportCSV`] = true;
    updates[`users/${targetUid}/upgrade_request/status`] = 'approved';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'approved';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, plan, approvedAt: new Date().toISOString(), note:'approved_via_admin_panel' };
    // update in one go
    await db.ref().update(updates);
    // Optionally notify user (push notification / email) - left as integration point
  }

  async function adminRejectRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const updates = {};
    updates[`users/${targetUid}/upgrade_request/status`] = 'rejected';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'rejected';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, status:'rejected', processedAt: new Date().toISOString(), note:'rejected_via_admin_panel' };
    await db.ref().update(updates);
  }

  // ---------- Auto-downgrade (expiry watcher) ----------
  function checkAndAutoDowngrade(uid, udata) {
    if (!udata) return;
    if (!udata.plan || !udata.plan_expiry) return;
    const expiryMs = Date.parse(udata.plan_expiry);
    if (isNaN(expiryMs)) return;
    if (Date.now() >= expiryMs && udata.plan !== 'basic') {
      // perform downgrade
      const updates = {
        [`users/${uid}/plan`]: 'basic',
        [`users/${uid}/plan_expiry`]: null,
        [`users/${uid}/vehicle_limit`]: PLAN_POLICIES.basic.vehicle_limit,
        [`users/${uid}/exportCSV`]: false
      };
      db.ref().update(updates).then(() => {
        const k = `downgrade_${uid}_${Date.now()}`;
        db.ref(`admin/downgrades/${k}`).set({ uid, old_plan:udata.plan, new_plan:'basic', time:new Date().toISOString(), reason:'expired_auto_downgrade' });
        // UI updates will be handled by on('value') listeners
      }).catch(err => console.error('downgrade failed',err));
    }
  }

  // ---------- History render (plan enforcement) ----------
  function renderHistory(historyObj) {
    historyTbody.innerHTML = '';
    if (!historyObj) {
      historyTbody.innerHTML = '<tr><td colspan="3">No history found.</td></tr>';
      return;
    }
    const entries = Object.values(historyObj).slice().reverse(); // most recent first
    const policy = PLAN_POLICIES[localPlan.plan] || PLAN_POLICIES.basic;
    const cutoffMs = Date.now() - policy.historyDays * 24*60*60*1000;

    // filter entries that are within window
    const visible = entries.filter(e => {
      if (!e.time) return false;
      const tms = Date.parse(e.time);
      if (!isNaN(tms)) return tms >= cutoffMs;
      // fallback for "YYYY-MM-DD HH:MM:SS"
      const parts = (e.time || '').split(' ');
      if (parts.length>=2) {
        const d = parts[0].split('-'), tm = parts[1].split(':');
        if (d.length===3 && tm.length===3) {
          const dt = new Date(parseInt(d[0]),parseInt(d[1])-1,parseInt(d[2]),parseInt(tm[0]),parseInt(tm[1]),parseInt(tm[2]));
          return dt.getTime() >= cutoffMs;
        }
      }
      return false;
    });

    if (visible.length === 0) {
      historyTbody.innerHTML = '<tr><td colspan="3">No history available within your plan window.</td></tr>';
      return;
    }

    visible.forEach(entry => {
      const loc = entry.location || '';
      const time = entry.time || '';
      const [lat,lng] = (loc.split(',') || [0,0]).map(s=>s.trim());
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${time}</td><td>${loc}</td><td><button class="view-btn">View</button></td>`;
      tr.querySelector('.view-btn').addEventListener('click', ()=>{
        const tms = Date.parse(time);
        if (!isNaN(tms) && tms < cutoffMs) {
          // older than allowed (shouldn't happen because we filtered) ‚Äî upsell
          showModal(`This record is older than your plan allows. Upgrade to see more history.`, true);
        } else {
          focusOnMap(parseFloat(lat)||0, parseFloat(lng)||0);
        }
      });
      historyTbody.appendChild(tr);
    });
  }

  // ---------- CSV export ----------
  function exportHistoryCSV(histObj) {
    if (!localPlan.exportCSV) {
      showModal('CSV export is not available on your current plan. Request upgrade to Silver or Gold.', true);
      return;
    }
    if (!histObj) { alert('No history'); return; }
    const rows=[['time','location']];
    Object.values(histObj).forEach(e=>rows.push([e.time||'',''+(e.location||'')]));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download = `history_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'')}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ---------- Map helpers (Leaflet) ----------
  let map, marker;
  function updateMap(lat,lng,popup){
    if(!lat||!lng) return;
    if(!map){ map = L.map('map').setView([lat,lng],14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); marker = L.marker([lat,lng]).addTo(map); }
    else { marker.setLatLng([lat,lng]); map.setView([lat,lng],14); }
    if(popup) marker.bindPopup(popup).openPopup();
  }
  function focusOnMap(lat,lng){ updateMap(lat,lng,`üìç ${lat}, ${lng}`); }

  // ---------- modal ----------
  function showModal(html, showUpgrade=false) {
    modalContent.innerHTML = html;
    modal.style.display = 'flex';
    modalUpgradeBtn.style.display = showUpgrade ? 'inline-block' : 'none';
  }
  modalClose.onclick = ()=> modal.style.display='none';
  modalUpgradeBtn.onclick = ()=> { modal.style.display='none'; /* open upgrade flow if necessary - but we don't autocreate a request here */ };

  // ---------- Auth state and listeners ----------
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ window.location.href='login.html'; return; }
    uidGlobal = user.uid;
    userEmailEl.textContent = user.email || user.uid;

    // listen to user node for plan & upgrade_request
    db.ref(`users/${uidGlobal}`).on('value', snap=>{
      const udata = snap.val() || {};
      applyPlanToUI(udata);
      // check downgrade
      checkAndAutoDowngrade(uidGlobal, udata);
      // show request status ui
      renderRequestUI(udata.upgrade_request || null);
      // set admin flag if present
      if (udata.admin === true) {
        isAdmin = true;
        adminPanel.style.display = 'block';
      } else {
        isAdmin = false;
        adminPanel.style.display = 'none';
      }
    });

    // vehicle current & history listeners
    const vehicleRef = db.ref(`users/${uidGlobal}/vehicle`);
    vehicleRef.child('current').on('value', snap=>{
      const d = snap.val() || {};
      document.getElementById('location').textContent = (d.latitude && d.longitude) ? `${d.latitude}, ${d.longitude}` : 'No location';
      document.getElementById('lastActive').textContent = d.last_active || 'Unknown';
      document.getElementById('status').textContent = d.status || 'Unknown';
      document.getElementById('batteryHealth').textContent = (typeof d.battery !== 'undefined') ? d.battery + '%' : 'N/A';
      if (d.latitude && d.longitude) updateMap(d.latitude, d.longitude);
    });

    vehicleRef.child('history').on('value', snap=>{
      renderHistory(snap.val());
    });

    // admin panel watchers (only show if isAdmin is set above)
    db.ref('admin/upgrade_requests').on('value', snap=>{
      if(!isAdmin) return; // only admins should render
      const reqs = snap.val() || {};
      adminList.innerHTML = '<table style="width:100%"><thead><tr><th>Request</th><th>Plan</th><th>When</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>';
      const tbody = adminList.querySelector('tbody');
      tbody.innerHTML = '';
      Object.entries(reqs).reverse().forEach(([key, val])=>{
        const tr = document.createElement('tr');
        const when = val.request_time || '-';
        const status = val.status || '-';
        tr.innerHTML = `<td>${val.uid}</td><td>${val.requestedPlan||''}</td><td>${when}</td><td>${status}</td><td></td>`;
        const actionsTd = tr.querySelector('td:last-child');
        if (status === 'pending') {
          const aBtn = document.createElement('button'); aBtn.textContent='Approve'; aBtn.className='btn btn-primary'; aBtn.onclick = ()=> {
            adminApproveRequest(uidGlobal, user.email||uidGlobal, key, val).then(()=> alert('Approved and user updated.'));
          };
          const rBtn = document.createElement('button'); rBtn.textContent='Reject'; rBtn.className='btn btn-danger'; rBtn.style.marginLeft='8px'; rBtn.onclick = ()=> {
            if (!confirm('Reject this upgrade request?')) return;
            adminRejectRequest(uidGlobal, user.email||uidGlobal, key, val).then(()=> alert('Rejected.'));
          };
          actionsTd.appendChild(aBtn); actionsTd.appendChild(rBtn);
        } else {
          actionsTd.textContent = 'Processed';
        }
        tbody.appendChild(tr);
      });
    });

    // admin logs view
    db.ref('admin/approvals').limitToLast(50).on('value', snap=>{
      if(!isAdmin) return;
      const logs = snap.val() || {};
      adminLogs.innerHTML = '<ul style="padding-left:16px;margin:0;">' + Object.entries(logs).reverse().map(([k,v])=>`<li style="margin-bottom:6px;"><b>${v.adminName||v.adminUid||'admin'}</b> ‚Üí ${v.uid} : ${v.plan||v.status} (${v.approvedAt||v.processedAt||v.time||''})</li>`).join('') + '</ul>';
    });

  });

  // ---------- UI: Upgrade button actions ----------
  upgradeToSilverBtn.addEventListener('click', ()=> {
    if (!uidGlobal) return alert('Not logged in');
    // create upgrade request for silver
    createUpgradeRequest(uidGlobal, 'silver').then(()=> {
      upgradeToSilverBtn.style.display='none'; upgradeToGoldBtn.style.display='none';
      requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
    }).catch(err => { console.error(err); alert('Failed to send request'); });
  });

  upgradeToGoldBtn.addEventListener('click', ()=> {
    if (!uidGlobal) return alert('Not logged in');
    createUpgradeRequest(uidGlobal, 'gold').then(()=> {
      upgradeToSilverBtn.style.display='none'; upgradeToGoldBtn.style.display='none';
      requestStatusArea.innerHTML = '<span class="pending-pill">Upgrade request SENT (pending admin approval)</span>';
    }).catch(err => { console.error(err); alert('Failed to send request'); });
  });

  // ---------- Export CSV click ----------
  exportCSVBtn.addEventListener('click', ()=>{
    if (!uidGlobal) return;
    db.ref(`users/${uidGlobal}/vehicle/history`).once('value').then(snap=>{
      exportHistoryCSV(snap.val());
    });
  });

  // ---------- Admin helper functions re-declared here for scope (could be shared) ----------
  async function adminApproveRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const plan = adminReqObj.requestedPlan || 'silver';
    const now = new Date();
    const expiry = new Date(now.getTime() + (30*24*60*60*1000)); // 30 days
    const updates = {};
    updates[`users/${targetUid}/plan`] = plan;
    updates[`users/${targetUid}/plan_expiry`] = expiry.toISOString();
    updates[`users/${targetUid}/vehicle_limit`] = PLAN_POLICIES[plan].vehicle_limit;
    updates[`users/${targetUid}/exportCSV`] = true;
    updates[`users/${targetUid}/upgrade_request/status`] = 'approved';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'approved';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, plan, approvedAt: new Date().toISOString(), adminNameDisplay:adminName||adminUid };
    await db.ref().update(updates);
    alert('User upgraded to ' + plan.toUpperCase());
  }

  async function adminRejectRequest(adminUid, adminName, adminReqKey, adminReqObj) {
    const targetUid = adminReqObj.uid;
    const updates = {};
    updates[`users/${targetUid}/upgrade_request/status`] = 'rejected';
    updates[`admin/upgrade_requests/${adminReqKey}/status`] = 'rejected';
    updates[`admin/approvals/${adminReqKey}`] = { adminUid, adminName, uid: targetUid, status:'rejected', processedAt: new Date().toISOString() };
    await db.ref().update(updates);
    alert('Request rejected.');
  }

  // ---------- Auto-downgrade periodic check for all users (optional) ----------
  // NOTE: running a client-based loop to enumerate all users is not scalable or secure.
  // For production use Cloud Functions (scheduled) to periodically downgrade expired users.
  // Here we only check the current logged-in user (see below in their listener).
  const AUTO_CHECK_INTERVAL_MS = 60*1000;
  setInterval(()=>{
    if (!uidGlobal) return;
    db.ref(`users/${uidGlobal}`).once('value').then(snap=> {
      const u = snap.val() || {};
      if (u.plan && u.plan_expiry) checkAndAutoDowngrade(uidGlobal, u);
    });
  }, AUTO_CHECK_INTERVAL_MS);

  // ---------- Logout ----------
  document.getElementById('logoutBtn').onclick = ()=> auth.signOut();

  // ---------- Notes for production ----------
  /*
   * - IMPORTANT: Do NOT allow clients to write their own plan/plan_expiry/exportCSV directly.
   * - Implement server-side payment verification (Razorpay / Stripe) and use webhooks to update
   *   users/{uid} safely (set plan, plan_expiry, vehicle_limit, exportCSV).
   * - Add Firebase Realtime Database Rules to prevent privilege escalation by clients:
   *     e.g., only allow writes to users/{uid}/upgrade_request by the same uid,
   *           only allow admin nodes to be written by admins (server),
   *           block clients from writing users/{uid}/plan or users/{uid}/exportCSV.
   * - Replace simulated ad placeholders with your ad provider (AdMob or web banners) controlled by plan.
   * - Use Cloud Functions to auto-downgrade users at scale by scanning user records and moving expired plans to basic.
   */

  </script>
</body>
</html>
