<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Admin - Pending Approvals</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body class="p-4">

<h3>Pending Approvals</h3>
<ul id="pendingUsersList" class="list-group mb-4"></ul>

<script>
// Your Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function loadPendingApprovals() {
  pendingUsersList.innerHTML = '';
  db.ref('users').once('value').then(snapshot => {
    const users = snapshot.val() || {};
    let any = false;

    Object.entries(users).forEach(([uid, u]) => {
      if (!u.role || u.role === 'super-admin') return; // Skip super admin

      let pendingType = null;
      let planRequested = null;

      // Case 1: Account not approved yet
      if (u.approved !== true) {
        pendingType = 'Account Approval';
        planRequested = u.plan || 'N/A';
      }

      // Case 2: Subscription upgrade request pending
      if (u.upgrade_request && u.upgrade_request.status === 'Pending') {
        pendingType = 'Subscription Upgrade';
        planRequested = u.upgrade_request.new_plan || u.plan || 'N/A';
      }

      if (pendingType) {
        any = true;
        const name = u.companyName || u.email || uid;

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <strong>${name}</strong> <small class="text-muted">(${u.role})</small>
            <div class="text-muted small">
              Request Type: ${pendingType} <br>
              Requested Plan: ${planRequested}
            </div>
          </div>
        `;

        const actions = document.createElement('div');

        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-success btn-sm me-1';
        approveBtn.textContent = 'Approve';
        approveBtn.onclick = () => {
          if (pendingType === 'Account Approval') {
            approveUser(uid);
          } else if (pendingType === 'Subscription Upgrade') {
            approveSubscription(uid, planRequested);
          }
        };

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-danger btn-sm';
        rejectBtn.textContent = 'Reject';
        rejectBtn.onclick = () => {
          if (pendingType === 'Account Approval') {
            rejectUser(uid);
          } else if (pendingType === 'Subscription Upgrade') {
            rejectSubscription(uid);
          }
        };

        actions.appendChild(approveBtn);
        actions.appendChild(rejectBtn);
        li.appendChild(actions);
        pendingUsersList.appendChild(li);
      }
    });

    if (!any) {
      pendingUsersList.innerHTML = `<li class="list-group-item text-muted">No pending approvals.</li>`;
    }
  });
}

// Approve account
function approveUser(uid) {
  db.ref(`users/${uid}`).update({ approved: true })
    .then(() => {
      alert('User account approved');
      loadPendingApprovals();
    });
}

// Reject account
function rejectUser(uid) {
  db.ref(`users/${uid}`).remove()
    .then(() => {
      alert('User account rejected');
      loadPendingApprovals();
    });
}

// Approve subscription upgrade
function approveSubscription(uid, newPlan) {
  db.ref(`users/${uid}`).update({
    plan: newPlan,
    'upgrade_request/status': 'Approved'
  }).then(() => {
    alert('Subscription upgraded');
    loadPendingApprovals();
  });
}

// Reject subscription upgrade
function rejectSubscription(uid) {
  db.ref(`users/${uid}/upgrade_request/status`).set('Rejected')
    .then(() => {
      alert('Subscription upgrade rejected');
      loadPendingApprovals();
    });
}

loadPendingApprovals();
</script>
</body>
</html>
