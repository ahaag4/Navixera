<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Admin - Pending Approvals</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
    .expiring-soon { color: red; font-weight: bold; }
</style>
</head>
<body class="p-4">

<h3>Pending Approvals</h3>
<ul id="pendingUsersList" class="list-group mb-4"></ul>

<script>
// ==========================
//  Firebase Configuration
// ==========================
const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==========================
//  Helpers
// ==========================
function formatDate(dateVal) {
  if (!dateVal) return 'N/A';

  // If it's a number (timestamp)
  if (typeof dateVal === 'number') {
    return new Date(dateVal).toLocaleString();
  }

  // If it's Firebase Timestamp object
  if (typeof dateVal === 'object' && dateVal.seconds) {
    return new Date(dateVal.seconds * 1000).toLocaleString();
  }

  // String date
  let date = new Date(dateVal);
  if (!isNaN(date.getTime())) {
    return date.toLocaleString();
  }

  return dateVal; // fallback raw
}

function getDateValue(dateVal) {
  if (!dateVal) return 0;
  if (typeof dateVal === 'number') return dateVal;
  if (typeof dateVal === 'object' && dateVal.seconds) return dateVal.seconds * 1000;
  let d = new Date(dateVal).getTime();
  return isNaN(d) ? 0 : d;
}

function isExpiringSoon(dateVal) {
  let expiryMs = getDateValue(dateVal);
  if (!expiryMs) return false;
  let now = Date.now();
  let diffDays = (expiryMs - now) / (1000 * 60 * 60 * 24);
  return diffDays <= 7 && diffDays >= 0;
}

// ==========================
//  Main Loader
// ==========================
function loadPendingApprovals() {
  const pendingUsersList = document.getElementById('pendingUsersList');
  pendingUsersList.innerHTML = '';

  db.ref('users').once('value').then(snapshot => {
    const users = snapshot.val() || {};
    let pendingArr = [];

    Object.entries(users).forEach(([uid, u]) => {
      if (!u.role || u.role === 'super-admin') return;

      // Case 1: Account approval pending
      if (u.approved !== true) {
        pendingArr.push({
          uid,
          role: u.role,
          name: u.companyName || u.email || uid,
          pendingType: 'Account Approval',
          planRequested: u.plan || 'N/A',
          requestTime: u.createdAt || null,
          expiryDate: u.plan_expiry || null
        });
      }

      // Case 2: Subscription upgrade pending
      if (u.upgrade_request && u.upgrade_request.status === 'Pending') {
        pendingArr.push({
          uid,
          role: u.role,
          name: u.companyName || u.email || uid,
          pendingType: 'Subscription Upgrade',
          planRequested: u.upgrade_request.new_plan || u.upgrade_request.plan || u.plan || 'N/A',
          requestTime: u.upgrade_request.request_time || null,
          expiryDate: u.plan_expiry || null
        });
      }
    });

    // Sort oldest first
    pendingArr.sort((a, b) => getDateValue(a.requestTime) - getDateValue(b.requestTime));

    if (pendingArr.length === 0) {
      pendingUsersList.innerHTML = `<li class="list-group-item text-muted">No pending approvals.</li>`;
      return;
    }

    // Render
    pendingArr.forEach(item => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <div>
          <strong>${item.name}</strong> <small class="text-muted">(${item.role})</small>
          <div class="text-muted small">
            Request Type: ${item.pendingType} <br>
            Requested Plan: ${item.planRequested} <br>
            Request Time: ${formatDate(item.requestTime)} <br>
            Plan Expiry: <span class="${isExpiringSoon(item.expiryDate) ? 'expiring-soon' : ''}">
              ${formatDate(item.expiryDate)}
            </span>
          </div>
        </div>
      `;

      const actions = document.createElement('div');

      const approveBtn = document.createElement('button');
      approveBtn.className = 'btn btn-success btn-sm me-1';
      approveBtn.textContent = 'Approve';
      approveBtn.onclick = () => {
        if (item.pendingType === 'Account Approval') {
          approveUser(item.uid);
        } else {
          approveSubscription(item.uid, item.planRequested);
        }
      };

      const rejectBtn = document.createElement('button');
      rejectBtn.className = 'btn btn-danger btn-sm';
      rejectBtn.textContent = 'Reject';
      rejectBtn.onclick = () => {
        if (item.pendingType === 'Account Approval') {
          rejectUser(item.uid);
        } else {
          rejectSubscription(item.uid);
        }
      };

      actions.appendChild(approveBtn);
      actions.appendChild(rejectBtn);
      li.appendChild(actions);
      pendingUsersList.appendChild(li);
    });
  });
}

// ==========================
//  Actions
// ==========================
function approveUser(uid) {
  db.ref(`users/${uid}`).update({ approved: true })
    .then(() => {
      alert('User account approved');
      loadPendingApprovals();
    });
}

function rejectUser(uid) {
  db.ref(`users/${uid}`).remove()
    .then(() => {
      alert('User account rejected');
      loadPendingApprovals();
    });
}

function approveSubscription(uid, newPlan) {
  db.ref(`users/${uid}`).update({
    plan: newPlan,
    'upgrade_request/status': 'Approved'
  }).then(() => {
    alert('Subscription upgraded');
    loadPendingApprovals();
  });
}

function rejectSubscription(uid) {
  db.ref(`users/${uid}/upgrade_request/status`).set('Rejected')
    .then(() => {
      alert('Subscription upgrade rejected');
      loadPendingApprovals();
    });
}

// ==========================
//  Init
// ==========================
loadPendingApprovals();
</script>
</body>
</html>
