<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Super Admin - SVMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {background:#f8f9fa}
    .navbar {background:#0d6efd}
    .navbar-brand {color:#fff!important;font-weight:600}
    .card {border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    #map,#historyMap {height:400px;border-radius:8px}
    .stat-card {text-align:center;padding:18px;background:#fff;border-radius:10px}
    #debugLog {height:110px;overflow:auto;background:#fff;padding:10px;border-radius:6px;border:1px solid #e6e6e6;font-size:12px}
    .pill-pending{background:#ffd966;color:#4a2900;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-approved{background:#31ffa7;color:#167054;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-rejected{background:#f8d7da;color:#721c24;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .clickable-ad { cursor: pointer; transition: transform 0.2s; }
    .clickable-ad:hover { transform: scale(1.02); }
  </style>
</head>
<body>
  <nav class="navbar px-3">
    <a class="navbar-brand">Super Admin - SVMS (Realtime DB)</a>
    <button class="btn btn-light ms-auto" id="logoutBtn">Logout</button>
  </nav>
  <div class="container py-4">
    <div class="mb-3">
      <strong>Debug (visible):</strong>
      <pre id="debugLog">Loading...</pre>
    </div>
    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalCompanies">0</h3><p>Total Companies</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalVehicles">0</h3><p>Total Vehicles</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalDeliveries">0</h3><p>Total Deliveries</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="alertsToday">0</h3><p>Alerts Today</p></div></div>
    </div>
    <!-- Live map -->
    <div class="card mb-4"><div class="card-body"><h5>Live Vehicle Locations</h5><div id="map"></div></div></div>
    <!-- Pending User Approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Pending User Approvals</h5>
        <ul class="list-group" id="pendingUsersList"></ul>
      </div>
    </div>
    <!-- Subscription Plan Approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Subscription Plan Upgrade Requests</h5>
        <ul id="subscriptionPendingList" class="list-group mb-2"></ul>
        <div class="small text-muted">Approve/reject users' Silver/Gold upgrade requests.</div>
      </div>
    </div>
    <!-- In-App Purchases Approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>In-App Purchase Requests</h5>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>User</th>
                <th>Feature</th>
                <th>Amount</th>
                <th>Payment Method</th>
                <th>Transaction ID</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="purchaseRequestsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Ads Management -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Ads Management</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Ad Type</label>
            <select id="adType" class="form-select">
              <option value="banner">Banner (image)</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Upload File</label>
            <input id="adFile" type="file" class="form-control"/>
            <div class="form-text">File will be uploaded to Firebase Storage.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Or Media URL</label>
            <input id="adUrl" class="form-control" placeholder="https://... (optional)"/>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Placement</label>
            <select id="adPlacement" class="form-select">
              <option value="dashboard_top">Dashboard Top</option>
              <option value="dashboard_footer">Dashboard Footer</option>
              <option value="login_interstitial">Login Interstitial</option>
              <option value="email_banner">Email Banner</option>
            </select>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Active</label>
            <select id="adActive" class="form-select">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Click URL</label>
            <input id="adClickUrl" class="form-control" placeholder="https://... (optional)"/>
          </div>
          <div class="col-md-4 d-flex align-items-end mt-2">
            <button id="uploadAdBtn" class="btn btn-primary w-100">Upload / Save Ad</button>
          </div>
        </div>
        <hr/>
        <h6>Existing Ads</h6>
        <div id="adsList"></div>
      </div>
    </div>
    <!-- Approved Users -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Approved Users</h5>
        <div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Name</th><th>Role</th><th>Plan</th><th>Action</th></tr></thead><tbody id="approvedUsersTable"></tbody></table></div>
      </div>
    </div>
    <!-- Movement History -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Movement History</h5>
        <select id="historyUserSelect" class="form-select mb-2"><option value="">Select User</option></select>
        <button class="btn btn-secondary mb-2" id="loadHistoryBtn">Load History</button>
        <div id="historyMap" style="height:300px;"></div>
        <button class="btn btn-danger mt-2" id="deleteHistoryBtn" style="display:none">Delete All History</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ---- Firebase Config -----
  const firebaseConfig = {
    apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
    authDomain: "svms-c0232.firebaseapp.com",
    databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
    projectId: "svms-c0232",
    storageBucket: "svms-c0232.appspot.com",
    messagingSenderId: "359201898609",
    appId: "1:359201898609:web:893ef076207abb06471bd0"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // ==== Debug utility
  const debugEl = document.getElementById('debugLog');
  function logDebug(...args){
    const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ');
    debugEl.textContent = (debugEl.textContent || '') + s + '\n';
    debugEl.scrollTop = debugEl.scrollHeight;
    console.log(...args);
  }

  // ==== Escape helper
  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return String(s).replace(/[&<>"'`=\/]/g, function (c) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];
    });
  }
  // ==== AUTH & INITIALIZE ====
  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = 'login.html';
    const snap = await db.ref(`users/${user.uid}`).once('value');
    const u = snap.val();
    if(!u || !(u.role === 'super-admin' || u.role === 'admin' || u.isAdmin === true || u.admin === true)){
      return location.href = 'dashboard.html';
    }
    init(user.uid);
  });

  document.getElementById('logoutBtn').onclick = () => auth.signOut().then(()=>location.href='login.html');

  function init(adminUid){
    setupLiveMap();
    setupHistoryMap();
    loadStats();
    loadPendingApprovals();
    loadApprovedUsers();
    loadUserDropdowns();
    loadPendingSubscriptions();
    loadPurchaseRequests();
    loadAds();
    document.getElementById('uploadAdBtn').onclick = handleUploadAd;
    document.getElementById('loadHistoryBtn').onclick = handleLoadHistory;
    logDebug('Initialized for admin: ', adminUid);
  }

  // ==== Stats ====
  function loadStats(){ /* ... same as above ... */ 
    db.ref('users').once('value').then(snap=>{
      const users = snap.val()||{};
      let companiesSet = new Set(), vehicles = 0, deliveries = 0, alerts = 0;
      for(const uid in users){
        const u = users[uid];
        if (u && u.vehicle && u.vehicle.companies) {
          Object.keys(u.vehicle.companies).forEach(cn => companiesSet.add(cn));
          Object.values(u.vehicle.companies).forEach(comp => {
            const vehs = comp.vehicle||{};
            vehicles += Object.keys(vehs).length;
            Object.values(vehs).forEach(v => {
              if (v && v.deliveries) {
                const d = v.deliveries;
                deliveries += (typeof d === 'object' && !Array.isArray(d)) ? Object.keys(d).length : (Array.isArray(d) ? d.length : 0);
              }
            });
          });
        } else if (u && u.vehicles) {
          vehicles += Object.keys(u.vehicles).length;
        }
        if (u && u.vehicle && u.vehicle.last_trigger && u.vehicle.last_trigger.status === 'alert') alerts++;
      }
      document.getElementById('totalCompanies').innerText = companiesSet.size;
      document.getElementById('totalVehicles').innerText = vehicles;
      document.getElementById('totalDeliveries').innerText = deliveries;
      document.getElementById('alertsToday').innerText = alerts;
    });
  }

  // ==== Pending User Approvals
  function loadPendingApprovals(){ /* ... as above ... */
    const list=document.getElementById("pendingUsersList");
    list.innerHTML="";
    db.ref("users").once("value", snap=>{
      const users=snap.val()||{};
      let found = false;
      for(const uid in users){
        const u=users[uid];
        if((u.role==="company"||u.role==="customer") && u.approved!==true){
          found = true;
          const name = u.companyName||u.email||uid;
          list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
            ${name} (${u.role})
            <span>
              <button class="btn btn-success btn-sm me-1" onclick="window.approve('${uid}')">Approve</button>
              <button class="btn btn-danger btn-sm" onclick="window.reject('${uid}')">Reject</button>
            </span>
          </li>`;
        }
      }
      if(!found) list.innerHTML = '<li class="list-group-item text-muted">No pending approvals.</li>';
    });
  }
  window.approve = function(uid){
    db.ref(`users/${uid}`).update({ approved: true })
      .then(() => { alert("✅ Approved"); loadPendingApprovals(); loadApprovedUsers(); })
      .catch((err) => { alert("Error approving: " + err.message); logDebug("Approve error:", err); });
  };
  window.reject = function(uid){
    if(confirm("Delete user?")) {
      db.ref(`users/${uid}`).remove()
        .then(() => { alert("❌ Rejected and removed"); loadPendingApprovals(); loadApprovedUsers(); })
        .catch((err) => { alert("Error rejecting: " + err.message); logDebug("Reject error:", err); });
    }
  };

  // ==== Subscription Plan Upgrade Approvals
  function loadPendingSubscriptions() {
    const subscriptionPendingList = document.getElementById('subscriptionPendingList');
    db.ref('users').on('value', snap => {
      const users = snap.val() || {};
      subscriptionPendingList.innerHTML = '';
      let any = false;
      Object.entries(users).forEach(([uid, u]) => {
        if (u && u.upgrade_request && u.upgrade_request.status === 'pending' && u.upgrade_request.requestedPlan) {
          any = true;
          const planLabel = (u.upgrade_request.requestedPlan || '').toUpperCase();
          const name = u.companyName || u.email || uid;
          const requestTime = u.upgrade_request.request_time || '';
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<div>
              <strong>${escapeHtml(name)}</strong> <small class="text-muted">UID: ${uid}</small>
              <div class="small">Request: <b>${planLabel}</b> <span class="pill-pending">Pending</span></div>
              <div class="small text-muted">${escapeHtml(requestTime)}</div>
            </div>`;
          const actions = document.createElement('div');
          const approveBtn = document.createElement('button');
          approveBtn.className = 'btn btn-success btn-sm me-2';
          approveBtn.innerText = 'Approve';
          approveBtn.onclick = function() { window.approveSubscriptionPlan(uid, planLabel, name); };
          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'btn btn-danger btn-sm';
          rejectBtn.innerText = 'Reject';
          rejectBtn.onclick = function() { window.rejectSubscriptionPlan(uid, planLabel, name); };
          actions.appendChild(approveBtn); actions.appendChild(rejectBtn); li.appendChild(actions);
          subscriptionPendingList.appendChild(li);
        }
      });
      if (!any) subscriptionPendingList.innerHTML = `<li class="list-group-item text-muted">No pending subscription upgrades.</li>`;
    });
  }
  function approveSubscriptionPlan(uid, plan, name) {
    if (!uid || !plan) return alert('Missing info');
    let days = parseFloat(prompt('Expiry days from now? Default 30', '30')) || 30;
    let expiry = new Date(Date.now() + days*24*60*60*1000).toISOString();
    const PLAN_POLICIES = {
      basic: { vehicle_limit: 1, exportCSV: false },
      silver: { vehicle_limit: 3, exportCSV: true },
      gold: { vehicle_limit: 3, exportCSV: true }
    };
    let planLower = plan.toLowerCase();
    let settings = PLAN_POLICIES[planLower] || PLAN_POLICIES.silver;
    const updates = {};
    updates[`users/${uid}/plan`] = planLower;
    updates[`users/${uid}/plan_expiry`] = expiry;
    updates[`users/${uid}/vehicle_limit`] = settings.vehicle_limit;
    updates[`users/${uid}/exportCSV`] = settings.exportCSV;
    updates[`users/${uid}/upgrade_request/status`] = 'approved';
    updates[`admin/subscription_approvals/${uid}_${Date.now()}`] = {
      adminBy: (auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)),
      uid, plan: planLower, name, time: new Date().toISOString()
    };
    db.ref().update(updates)
      .then(() => { alert('Subscription plan upgraded and approved.'); })
      .catch(err => alert('Approve failed: ' + err.message));
  }
  window.approveSubscriptionPlan = approveSubscriptionPlan;
  function rejectSubscriptionPlan(uid, plan, name) {
    if (!uid) return;
    if (!confirm('Reject upgrade for user '+name+'?')) return;
    db.ref(`users/${uid}/upgrade_request/status`).set('rejected')
      .then(() => { alert('Upgrade request rejected.'); })
      .catch(err => alert('Reject failed: ' + err.message));
  }
  window.rejectSubscriptionPlan = rejectSubscriptionPlan;

  // ==== In-App Purchase Approvals
  function loadPurchaseRequests() {
    const table = document.getElementById('purchaseRequestsTable');
    db.ref('admin/payments').on('value', snap => {
      const payments = snap.val() || {};
      table.innerHTML = '';
      
      Object.entries(payments).reverse().forEach(([paymentId, payment]) => {
        if (!payment || payment.status !== 'pending') return;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${payment.user_email || payment.uid || 'N/A'}</td>
          <td>${payment.feature || 'N/A'}</td>
          <td>${payment.currency === 'inr' ? '₹' : '$'}${payment.amount || '0'}</td>
          <td>${payment.payment_method || 'N/A'}</td>
          <td>${payment.transaction_id || 'N/A'}</td>
          <td><span class="pill-pending">Pending</span></td>
          <td>
            <button class="btn btn-success btn-sm me-1" onclick="window.approvePurchase('${paymentId}', '${payment.uid}', '${payment.feature}')">Approve</button>
            <button class="btn btn-danger btn-sm" onclick="window.rejectPurchase('${paymentId}')">Reject</button>
          </td>
        `;
        table.appendChild(row);
      });
      
      if (table.innerHTML === '') {
        table.innerHTML = '<tr><td colspan="7" class="text-muted">No pending purchase requests</td></tr>';
      }
    });
  }
  
  window.approvePurchase = function(paymentId, uid, feature) {
    if (!confirm(`Approve this ${feature} purchase?`)) return;
    
    const expiryDate = new Date(Date.now() + (feature === 'export' ? 24 * 60 * 60 * 1000 : 30 * 24 * 60 * 60 * 1000)).toISOString();
    
    const updates = {};
    updates[`users/${uid}/purchases/${feature}`] = {
      feature: feature,
      purchase_time: new Date().toISOString(),
      expiry: expiryDate,
      approved_by: auth.currentUser.email || auth.currentUser.uid,
      approved_at: new Date().toISOString()
    };
    updates[`users/${uid}/purchases_pending/${paymentId}/status`] = 'approved';
    updates[`admin/payments/${paymentId}/status`] = 'approved';
    updates[`admin/payments/${paymentId}/approved_by`] = auth.currentUser.email || auth.currentUser.uid;
    updates[`admin/payments/${paymentId}/approved_at`] = new Date().toISOString();
    
    db.ref().update(updates)
      .then(() => alert('Purchase approved!'))
      .catch(err => alert('Error: ' + err.message));
  };
  
  window.rejectPurchase = function(paymentId) {
    if (!confirm('Reject this purchase request?')) return;
    
    const updates = {};
    updates[`admin/payments/${paymentId}/status`] = 'rejected';
    
    db.ref().update(updates)
      .then(() => alert('Purchase rejected!'))
      .catch(err => alert('Error: ' + err.message));
  };

  // ==== Ads Management (fully working with clickable ads)
  function loadAds(){
    const adsList = document.getElementById('adsList');
    adsList.innerHTML = '<div class="text-muted">Loading ads…</div>';
    db.ref('admin/ads').once('value').then(snap=>{
      const ads = snap.val() || {};
      adsList.innerHTML = '';
      Object.entries(ads).reverse().forEach(([key,ad])=>{
        const div = document.createElement('div');
        div.className = 'mb-2 p-2 border rounded bg-white';
        const created = ad.createdAt || '';
        div.innerHTML = `<div><strong>Placement:</strong> ${escapeHtml(ad.placement || '')} · <strong>Type:</strong> ${escapeHtml(ad.type||'')} · <small class="text-muted">${escapeHtml(created)}</small></div>`;
        const content = document.createElement('div');
        if(ad.type === 'banner'){
          const img = document.createElement('img');
          img.src = ad.url || '';
          img.style.maxWidth = '320px';
          img.style.height = 'auto';
          img.style.borderRadius = '6px';
          img.className = 'clickable-ad';
          if (ad.clickUrl) {
            img.onclick = () => window.open(ad.clickUrl, '_blank');
          }
          content.appendChild(img);
        } else {
          const video = document.createElement('video');
          video.controls = true;
          video.style.maxWidth = '320px';
          video.style.borderRadius = '6px';
          const source = document.createElement('source');
          source.src = ad.url || '';
          video.appendChild(source);
          video.className = 'clickable-ad';
          if (ad.clickUrl) {
            video.onclick = () => window.open(ad.clickUrl, '_blank');
          }
          content.appendChild(video);
        }
        
        const btns = document.createElement('div'); btns.className='mt-2';
        const toggleBtn = document.createElement('button'); toggleBtn.className='btn btn-sm btn-outline-secondary me-2';
        toggleBtn.textContent = ad.active ? 'Deactivate' : 'Activate';
        toggleBtn.onclick = ()=> {
          db.ref(`admin/ads/${key}/active`).set(!ad.active).then(()=> loadAds());
        };
        
        const clickUrlBtn = document.createElement('button'); 
        clickUrlBtn.className='btn btn-sm btn-outline-primary me-2';
        clickUrlBtn.textContent='Edit Click URL';
        clickUrlBtn.onclick = ()=> {
          const newUrl = prompt('Enter new click URL (leave empty to remove):', ad.clickUrl || '');
          if (newUrl !== null) {
            db.ref(`admin/ads/${key}/clickUrl`).set(newUrl || null).then(()=> loadAds());
          }
        };
        
        const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-danger'; delBtn.textContent='Delete';
        delBtn.onclick = ()=> {
          if(!confirm('Delete this ad?')) return;
          db.ref(`admin/ads/${key}`).remove().then(()=> {
            if(ad.storagePath) storage.ref(ad.storagePath).delete().catch(()=>{/*ignore*/});
            loadAds();
          });
        };
        
        btns.appendChild(toggleBtn); 
        btns.appendChild(clickUrlBtn);
        btns.appendChild(delBtn);
        div.appendChild(content); div.appendChild(btns);
        adsList.appendChild(div);
      });
    }).catch(err => logDebug('loadAds error: ' + err.message));
  }
  
  async function handleUploadAd(){
    const placement = document.getElementById('adPlacement').value;
    const type = document.getElementById('adType').value;
    const active = document.getElementById('adActive').value === 'true';
    const urlProvided = (document.getElementById('adUrl').value || '').trim();
    const clickUrl = (document.getElementById('adClickUrl').value || '').trim();
    const file = document.getElementById('adFile').files[0];
    const key = db.ref('admin/ads').push().key;
    const createdAt = new Date().toISOString();
    const adMeta = { placement, type, active, createdAt };
    
    if (clickUrl) {
      adMeta.clickUrl = clickUrl;
    }
    
    try {
      if (file) {
        const path = `admin_ads/${key}/${file.name}`;
        const ref = storage.ref(path);
        await ref.put(file);
        const downloadUrl = await ref.getDownloadURL();
        adMeta.url = downloadUrl;
        adMeta.storagePath = path;
      } else if (urlProvided) {
        adMeta.url = urlProvided;
      } else {
        return alert('Provide a file or a URL.');
      }
      
      await db.ref(`admin/ads/${key}`).set(adMeta);
      document.getElementById('adFile').value = '';
      document.getElementById('adUrl').value = '';
      document.getElementById('adClickUrl').value = '';
      alert('Ad saved.');
      loadAds();
    } catch(err){
      alert('Upload failed: '+err.message); logDebug('handleUploadAd error', err);
    }
  }

  // ==== Approved users
  function loadApprovedUsers(){
    const tbl=document.getElementById("approvedUsersTable");
    tbl.innerHTML="";
    db.ref("users").once("value",snap=>{
      const users=snap.val()||{};
      let rows = "";
      for(const uid in users){
        const u=users[uid];
        if(u.approved===true && (u.role==="company"||u.role==="customer")){
          rows += `<tr>
            <td>${u.companyName||u.email||uid}</td>
            <td>${u.role}</td>
            <td>${u.plan||'basic'}</td>
            <td><button class="btn btn-primary btn-sm" onclick="window.alert('Not implemented: details')">Open</button></td>
          </tr>`;
        }
      }
      tbl.innerHTML=rows || `<tr><td colspan=4 class="text-muted">No approved users found.</td></tr>`;
    });
  }

  // ==== User dropdown (for history map)
  function loadUserDropdowns(){
    db.ref("users").once("value",snap=>{
      const users=snap.val()||{};
      const sel=document.getElementById("historyUserSelect");
      sel.innerHTML='<option value="">Select User</option>';
      for(const uid in users){
        if(users[uid].role==="company"||users[uid].role==="customer"){
          sel.innerHTML+=`<option value="${uid}">${users[uid].companyName||users[uid].email||uid}</option>`;
        }
      }
    });
  }

  // ==== Movement History by User
  function setupLiveMap(){ try {
    window.liveMap = L.map('map').setView([20,78],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.liveMap);
  } catch{} }
  function setupHistoryMap(){ try {
    window.historyMap = L.map('historyMap').setView([20,78],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.historyMap);
  } catch{} }
  function handleLoadHistory(){
    const uid=document.getElementById("historyUserSelect").value;
    const btn=document.getElementById("deleteHistoryBtn"), historyMap=window.historyMap;
    if(!uid){ alert("Select user"); btn.style.display="none"; return; }
    db.ref(`users/${uid}/vehicle/history`).once("value",snap=>{
      const history=snap.val()||{}, coords=[];
      Object.values(history).forEach(h=>{
        let loc=null;
        if(typeof h === "string" && h.includes(",")) loc=h;
        else if(h && h.location) loc=h.location;
        if(loc){ const [lat,lng]=loc.split(",").map(Number); if(!isNaN(lat)&&!isNaN(lng)) coords.push([lat,lng]); }
      });
      if(coords.length===0){ alert("No history"); btn.style.display="none"; return; }
      if(historyMap){
        coords.forEach(c=>L.circleMarker(c,{radius:4,color:"red"}).addTo(historyMap));
        const poly = L.polyline(coords, {color:"blue"}).addTo(historyMap);
        historyMap.fitBounds(poly.getBounds());
      }
      btn.style.display="inline-block";
      btn.onclick=()=>deleteHistoryByUser(uid);
    });
  }
  function deleteHistoryByUser(uid){
    if(!confirm("Delete all movement history for this user?")) return;
    db.ref(`users/${uid}/vehicle/history`).set(null)
      .then(() => {
        alert("History deleted.");
        document.getElementById("deleteHistoryBtn").style.display="none";
      })
      .catch((err) => {
        alert("Error deleting: " + err.message);
        logDebug("History delete error:", err);
      });
  }
  </script>
</body>
  </html>
