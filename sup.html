<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Super Admin - Navixera</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {background:#f8f9fa}
    .navbar {background:#0d6efd}
    .navbar-brand {color:#fff!important;font-weight:600}
    .card {border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    #map,#historyMap {height:400px;border-radius:8px}
    .stat-card {text-align:center;padding:18px;background:#fff;border-radius:10px}
    #debugLog {height:110px;overflow:auto;background:#fff;padding:10px;border-radius:6px;border:1px solid #e6e6e6;font-size:12px}
    .pill-pending{background:#ffd966;color:#4a2900;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-approved{background:#31ffa7;color:#167054;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-rejected{background:#f8d7da;color:#721c24;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .clickable-ad { cursor: pointer; transition: transform 0.2s; }
    .clickable-ad:hover { transform: scale(1.02); }
    .ad-container { position: relative; display: inline-block; }
    .ad-error { color: #721c24; font-size: 12px; }
    
    /* Payment Link Generator Styles */
    .payment-link-container {
      margin-top: 20px;
      background: #f8f9ff;
      padding: 20px;
      border-radius: 10px;
      border: 2px dashed #2670ff;
    }
    
    .payment-link {
      font-size: 16px;
      word-break: break-all;
      margin-bottom: 15px;
      color: #2670ff;
      font-weight: 500;
    }
    
    .btn-copy {
      background: #28a745;
    }
    
    .btn-share {
      background: #6c757d;
    }
    
    .btn-copy:hover {
      background: #218838;
    }
    
    .btn-share:hover {
      background: #5a6268;
    }
    
    .payment-preview {
      background: #f8f9ff;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    
    .preview-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .preview-total {
      font-weight: bold;
      font-size: 18px;
      color: #2670ff;
    }
    
    .link-item {
      padding: 15px;
      background: #f8f9ff;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .link-details {
      flex: 1;
    }
    
    .link-actions {
      display: flex;
      gap: 10px;
    }
    
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-paid {
      background: #d4edda;
      color: #155724;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: #28a745;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    /* Analytics styles */
    .analytics-stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .analytics-stat {
      background: white;
      padding: 15px;
      border-radius: 10px;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }
    
    .analytics-stat h3 {
      margin: 0;
      font-size: 24px;
      color: #0d6efd;
    }
    
    .analytics-stat p {
      margin: 5px 0 0;
      color: #6c757d;
    }
    
    .analytics-chart {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
    }
  </style>
</head>
<body>
  <nav class="navbar px-3">
    <a class="navbar-brand">Super Admin - Navixera(Realtime DB)</a>
    <button class="btn btn-light ms-auto" id="logoutBtn">Logout</button>
  </nav>
  <div class="container py-4">
    <div class="mb-3">
      <strong>Debug (visible):</strong>
      <pre id="debugLog">Loading...</pre>
    </div>
    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalCompanies">0</h3><p>Total Companies</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalVehicles">0</h3><p>Total Vehicles</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalDeliveries">0</h3><p>Total Deliveries</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="alertsToday">0</h3><p>Alerts Today</p></div></div>
    </div>
    <!-- Live map -->
    <div class="card mb-4"><div class="card-body"><h5>Live Vehicle Locations</h5><div id="map"></div></div></div>
    <!-- Pending User Approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Pending User Approvals</h5>
        <ul class="list-group" id="pendingUsersList"></ul>
      </div>
    </div>
    <!-- Subscription Plan Approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Subscription Plan Upgrade Requests</h5>
        <ul id="subscriptionPendingList" class="list-group mb-2"></ul>
        <div class="small text-muted">Approve/reject users' Silver/Gold upgrade requests.</div>
      </div>
    </div>
    <!-- In-App Purchases Approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>In-App Purchase Requests</h5>
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>User</th>
                <th>Feature</th>
                <th>Amount</th>
                <th>Payment Method</th>
                <th>Transaction ID</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="purchaseRequestsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Payment Link Generator -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Payment Link Generator</h5>
        <div class="form-group">
          <label for="productName">Product/Service Name</label>
          <input type="text" id="productName" class="form-control" placeholder="e.g., Premium Subscription">
        </div>
        
        <div class="form-group">
          <label for="amount">Amount (₹)</label>
          <input type="number" id="amount" class="form-control" placeholder="0.00" min="0" step="0.01">
        </div>
        
        <div class="form-group">
          <label for="currency">Currency</label>
          <select id="currency" class="form-control">
            <option value="INR">Indian Rupee (INR)</option>
            <option value="USD">US Dollar (USD)</option>
            <option value="EUR">Euro (EUR)</option>
            <option value="GBP">British Pound (GBP)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" class="form-control" rows="3" placeholder="Description of the product or service"></textarea>
        </div>
        
        <button id="generateBtn" class="btn btn-primary">Generate Payment Link</button>
        
        <div class="payment-link-container" id="linkContainer" style="display: none;">
          <h6>Your Payment Link</h6>
          <p class="payment-link" id="paymentLink"></p>
          <div class="action-buttons">
            <button class="btn btn-success btn-sm me-1" id="copyBtn"><i class="fas fa-copy"></i> Copy Link</button>
            <button class="btn btn-secondary btn-sm" id="shareBtn"><i class="fas fa-share-alt"></i> Share</button>
          </div>
        </div>
        
        <div class="mt-4">
          <h6>Recent Payment Links</h6>
          <div id="recentLinksList">
            <p class="text-muted">No payment links generated yet</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- E-commerce Product Management -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>E-commerce Product Management</h5>
        
        <div class="row mb-4">
          <div class="col-md-6">
            <h6>Add Product</h6>
            <form id="addProductForm">
              <div class="form-group mb-2">
                <input type="text" id="pname" class="form-control" placeholder="Product Name" required>
              </div>
              <div class="form-group mb-2">
                <input type="number" id="pprice" class="form-control" placeholder="Price (₹)" required>
              </div>
              <div class="form-group mb-2">
                <input type="text" id="pimage" class="form-control" placeholder="Image URL" required>
              </div>
              <div class="form-group mb-2">
                <textarea id="pdesc" class="form-control" placeholder="Description" rows="3" required></textarea>
              </div>
              <div class="form-group mb-2">
                <input type="number" id="pstock" class="form-control" placeholder="Stock Quantity" required>
              </div>
              <button type="submit" class="btn btn-primary">Add Product</button>
            </form>
          </div>
        </div>
        
        <h6>Orders</h6>
        <div class="table-responsive">
          <table class="table table-bordered" id="ordersTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Customer</th>
                <th>Address</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="orders"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Ads Management -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Ads Management</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Ad Type</label>
            <select id="adType" class="form-select">
              <option value="banner">Banner (image)</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Upload File</label>
            <input id="adFile" type="file" class="form-control" accept="image/*,video/*"/>
            <div class="form-text">File will be uploaded to Firebase Storage. Use PNG/JPG for banners, MP4 for videos.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Or Media URL</label>
            <input id="adUrl" class="form-control" placeholder="https://... (optional)"/>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Placement</label>
            <select id="adPlacement" class="form-select">
              <option value="dashboard_top">Dashboard Top</option>
              <option value="dashboard_footer">Dashboard Footer</option>
              <option value="login_interstitial">Login Interstitial</option>
              <option value="email_banner">Email Banner</option>
              <option value="premium_access">Premium Access</option>
            </select>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Active</label>
            <select id="adActive" class="form-select">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Click URL</label>
            <input id="adClickUrl" class="form-control" placeholder="https://... (optional)"/>
          </div>
          <div class="col-md-4 d-flex align-items-end mt-2">
            <button id="uploadAdBtn" class="btn btn-primary w-100">Upload / Save Ad</button>
          </div>
        </div>
        <hr/>
        <h6>Existing Ads</h6>
        <div id="adsList"></div>
      </div>
    </div>
    
    <!-- Ads Analytics -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Ads Analytics</h5>
        
        <div class="analytics-stats">
          <div class="analytics-stat">
            <h3 id="totalAdImpressions">0</h3>
            <p>Total Impressions</p>
          </div>
          <div class="analytics-stat">
            <h3 id="totalAdClicks">0</h3>
            <p>Total Clicks</p>
          </div>
          <div class="analytics-stat">
            <h3 id="avgCtr">0%</h3>
            <p>Average CTR</p>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Ad Placement</th>
                <th>Impressions</th>
                <th>Clicks</th>
                <th>CTR</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="adsAnalyticsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Approved Users -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Approved Users</h5>
        <div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Name</th><th>Role</th><th>Plan</th><th>Action</th></tr></thead><tbody id="approvedUsersTable"></tbody></table></div>
      </div>
    </div>
    <!-- Movement History -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Movement History</h5>
        <select id="historyUserSelect" class="form-select mb-2"><option value="">Select User</option></select>
        <button class="btn btn-secondary mb-2" id="loadHistoryBtn">Load History</button>
        <div id="historyMap" style="height:300px;"></div>
        <button class="btn btn-danger mt-2" id="deleteHistoryBtn" style="display:none">Delete All History</button>
      </div>
    </div>
  </div>
  
  <div class="notification" id="notification">Link copied to clipboard!</div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
  authDomain: "svms-c0232.firebaseapp.com",
  databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
  projectId: "svms-c0232",
  storageBucket: "svms-c0232.appspot.com",
  messagingSenderId: "359201898609",
  appId: "1:359201898609:web:893ef076207abb06471bd0"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// Debug utility
const debugEl = document.getElementById('debugLog');
function logDebug(...args) {
  const timestamp = new Date().toISOString();
  const s = `[${timestamp}] ${args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ')}`;
  debugEl.textContent = (debugEl.textContent || '') + s + '\n';
  debugEl.scrollTop = debugEl.scrollHeight;
  console.log(...args);
}

// Escape helper
function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]);
}

// AUTH & INITIALIZE
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    logDebug('No user logged in, redirecting to login');
    return location.href = 'login.html';
  }
  const snap = await db.ref(`users/${user.uid}`).once('value');
  const u = snap.val();
  if (!u || !(u.role === 'super-admin' || u.role === 'admin' || u.isAdmin === true || u.admin === true)) {
    logDebug('User is not admin, redirecting to dashboard');
    return location.href = 'dashboard.html';
  }
  logDebug('Admin authenticated:', user.uid);
  init(user.uid);
});

document.getElementById('logoutBtn').onclick = () => {
  auth.signOut().then(() => {
    logDebug('Logged out successfully');
    location.href = 'login.html';
  }).catch(err => logDebug('Logout error:', err));
};

function init(adminUid) {
  setupLiveMap();
  setupHistoryMap();
  loadStats();
  loadPendingApprovals();
  loadApprovedUsers();
  loadUserDropdowns();
  loadPendingSubscriptions();
  loadPurchaseRequests();
  loadAds();
  setupPaymentLinkGenerator();
  setupEcommerce();
  loadAdsAnalytics();
  
  document.getElementById('uploadAdBtn').onclick = handleUploadAd;
  document.getElementById('loadHistoryBtn').onclick = handleLoadHistory;
  logDebug('Initialized for admin:', adminUid);
}

// Stats
function loadStats() {
  db.ref('users').once('value').then(snap => {
    const users = snap.val() || {};
    let companiesSet = new Set(), vehicles = 0, deliveries = 0, alerts = 0;
    for (const uid in users) {
      const u = users[uid];
      if (u && u.vehicle && u.vehicle.companies) {
        Object.keys(u.vehicle.companies).forEach(cn => companiesSet.add(cn));
        Object.values(u.vehicle.companies).forEach(comp => {
          const vehs = comp.vehicle || {};
          vehicles += Object.keys(vehs).length;
          Object.values(vehs).forEach(v => {
            if (v && v.deliveries) {
              const d = v.deliveries;
              deliveries += (typeof d === 'object' && !Array.isArray(d)) ? Object.keys(d).length : (Array.isArray(d) ? d.length : 0);
            }
          });
        });
      } else if (u && u.vehicles) {
        vehicles += Object.keys(u.vehicles).length;
      }
      if (u && u.vehicle && u.vehicle.last_trigger && u.vehicle.last_trigger.status === 'alert') alerts++;
    }
    document.getElementById('totalCompanies').innerText = companiesSet.size;
    document.getElementById('totalVehicles').innerText = vehicles;
    document.getElementById('totalDeliveries').innerText = deliveries;
    document.getElementById('alertsToday').innerText = alerts;
    logDebug('Stats loaded:', { companies: companiesSet.size, vehicles, deliveries, alerts });
  }).catch(err => logDebug('loadStats error:', err));
}

// Pending User Approvals
function loadPendingApprovals() {
  const list = document.getElementById("pendingUsersList");
  list.innerHTML = '<li class="list-group-item text-muted">Loading...</li>';
  db.ref("users").once("value", snap => {
    const users = snap.val() || {};
    let found = false;
    list.innerHTML = '';
    for (const uid in users) {
      const u = users[uid];
      if ((u.role === "company" || u.role === "customer") && u.approved !== true) {
        found = true;
        const name = u.companyName || u.email || uid;
        list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
          ${escapeHtml(name)} (${u.role})
          <span>
            <button class="btn btn-success btn-sm me-1" onclick="window.approve('${uid}')">Approve</button>
            <button class="btn btn-danger btn-sm" onclick="window.reject('${uid}')">Reject</button>
          </span>
        </li>`;
      }
    }
    if (!found) list.innerHTML = '<li class="list-group-item text-muted">No pending approvals.</li>';
    logDebug('Pending approvals loaded:', found ? 'Found pending users' : 'No pending users');
  }).catch(err => {
    list.innerHTML = '<li class="list-group-item text-muted">Error loading approvals</li>';
    logDebug('loadPendingApprovals error:', err);
  });
}
window.approve = function(uid) {
  db.ref(`users/${uid}`).update({ approved: true })
    .then(() => {
      alert("✅ Approved");
      loadPendingApprovals();
      loadApprovedUsers();
      logDebug(`User approved: ${uid}`);
    })
    .catch(err => {
      alert("Error approving: " + err.message);
      logDebug("Approve error:", err);
    });
};
window.reject = function(uid) {
  if (confirm("Delete user?")) {
    db.ref(`users/${uid}`).remove()
      .then(() => {
        alert("❌ Rejected and removed");
        loadPendingApprovals();
        loadApprovedUsers();
        logDebug(`User rejected and removed: ${uid}`);
      })
      .catch(err => {
        alert("Error rejecting: " + err.message);
        logDebug("Reject error:", err);
      });
  }
};

// Subscription Plan Upgrade Approvals
function loadPendingSubscriptions() {
  const subscriptionPendingList = document.getElementById('subscriptionPendingList');
  subscriptionPendingList.innerHTML = '<li class="list-group-item text-muted">Loading...</li>';
  db.ref('users').on('value', snap => {
    const users = snap.val() || {};
    subscriptionPendingList.innerHTML = '';
    let any = false;
    Object.entries(users).forEach(([uid, u]) => {
      if (u && u.upgrade_request && u.upgrade_request.status === 'pending' && u.upgrade_request.requestedPlan) {
        any = true;
        const planLabel = (u.upgrade_request.requestedPlan || '').toUpperCase();
        const name = u.companyName || u.email || uid;
        const requestTime = u.upgrade_request.request_time || '';
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `<div>
            <strong>${escapeHtml(name)}</strong> <small class="text-muted">UID: ${uid}</small>
            <div class="small">Request: <b>${planLabel}</b> <span class="pill-pending">Pending</span></div>
            <div class="small text-muted">${escapeHtml(requestTime)}</div>
          </div>`;
        const actions = document.createElement('div');
        const approveBtn = document.createElement('button');
        approveBtn.className = 'btn btn-success btn-sm me-2';
        approveBtn.innerText = 'Approve';
        approveBtn.onclick = function() { window.approveSubscriptionPlan(uid, planLabel, name); };
        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'btn btn-danger btn-sm';
        rejectBtn.innerText = 'Reject';
        rejectBtn.onclick = function() { window.rejectSubscriptionPlan(uid, planLabel, name); };
        actions.appendChild(approveBtn);
        actions.appendChild(rejectBtn);
        li.appendChild(actions);
        subscriptionPendingList.appendChild(li);
      }
    });
    if (!any) subscriptionPendingList.innerHTML = `<li class="list-group-item text-muted">No pending subscription upgrades.</li>`;
    logDebug('Pending subscriptions loaded:', any ? 'Found pending requests' : 'No pending requests');
  }, err => {
    subscriptionPendingList.innerHTML = `<li class="list-group-item text-muted">Error loading subscriptions</li>`;
    logDebug('loadPendingSubscriptions error:', err);
  });
}

function approveSubscriptionPlan(uid, plan, name) {
  if (!uid || !plan) return alert('Missing info');
  let days = parseFloat(prompt('Expiry days from now? Default 30', '30')) || 30;
  let expiry = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString();
  const PLAN_POLICIES = {
    basic: { vehicle_limit: 1, exportCSV: false },
    silver: { vehicle_limit: 3, exportCSV: true },
    gold: { vehicle_limit: 3, exportCSV: true }
  };
  let planLower = plan.toLowerCase();
  let settings = PLAN_POLICIES[planLower] || PLAN_POLICIES.silver;
  const updates = {};
  updates[`users/${uid}/plan`] = planLower;
  updates[`users/${uid}/plan_expiry`] = expiry;
  updates[`users/${uid}/vehicle_limit`] = settings.vehicle_limit;
  updates[`users/${uid}/exportCSV`] = settings.exportCSV;
  updates[`users/${uid}/upgrade_request/status`] = 'approved';
  updates[`admin/subscription_approvals/${uid}_${Date.now()}`] = {
    adminBy: (auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)),
    uid, plan: planLower, name, time: new Date().toISOString()
  };
  db.ref().update(updates)
    .then(() => {
      alert('Subscription plan upgraded and approved.');
      logDebug(`Subscription approved for ${uid}: ${planLower}`);
    })
    .catch(err => {
      alert('Approve failed: ' + err.message);
      logDebug('approveSubscriptionPlan error:', err);
    });
}
window.approveSubscriptionPlan = approveSubscriptionPlan;

function rejectSubscriptionPlan(uid, plan, name) {
  if (!uid) return;
  if (!confirm('Reject upgrade for user ' + name + '?')) return;
  const updates = {};
  updates[`users/${uid}/upgrade_request/status`] = 'rejected';
  updates[`admin/subscription_approvals/${uid}_${Date.now()}`] = {
    adminBy: (auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)),
    uid, plan: plan.toLowerCase(), name, status: 'rejected', time: new Date().toISOString()
  };
  db.ref().update(updates)
    .then(() => {
      alert('Upgrade request rejected.');
      logDebug(`Subscription rejected for ${uid}: ${plan}`);
    })
    .catch(err => {
      alert('Reject failed: ' + err.message);
      logDebug('rejectSubscriptionPlan error:', err);
    });
}
window.rejectSubscriptionPlan = rejectSubscriptionPlan;

// In-App Purchase Approvals
function loadPurchaseRequests() {
  const table = document.getElementById('purchaseRequestsTable');
  table.innerHTML = '<tr><td colspan="7" class="text-muted">Loading...</td></tr>';
  db.ref('admin/payments').on('value', snap => {
    const payments = snap.val() || {};
    table.innerHTML = '';
    let any = false;
    Object.entries(payments).reverse().forEach(([paymentId, payment]) => {
      if (!payment || payment.status !== 'pending') return;
      any = true;
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(payment.user || payment.uid || 'N/A')}</td>
        <td>${escapeHtml(payment.feature || 'N/A')}</td>
        <td>${payment.currency === 'inr' ? '₹' : '$'}${payment.amount || '0'}</td>
        <td>${escapeHtml(payment.payment_method || 'N/A')}</td>
        <td>${escapeHtml(payment.transaction_id || payment.payment_intent_id || 'N/A')}</td>
        <td><span class="pill-pending">Pending</span></td>
        <td>
          <button class="btn btn-success btn-sm me-1" onclick="window.approvePurchase('${paymentId}', '${payment.uid}', '${payment.feature}')">Approve</button>
          <button class="btn btn-danger btn-sm" onclick="window.rejectPurchase('${paymentId}')">Reject</button>
        </td>
      `;
      table.appendChild(row);
    });
    if (!any) {
      table.innerHTML = '<tr><td colspan="7" class="text-muted">No pending purchase requests</td></tr>';
    }
    logDebug('Purchase requests loaded:', any ? 'Found pending requests' : 'No pending requests');
  }, err => {
    table.innerHTML = '<tr><td colspan="7" class="text-muted">Error loading purchase requests</td></tr>';
    logDebug('loadPurchaseRequests error:', err);
  });
}

window.approvePurchase = function(paymentId, uid, feature) {
  if (!confirm(`Approve this ${feature} purchase?`)) return;
  const expiry = new Date(Date.now() + (feature === 'export' ? 24 * 60 * 60 * 1000 : 30 * 24 * 60 * 60 * 1000)).toISOString();
  const updates = {};
  updates[`users/${uid}/purchases/${feature}`] = {
    feature: feature,
    purchase_time: new Date().toISOString(),
    expiry: expiry,
    approved_by: auth.currentUser.email || auth.currentUser.uid,
    approved_at: new Date().toISOString()
  };
  updates[`users/${uid}/purchases_pending/${paymentId}/status`] = 'approved';
  updates[`admin/payments/${paymentId}/status`] = 'approved';
  updates[`admin/payments/${paymentId}/approved_by`] = auth.currentUser.email || auth.currentUser.uid;
  updates[`admin/payments/${paymentId}/approved_at`] = new Date().toISOString();
  db.ref().update(updates)
    .then(() => {
      alert('Purchase approved!');
      logDebug(`Purchase approved: ${paymentId}, feature: ${feature}, uid: ${uid}`);
    })
    .catch(err => {
      alert('Error: ' + err.message);
      logDebug('approvePurchase error:', err);
    });
};

window.rejectPurchase = function(paymentId) {
  if (!confirm('Reject this purchase request?')) return;
  const updates = {};
  updates[`admin/payments/${paymentId}/status`] = 'rejected';
  updates[`admin/payments/${paymentId}/rejected_by`] = auth.currentUser.email || auth.currentUser.uid;
  updates[`admin/payments/${paymentId}/rejected_at`] = new Date().toISOString();
  db.ref().update(updates)
    .then(() => {
      alert('Purchase rejected!');
      logDebug(`Purchase rejected: ${paymentId}`);
    })
    .catch(err => {
      alert('Error: ' + err.message);
      logDebug('rejectPurchase error:', err);
    });
};

// Payment Link Generator
function setupPaymentLinkGenerator() {
  const generateBtn = document.getElementById('generateBtn');
  const productInput = document.getElementById('productName');
  const amountInput = document.getElementById('amount');
  const currencySelect = document.getElementById('currency');
  const descriptionInput = document.getElementById('description');
  const linkContainer = document.getElementById('linkContainer');
  const paymentLink = document.getElementById('paymentLink');
  const copyBtn = document.getElementById('copyBtn');
  const shareBtn = document.getElementById('shareBtn');
  const notification = document.getElementById('notification');
  
  // Generate payment link
  generateBtn.addEventListener('click', function() {
    const product = productInput.value.trim();
    const amount = amountInput.value.trim();
    
    if (!product) {
      alert('Please enter a product/service name');
      productInput.focus();
      return;
    }
    
    if (!amount || parseFloat(amount) <= 0) {
      alert('Please enter a valid amount');
      amountInput.focus();
      return;
    }
    
    // Generate a unique payment ID
    const paymentId = 'pay_' + Math.random().toString(36).substr(2, 9);
    
    // Create payment link
    const baseUrl = window.location.href.replace(/[^/]*$/, '');
    const link = `${baseUrl}payment.html?payment_id=${paymentId}&product=${encodeURIComponent(product)}&amount=${amount}&currency=${currencySelect.value}&description=${encodeURIComponent(descriptionInput.value)}`;
    
    // Display the link
    paymentLink.textContent = link;
    linkContainer.style.display = 'block';
    
    // Save to recent links
    saveToRecentLinks(paymentId, product, amount, currencySelect.value, descriptionInput.value);
    
    // Scroll to link
    linkContainer.scrollIntoView({ behavior: 'smooth' });
  });
  
  // Copy link to clipboard
  copyBtn.addEventListener('click', function() {
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = paymentLink.textContent;
    document.body.appendChild(tempTextArea);
    tempTextArea.select();
    document.execCommand('copy');
    document.body.removeChild(tempTextArea);
    
    showNotification('Link copied to clipboard!');
  });
  
  // Share link
  shareBtn.addEventListener('click', function() {
    if (navigator.share) {
      navigator.share({
        title: 'Payment Link',
        text: `Please make a payment for ${productInput.value}`,
        url: paymentLink.textContent
      })
      .catch(error => {
        console.log('Error sharing:', error);
      });
    } else {
      showNotification('Web Share API not supported in your browser');
    }
  });
  
  // Show notification
  function showNotification(message) {
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }
  
  // Save to recent links
  function saveToRecentLinks(id, product, amount, currency, description) {
    let recentLinks = JSON.parse(localStorage.getItem('paymentLinks')) || [];
    
    // Add new link to beginning of array
    recentLinks.unshift({
      id: id,
      product: product,
      amount: amount,
      currency: currency,
      description: description,
      date: new Date().toISOString(),
      status: Math.random() > 0.5 ? 'paid' : 'pending' // Random status for demo
    });
    
    // Keep only the last 5 links
    if (recentLinks.length > 5) {
      recentLinks = recentLinks.slice(0, 5);
    }
    
    // Save to localStorage
    localStorage.setItem('paymentLinks', JSON.stringify(recentLinks));
    
    // Update UI
    displayRecentLinks();
  }
  
  // Display recent links
  function displayRecentLinks() {
    const recentLinksList = document.getElementById('recentLinksList');
    const recentLinks = JSON.parse(localStorage.getItem('paymentLinks')) || [];
    
    if (recentLinks.length === 0) {
      recentLinksList.innerHTML = '<p class="text-muted">No payment links generated yet</p>';
      return;
    }
    
    recentLinksList.innerHTML = '';
    
    recentLinks.forEach(link => {
      const linkElement = document.createElement('div');
      linkElement.className = 'link-item';
      
      linkElement.innerHTML = `
        <div class="link-details">
          <h6>${link.product}</h6>
          <p>${formatCurrency(link.amount, link.currency)} • ${new Date(link.date).toLocaleDateString()}</p>
        </div>
        <div class="link-actions">
          <span class="status-badge status-${link.status}">${link.status}</span>
        </div>
      `;
      
      recentLinksList.appendChild(linkElement);
    });
  }
  
  // Format currency
  function formatCurrency(amount, currency) {
    const numericAmount = parseFloat(amount) || 0;
    
    switch(currency) {
      case 'USD':
        return '$' + numericAmount.toFixed(2);
      case 'EUR':
        return '€' + numericAmount.toFixed(2);
      case 'GBP':
        return '£' + numericAmount.toFixed(2);
      default:
        return '₹' + numericAmount.toFixed(2);
    }
  }
  
  // Initialize
  displayRecentLinks();
}

// E-commerce Product Management
function setupEcommerce() {
  // Add product
  document.getElementById("addProductForm").addEventListener("submit", function(e){
    e.preventDefault();
    let product = {
      name: document.getElementById("pname").value,
      price: document.getElementById("pprice").value,
      image: document.getElementById("pimage").value,
      description: document.getElementById("pdesc").value,
      stock: document.getElementById("pstock").value
    };
    let newKey = db.ref("products").push().key;
    db.ref("products/" + newKey).set(product);
    alert("✅ Product added!");
    document.getElementById("addProductForm").reset();
  });

  // Show orders
  db.ref("orders").on("value", snapshot => {
    let data = snapshot.val();
    let ordersDiv = document.getElementById("orders");
    ordersDiv.innerHTML = "";
    
    if (!data) {
      ordersDiv.innerHTML = '<tr><td colspan="5" class="text-muted">No orders found</td></tr>';
      return;
    }
    
    for (let id in data) {
      let o = data[id];
      ordersDiv.innerHTML += `
        <tr>
          <td data-label="Product">${o.productName || 'N/A'}</td>
          <td data-label="Price">₹${o.price || '0'}</td>
          <td data-label="Customer">${o.email || 'N/A'}</td>
          <td data-label="Address">${o.address || 'N/A'}, ${o.state || ''}, ${o.country || ''}</td>
          <td data-label="Status">${o.status || 'Pending'}</td>
        </tr>
      `;
    }
  });
}

// Ads Analytics
function loadAdsAnalytics() {
  db.ref('admin/ads').once('value').then(snap => {
    const ads = snap.val() || {};
    const analyticsTable = document.getElementById('adsAnalyticsTable');
    analyticsTable.innerHTML = '';
    
    let totalImpressions = 0;
    let totalClicks = 0;
    
    Object.entries(ads).forEach(([key, ad]) => {
      const impressions = ad.impressions || 0;
      const clicks = ad.clicks || 0;
      const ctr = impressions > 0 ? ((clicks / impressions) * 100).toFixed(2) : 0;
      
      totalImpressions += impressions;
      totalClicks += clicks;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escapeHtml(ad.placement || 'N/A')}</td>
        <td>${impressions}</td>
        <td>${clicks}</td>
        <td>${ctr}%</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="viewAdDetails('${key}')">Details</button>
          <button class="btn btn-sm btn-warning" onclick="resetAdStats('${key}')">Reset</button>
        </td>
      `;
      analyticsTable.appendChild(row);
    });
    
    // Update summary stats
    document.getElementById('totalAdImpressions').innerText = totalImpressions;
    document.getElementById('totalAdClicks').innerText = totalClicks;
    document.getElementById('avgCtr').innerText = totalImpressions > 0 ? 
      ((totalClicks / totalImpressions) * 100).toFixed(2) + '%' : '0%';
    
    if (Object.keys(ads).length === 0) {
      analyticsTable.innerHTML = '<tr><td colspan="5" class="text-muted">No ads available for analytics</td></tr>';
    }
    
    logDebug('Ads analytics loaded');
  }).catch(err => {
    logDebug('loadAdsAnalytics error:', err);
  });
}

window.viewAdDetails = function(adKey) {
  db.ref(`admin/ads/${adKey}`).once('value').then(snap => {
    const ad = snap.val();
    if (!ad) return;
    
    const modalHtml = `
      <div class="modal fade" id="adDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Ad Details: ${ad.placement}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Type:</strong> ${ad.type}</p>
                  <p><strong>Impressions:</strong> ${ad.impressions || 0}</p>
                  <p><strong>Clicks:</strong> ${ad.clicks || 0}</p>
                  <p><strong>CTR:</strong> ${ad.impressions > 0 ? ((ad.clicks / ad.impressions) * 100).toFixed(2) : 0}%</p>
                  <p><strong>Status:</strong> ${ad.active ? 'Active' : 'Inactive'}</p>
                </div>
                <div class="col-md-6">
                  ${ad.type === 'banner' ? 
                    `<img src="${ad.url}" style="max-width: 100%; border-radius: 8px;">` : 
                    `<video controls style="max-width: 100%; border-radius: 8px;">
                      <source src="${ad.url}" type="video/mp4">
                    </video>`
                  }
                </div>
              </div>
              ${ad.clickUrl ? `<p class="mt-3"><strong>Click URL:</strong> <a href="${ad.clickUrl}" target="_blank">${ad.clickUrl}</a></p>` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to DOM if not already there
    if (!document.getElementById('adDetailsModal')) {
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    } else {
      document.getElementById('adDetailsModal').remove();
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('adDetailsModal'));
    modal.show();
    
  }).catch(err => {
    logDebug('viewAdDetails error:', err);
  });
};

window.resetAdStats = function(adKey) {
  if (!confirm('Are you sure you want to reset the statistics for this ad?')) return;
  
  const updates = {};
  updates[`admin/ads/${adKey}/impressions`] = 0;
  updates[`admin/ads/${adKey}/clicks`] = 0;
  
  db.ref().update(updates)
    .then(() => {
      alert('Ad statistics reset successfully!');
      loadAdsAnalytics();
      logDebug(`Ad stats reset for: ${adKey}`);
    })
    .catch(err => {
      alert('Error resetting ad statistics: ' + err.message);
      logDebug('resetAdStats error:', err);
    });
};

// Ads Management
function loadAds() {
  const adsList = document.getElementById('adsList');
  adsList.innerHTML = '<div class="text-muted">Loading ads…</div>';
  db.ref('admin/ads').once('value').then(snap => {
    const ads = snap.val() || {};
    adsList.innerHTML = '';
    if (!Object.keys(ads).length) {
      adsList.innerHTML = '<div class="text-muted">No ads available.</div>';
      logDebug('No ads found in admin/ads');
      return;
    }
    Object.entries(ads).reverse().forEach(([key, ad]) => {
      const div = document.createElement('div');
      div.className = 'mb-2 p-2 border rounded bg-white';
      const created = ad.createdAt || '';
      const impressions = ad.impressions || 0;
      const clicks = ad.clicks || 0;
      const ctr = impressions > 0 ? ((clicks / impressions) * 100).toFixed(2) : 0;
      
      div.innerHTML = `
        <div>
          <strong>Placement:</strong> ${escapeHtml(ad.placement || '')} · 
          <strong>Type:</strong> ${escapeHtml(ad.type || '')} · 
          <strong>Active:</strong> ${ad.active ? '<span class="pill-approved">Active</span>' : '<span class="pill-rejected">Inactive</span>'} · 
          <strong>Impressions:</strong> ${impressions} · 
          <strong>Clicks:</strong> ${clicks} · 
          <strong>CTR:</strong> ${ctr}%
          <small class="text-muted">${escapeHtml(created)}</small>
        </div>`;
      const content = document.createElement('div');
      content.className = 'ad-container';
      const link = document.createElement('a');
      if (ad.clickUrl) {
        link.href = ad.clickUrl;
        link.target = '_blank';
        link.className = 'clickable-ad';
      }
      if (ad.type === 'banner') {
        const img = document.createElement('img');
        img.src = ad.url || '';
        img.style.maxWidth = '320px';
        img.style.height = 'auto';
        img.style.borderRadius = '6px';
        img.className = ad.clickUrl ? '' : 'clickable-ad';
        img.onload = () => logDebug(`Ad image loaded: ${ad.url}`);
        img.onerror = () => {
          content.innerHTML = '<div class="ad-error">Failed to load ad image</div>';
          logDebug(`Ad image failed to load: ${ad.url}`);
        };
        link.appendChild(img);
        content.appendChild(link);
      } else if (ad.type === 'video') {
        const video = document.createElement('video');
        video.controls = true;
        video.muted = true;
        video.style.maxWidth = '320px';
        video.style.borderRadius = '6px';
        video.className = ad.clickUrl ? '' : 'clickable-ad';
        const source = document.createElement('source');
        source.src = ad.url || '';
        source.type = 'video/mp4'; // Assume MP4; adjust if needed
        video.appendChild(source);
        video.onloadeddata = () => logDebug(`Ad video loaded: ${ad.url}`);
        video.onerror = () => {
          content.innerHTML = '<div class="ad-error">Failed to load ad video</div>';
          logDebug(`Ad video failed to load: ${ad.url}`);
        };
        link.appendChild(video);
        content.appendChild(link);
      } else {
        content.innerHTML = '<div class="ad-error">Invalid ad type</div>';
        logDebug(`Invalid ad type for key: ${key}`);
      }
      const btns = document.createElement('div');
      btns.className = 'mt-2';
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'btn btn-sm btn-outline-secondary me-2';
      toggleBtn.textContent = ad.active ? 'Deactivate' : 'Activate';
      toggleBtn.onclick = () => {
        db.ref(`admin/ads/${key}/active`).set(!ad.active).then(() => {
          loadAds();
          loadAdsAnalytics();
          logDebug(`Ad ${key} toggled to ${!ad.active ? 'active' : 'inactive'}`);
        }).catch(err => logDebug(`Toggle ad ${key} error:`, err));
      };
      const clickUrlBtn = document.createElement('button');
      clickUrlBtn.className = 'btn btn-sm btn-outline-primary me-2';
      clickUrlBtn.textContent = 'Edit Click URL';
      clickUrlBtn.onclick = () => {
        const newUrl = prompt('Enter new click URL (leave empty to remove):', ad.clickUrl || '');
        if (newUrl !== null) {
          db.ref(`admin/ads/${key}/clickUrl`).set(newUrl || null).then(() => {
            loadAds();
            logDebug(`Ad ${key} clickUrl updated to: ${newUrl || 'null'}`);
          }).catch(err => logDebug(`Update clickUrl for ${key} error:`, err));
        }
      };
      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-sm btn-danger';
      delBtn.textContent = 'Delete';
      delBtn.onclick = () => {
        if (!confirm('Delete this ad?')) return;
        db.ref(`admin/ads/${key}`).remove().then(() => {
          if (ad.storagePath) {
            storage.ref(ad.storagePath).delete().catch(err => logDebug(`Failed to delete storage file ${ad.storagePath}:`, err));
          }
          loadAds();
          loadAdsAnalytics();
          logDebug(`Ad ${key} deleted`);
        }).catch(err => logDebug(`Delete ad ${key} error:`, err));
      };
      btns.appendChild(toggleBtn);
      btns.appendChild(clickUrlBtn);
      btns.appendChild(delBtn);
      div.appendChild(content);
      div.appendChild(btns);
      adsList.appendChild(div);
    });
    logDebug('Ads loaded:', Object.keys(ads).length);
  }).catch(err => {
    adsList.innerHTML = '<div class="text-muted">Error loading ads</div>';
    logDebug('loadAds error:', err);
  });
}

async function handleUploadAd() {
  const uploadBtn = document.getElementById('uploadAdBtn');
  uploadBtn.disabled = true;
  uploadBtn.textContent = 'Uploading...';
  const placement = document.getElementById('adPlacement').value;
  const type = document.getElementById('adType').value;
  const active = document.getElementById('adActive').value === 'true';
  const urlProvided = (document.getElementById('adUrl').value || '').trim();
  const clickUrl = (document.getElementById('adClickUrl').value || '').trim();
  const file = document.getElementById('adFile').files[0];
  const key = db.ref('admin/ads').push().key;
  const createdAt = new Date().toISOString();
  const adMeta = { placement, type, active, createdAt, impressions: 0, clicks: 0 };

  if (clickUrl) {
    if (!/^https?:\/\//i.test(clickUrl)) {
      alert('Click URL must start with http:// or https://');
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload / Save Ad';
      return;
    }
    adMeta.clickUrl = clickUrl;
  }

  try {
    if (file) {
      const validImageTypes = ['image/jpeg', 'image/png'];
      const validVideoTypes = ['video/mp4', 'video/webm'];
      if (type === 'banner' && !validImageTypes.includes(file.type)) {
        alert('Please upload a PNG or JPG file for banner ads.');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload / Save Ad';
        return;
      }
      if (type === 'video' && !validVideoTypes.includes(file.type)) {
        alert('Please upload an MP4 or WebM file for video ads.');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload / Save Ad';
        return;
      }
      const path = `admin_ads/${key}/${file.name}`;
      const ref = storage.ref(path);
      await ref.put(file);
      const downloadUrl = await ref.getDownloadURL();
      adMeta.url = downloadUrl;
      adMeta.storagePath = path;
    } else if (urlProvided) {
      if (!/^https?:\/\//i.test(urlProvided)) {
        alert('Media URL must start with http:// or https://');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload / Save Ad';
        return;
      }
      adMeta.url = urlProvided;
    } else {
      alert('Provide a file or a URL.');
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload / Save Ad';
      return;
    }

    await db.ref(`admin/ads/${key}`).set(adMeta);
    document.getElementById('adFile').value = '';
    document.getElementById('adUrl').value = '';
    document.getElementById('adClickUrl').value = '';
    alert('Ad saved.');
    loadAds();
    loadAdsAnalytics();
    logDebug(`Ad uploaded: ${key}, type: ${type}, placement: ${placement}`);
  } catch (err) {
    alert('Upload failed: ' + err.message);
    logDebug('handleUploadAd error:', err);
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.textContent = 'Upload / Save Ad';
  }
}

// Approved users
function loadApprovedUsers() {
  const tbl = document.getElementById("approvedUsersTable");
  tbl.innerHTML = '<tr><td colspan="4" class="text-muted">Loading...</td></tr>';
  db.ref("users").once("value", snap => {
    const users = snap.val() || {};
    let rows = "";
    for (const uid in users) {
      const u = users[uid];
      if (u.approved === true && (u.role === "company" || u.role === "customer")) {
        rows += `<tr>
          <td>${escapeHtml(u.companyName || u.email || uid)}</td>
          <td>${escapeHtml(u.role)}</td>
          <td>${escapeHtml(u.plan || 'basic')}</td>
          <td><button class="btn btn-primary btn-sm" onclick="window.alert('Not implemented: details')">Open</button></td>
        </tr>`;
      }
    }
    tbl.innerHTML = rows || `<tr><td colspan="4" class="text-muted">No approved users found.</td></tr>`;
    logDebug('Approved users loaded:', rows ? 'Found users' : 'No users');
  }).catch(err => {
    tbl.innerHTML = `<tr><td colspan="4" class="text-muted">Error loading users</td></tr>`;
    logDebug('loadApprovedUsers error:', err);
  });
}

// User dropdown (for history map)
function loadUserDropdowns() {
  const sel = document.getElementById("historyUserSelect");
  sel.innerHTML = '<option value="">Select User</option>';
  db.ref("users").once("value", snap => {
    const users = snap.val() || {};
    for (const uid in users) {
      if (users[uid].role === "company" || users[uid].role === "customer") {
        sel.innerHTML += `<option value="${uid}">${escapeHtml(users[uid].companyName || users[uid].email || uid)}</option>`;
      }
    }
    logDebug('User dropdown loaded');
  }).catch(err => logDebug('loadUserDropdowns error:', err));
}

// Movement History by User
function setupLiveMap() {
  try {
    window.liveMap = L.map('map').setView([20, 78], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.liveMap);
    logDebug('Live map initialized');
  } catch (err) {
    logDebug('setupLiveMap error:', err);
  }
}

function setupHistoryMap() {
  try {
    window.historyMap = L.map('historyMap').setView([20, 78], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.historyMap);
    logDebug('History map initialized');
  } catch (err) {
    logDebug('setupHistoryMap error:', err);
  }
}

function handleLoadHistory() {
  const uid = document.getElementById("historyUserSelect").value;
  const btn = document.getElementById("deleteHistoryBtn");
  const historyMap = window.historyMap;
  if (!uid) {
    alert("Select user");
    btn.style.display = "none";
    logDebug('No user selected for history');
    return;
  }
  db.ref(`users/${uid}/vehicle/history`).once("value", snap => {
    const history = snap.val() || {};
    const coords = [];
    Object.values(history).forEach(h => {
      let loc = null;
      if (typeof h === "string" && h.includes(",")) loc = h;
      else if (h && h.location) loc = h.location;
      if (loc) {
        const [lat, lng] = loc.split(",").map(Number);
        if (!isNaN(lat) && !isNaN(lng)) coords.push([lat, lng]);
      }
    });
    if (coords.length === 0) {
      alert("No history");
      btn.style.display = "none";
      logDebug(`No history found for user: ${uid}`);
      return;
    }
    if (historyMap) {
      historyMap.eachLayer(layer => {
        if (layer instanceof L.Polyline || layer instanceof L.CircleMarker) historyMap.removeLayer(layer);
      });
      coords.forEach(c => L.circleMarker(c, { radius: 4, color: "red" }).addTo(historyMap));
      const poly = L.polyline(coords, { color: "blue" }).addTo(historyMap);
      historyMap.fitBounds(poly.getBounds());
      logDebug(`History loaded for user ${uid}: ${coords.length} points`);
    }
    btn.style.display = "inline-block";
    btn.onclick = () => deleteHistoryByUser(uid);
  }).catch(err => {
    alert("Error loading history: " + err.message);
    logDebug('handleLoadHistory error:', err);
  });
}

function deleteHistoryByUser(uid) {
  if (!confirm("Delete all movement history for this user?")) return;
  db.ref(`users/${uid}/vehicle/history`).set(null)
    .then(() => {
      alert("History deleted.");
      document.getElementById("deleteHistoryBtn").style.display = "none";
      logDebug(`History deleted for user: ${uid}`);
    })
    .catch(err => {
      alert("Error deleting: " + err.message);
      logDebug("History delete error:", err);
    });
}
  </script>
</body>
              </html>
