<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Super Admin - SVMS (Realtime DB) - Fixed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{background:#f8f9fa}
    .navbar{background:#0d6efd}
    .navbar-brand{color:#fff!important;font-weight:600}
    .card{border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    #map,#historyMap{height:400px;border-radius:8px}
    .stat-card{text-align:center;padding:18px;background:#fff;border-radius:10px}
    #debugLog{height:110px;overflow:auto;background:#fff;padding:10px;border-radius:6px;border:1px solid #e6e6e6;font-size:12px}
    .pill-pending{background:#ffd966;color:#4a2900;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-approved{background:#31ffa7;color:#167054;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-rejected{background:#f8d7da;color:#721c24;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
  </style>
</head>
<body>
  <nav class="navbar px-3">
    <a class="navbar-brand">Super Admin - SVMS (Realtime DB)</a>
    <button class="btn btn-light ms-auto" id="logoutBtn">Logout</button>
  </nav>

  <div class="container py-4">
    <div class="mb-3">
      <strong>Debug (visible):</strong>
      <pre id="debugLog">Loading...</pre>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalCompanies">0</h3><p>Total Companies</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalVehicles">0</h3><p>Total Vehicles</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalDeliveries">0</h3><p>Total Deliveries</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="alertsToday">0</h3><p>Alerts Today</p></div></div>
    </div>

    <!-- Live map -->
    <div class="card mb-4"><div class="card-body"><h5>Live Vehicle Locations</h5><div id="map"></div></div></div>

    <!-- Pending approvals -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Pending User Approvals</h5>
        <ul class="list-group" id="pendingUsersList"></ul>
      </div>
    </div>

    <!-- Subscription Approval Panel -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Subscription Plan Upgrade Requests</h5>
        <ul id="subscriptionPendingList" class="list-group mb-2"></ul>
        <div class="small text-muted">Approve or reject users' subscription upgrade requests (Silver, Gold are premium features).</div>
      </div>
    </div>

    <!-- Ads management (kept as before) -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Ads Management</h5>
        <!-- as before ...  -->
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Ad Type</label>
            <select id="adType" class="form-select">
              <option value="banner">Banner (image)</option>
              <option value="video">Video</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Upload File</label>
            <input id="adFile" type="file" class="form-control"/>
            <div class="form-text">File will be uploaded to Firebase Storage.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Or Media URL</label>
            <input id="adUrl" class="form-control" placeholder="https://... (optional)"/>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Placement</label>
            <select id="adPlacement" class="form-select">
              <option value="dashboard_top">Dashboard Top</option>
              <option value="dashboard_footer">Dashboard Footer</option>
              <option value="login_interstitial">Login Interstitial</option>
              <option value="email_banner">Email Banner</option>
            </select>
          </div>
          <div class="col-md-4 mt-2">
            <label class="form-label">Active</label>
            <select id="adActive" class="form-select">
              <option value="true">Active</option>
              <option value="false">Inactive</option>
            </select>
          </div>
          <div class="col-md-4 d-flex align-items-end mt-2">
            <button id="uploadAdBtn" class="btn btn-primary w-100">Upload / Save Ad</button>
          </div>
        </div>
        <hr/>
        <h6>Existing Ads</h6>
        <div id="adsList"></div>
      </div>
    </div>

    <!-- Approved users -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Approved Users</h5>
        <div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Name</th><th>Role</th><th>Plan</th><th>Action</th></tr></thead><tbody id="approvedUsersTable"></tbody></table></div>
      </div>
    </div>

    <!-- Movement history -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>Movement History</h5>
        <select id="historyUserSelect" class="form-select mb-2"><option value="">Select User</option></select>
        <button class="btn btn-secondary mb-2" id="loadHistoryBtn">Load History</button>
        <div id="historyMap" style="height:300px;"></div>
        <button class="btn btn-danger mt-2" id="deleteHistoryBtn" style="display:none">Delete All History</button>
      </div>
    </div>
  </div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // --- All code same as previous, except additional subscription approvals below ---
  // (cut for brevity, see prior post for full implementation
  // -- Add just the new section below into your main JS block!)

  // ... Firebase config, stats, map, user approval code unchanged ...

  // ====== SUBSCRIPTION PLAN APPROVAL PANEL ======

  const subscriptionPendingList = document.getElementById('subscriptionPendingList');

  // Listen for users with a pending upgrade request
  function loadPendingSubscriptions() {
    db.ref('users').on('value', snap => {
      const users = snap.val() || {};
      subscriptionPendingList.innerHTML = '';
      let any = false;
      Object.entries(users).forEach(([uid, u]) => {
        // Check for valid pending request
        if (u && u.upgrade_request && u.upgrade_request.status === 'pending' && u.upgrade_request.requestedPlan) {
          any = true;
          const planLabel = (u.upgrade_request.requestedPlan || '').toUpperCase();
          const name = u.companyName || u.email || uid;
          const requestTime = u.upgrade_request.request_time || '';
          const statusPill = '<span class="pill-pending">Pending</span>';
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <div>
              <strong>${escapeHtml(name)}</strong> <small class="text-muted">UID: ${uid}</small>
              <div class="small">Request: <b>${planLabel}</b> ${statusPill}</div>
              <div class="small text-muted">${escapeHtml(requestTime)}</div>
            </div>
          `;
          // Actions: Approve/Reject
          const actions = document.createElement('div');
          const approveBtn = document.createElement('button');
          approveBtn.className = 'btn btn-success btn-sm me-2';
          approveBtn.textContent = 'Approve';
          approveBtn.onclick = () => approveSubscriptionPlan(uid, planLabel, name);
          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'btn btn-danger btn-sm';
          rejectBtn.textContent = 'Reject';
          rejectBtn.onclick = () => rejectSubscriptionPlan(uid, planLabel, name);

          actions.appendChild(approveBtn);
          actions.appendChild(rejectBtn);
          li.appendChild(actions);
          subscriptionPendingList.appendChild(li);
        }
      });
      if (!any) subscriptionPendingList.innerHTML = `<li class="list-group-item text-muted">No pending subscription upgrades.</li>`;
    });
  }

  // Approve subscription plan
  function approveSubscriptionPlan(uid, plan, name) {
    if (!uid || !plan) return alert('Missing info');
    // Set expiry: ask admin how many days (default 30)
    let days = parseFloat(prompt('Expiry days from now? Default 30', '30')) || 30;
    let expiry = new Date(Date.now() + days*24*60*60*1000).toISOString();
    // Plan settings
    const PLAN_POLICIES = {
      basic: { vehicle_limit: 1, exportCSV: false },
      silver: { vehicle_limit: 3, exportCSV: true },
      gold: { vehicle_limit: 3, exportCSV: true }
    };
    let planLower = plan.toLowerCase();
    let settings = PLAN_POLICIES[planLower] || PLAN_POLICIES.silver;
    // Perform atomic updates
    const updates = {};
    updates[`users/${uid}/plan`] = planLower;
    updates[`users/${uid}/plan_expiry`] = expiry;
    updates[`users/${uid}/vehicle_limit`] = settings.vehicle_limit;
    updates[`users/${uid}/exportCSV`] = settings.exportCSV;
    updates[`users/${uid}/upgrade_request/status`] = 'approved';
    // record admin log
    updates[`admin/subscription_approvals/${uid}_${Date.now()}`] = {
      adminBy: (auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)),
      uid, plan: planLower, name, time: new Date().toISOString()
    };
    db.ref().update(updates).then(() => {
      alert('Subscription plan upgraded and approved.');
      loadPendingSubscriptions();
    }).catch(err => alert('Approve failed: ' + err.message));
  }

  // Reject subscription plan
  function rejectSubscriptionPlan(uid, plan, name) {
    if (!uid) return;
    if (!confirm('Reject upgrade for user '+name+'?')) return;
    db.ref(`users/${uid}/upgrade_request/status`).set('rejected')
      .then(() => {
        alert('Upgrade request rejected.');
        loadPendingSubscriptions();
      })
      .catch(err => alert('Reject failed: ' + err.message));
  }

  // Escape HTML helper
  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return String(s).replace(/[&<>"'`=\/]/g, function (c) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];
    });
  }

  // === Call panel loader on page init ===
  document.addEventListener('DOMContentLoaded', ()=> {
    loadPendingSubscriptions();
  });

  // ... rest of your original JS (stats, ads, history, maps, approvals) unchanged ...

  </script>
</body>
</html>
