<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Super Admin - SVMS (Realtime DB) - Full</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body{background:#f8f9fa}
    .navbar{background:#0d6efd}
    .navbar-brand{color:#fff!important;font-weight:600}
    .card{border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    #map,#historyMap{height:400px;border-radius:8px}
    .stat-card{text-align:center;padding:18px;background:#fff;border-radius:10px}
    #debugLog{height:110px;overflow:auto;background:#fff;padding:10px;border-radius:6px;border:1px solid #e6e6e6;font-size:12px}
    .pill-pending{background:#ffd966;color:#4a2900;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-approved{background:#31ffa7;color:#167054;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
    .pill-rejected{background:#f8d7da;color:#721c24;border-radius:8px;padding:5px 12px;font-weight:700;display:inline-block}
  </style>
</head>
<body>
  <nav class="navbar px-3">
    <a class="navbar-brand">Super Admin - SVMS (Realtime DB)</a>
    <button class="btn btn-light ms-auto" id="logoutBtn">Logout</button>
  </nav>
  <div class="container py-4">
    <div class="mb-3">
      <strong>Debug (visible):</strong>
      <pre id="debugLog">Loading...</pre>
    </div>
    <div class="row g-3 mb-4">
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalCompanies">0</h3><p>Total Companies</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalVehicles">0</h3><p>Total Vehicles</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="totalDeliveries">0</h3><p>Total Deliveries</p></div></div>
      <div class="col-6 col-md-3"><div class="stat-card"><h3 id="alertsToday">0</h3><p>Alerts Today</p></div></div>
    </div>

    <div class="card mb-4"><div class="card-body"><h5>Live Vehicle Locations</h5><div id="map"></div></div></div>
    <div class="card mb-4">
      <div class="card-body">
        <h5>Pending User Approvals</h5>
        <ul class="list-group" id="pendingUsersList"></ul>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h5>Subscription Plan Upgrade Requests</h5>
        <ul id="subscriptionPendingList" class="list-group mb-2"></ul>
        <div class="small text-muted">Approve/reject users' Silver/Gold upgrade requests.</div>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h5>Ads Management</h5>
        <div class="row g-2">
          <!-- Ads upload form omitted for brevity, see previous code for full implementation -->
        </div>
        <hr/>
        <h6>Existing Ads</h6>
        <div id="adsList"></div>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h5>Approved Users</h5>
        <div class="table-responsive"><table class="table table-bordered"><thead><tr><th>Name</th><th>Role</th><th>Plan</th><th>Action</th></tr></thead><tbody id="approvedUsersTable"></tbody></table></div>
      </div>
    </div>
    <div class="card mb-4">
      <div class="card-body">
        <h5>Movement History</h5>
        <select id="historyUserSelect" class="form-select mb-2"><option value="">Select User</option></select>
        <button class="btn btn-secondary mb-2" id="loadHistoryBtn">Load History</button>
        <div id="historyMap" style="height:300px;"></div>
        <button class="btn btn-danger mt-2" id="deleteHistoryBtn" style="display:none">Delete All History</button>
      </div>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  // ...Firebase config as shown above...

  // Debug and utility helpers...
  function logDebug(...args){
    const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a,null,2) : String(a))).join(' ');
    debugEl.textContent = (debugEl.textContent || '') + s + '\n';
    debugEl.scrollTop = debugEl.scrollHeight; console.log(...args);
  }
  function escapeHtml(s){
    if(!s && s !== 0) return '';
    return String(s).replace(/[&<>"'`=\/]/g, function (c) {return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];});
  }

  // ---- ADMIN GUARD ----
  auth.onAuthStateChanged(async (user) => {
    if (!user) return location.href = 'login.html';
    const snap = await db.ref(`users/${user.uid}`).once('value');
    const u = snap.val();
    const isSuperAdmin = u && (u.role === 'super-admin' || u.role === 'admin' || u.isAdmin === true || u.admin === true);
    if(!isSuperAdmin) return location.href = 'dashboard.html';
    init(user.uid);
  });
  logoutBtn.onclick = () => auth.signOut().then(()=>location.href='login.html');

  function init(adminUid){
    setupLiveMap(); setupHistoryMap(); loadStats(); loadPendingApprovals(); loadApprovedUsers(); loadUserDropdowns(); loadAds();
    uploadAdBtn && (uploadAdBtn.onclick = handleUploadAd);
    loadHistoryBtn && (loadHistoryBtn.onclick = handleLoadHistory);
    loadPendingSubscriptions();
    logDebug('Initialized for admin: ', adminUid);
  }

  // ---- SUBSCRIPTION PLAN APPROVAL ----
  const subscriptionPendingList = document.getElementById('subscriptionPendingList');
  function loadPendingSubscriptions() {
    db.ref('users').on('value', snap => {
      const users = snap.val() || {};
      subscriptionPendingList.innerHTML = '';
      let any = false;
      Object.entries(users).forEach(([uid, u]) => {
        if (u && u.upgrade_request && u.upgrade_request.status === 'pending' && u.upgrade_request.requestedPlan) {
          any = true;
          const planLabel = (u.upgrade_request.requestedPlan || '').toUpperCase();
          const name = u.companyName || u.email || uid;
          const requestTime = u.upgrade_request.request_time || '';
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<div>
              <strong>${escapeHtml(name)}</strong> <small class="text-muted">UID: ${uid}</small>
              <div class="small">Request: <b>${planLabel}</b> <span class="pill-pending">Pending</span></div>
              <div class="small text-muted">${escapeHtml(requestTime)}</div>
            </div>`;
          const actions = document.createElement('div');
          const approveBtn = document.createElement('button');
          approveBtn.className = 'btn btn-success btn-sm me-2';
          approveBtn.textContent = 'Approve';
          approveBtn.onclick = () => approveSubscriptionPlan(uid, planLabel, name);
          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'btn btn-danger btn-sm';
          rejectBtn.textContent = 'Reject';
          rejectBtn.onclick = () => rejectSubscriptionPlan(uid, planLabel, name);
          actions.appendChild(approveBtn); actions.appendChild(rejectBtn); li.appendChild(actions);
          subscriptionPendingList.appendChild(li);
        }
      });
      if (!any) subscriptionPendingList.innerHTML = `<li class="list-group-item text-muted">No pending subscription upgrades.</li>`;
    });
  }
  function approveSubscriptionPlan(uid, plan, name) {
    if (!uid || !plan) return alert('Missing info');
    let days = parseFloat(prompt('Expiry days from now? Default 30', '30')) || 30;
    let expiry = new Date(Date.now() + days*24*60*60*1000).toISOString();
    const PLAN_POLICIES = {
      basic: { vehicle_limit: 1, exportCSV: false },
      silver: { vehicle_limit: 3, exportCSV: true },
      gold: { vehicle_limit: 3, exportCSV: true }
    };
    let planLower = plan.toLowerCase();
    let settings = PLAN_POLICIES[planLower] || PLAN_POLICIES.silver;
    const updates = {};
    updates[`users/${uid}/plan`] = planLower;
    updates[`users/${uid}/plan_expiry`] = expiry;
    updates[`users/${uid}/vehicle_limit`] = settings.vehicle_limit;
    updates[`users/${uid}/exportCSV`] = settings.exportCSV;
    updates[`users/${uid}/upgrade_request/status`] = 'approved';
    updates[`admin/subscription_approvals/${uid}_${Date.now()}`] = {
      adminBy: (auth.currentUser && (auth.currentUser.email || auth.currentUser.uid)),
      uid, plan: planLower, name, time: new Date().toISOString()
    };
    db.ref().update(updates)
      .then(() => { alert('Subscription plan upgraded and approved.'); })
      .catch(err => alert('Approve failed: ' + err.message));
  }
  function rejectSubscriptionPlan(uid, plan, name) {
    if (!uid) return;
    if (!confirm('Reject upgrade for user '+name+'?')) return;
    db.ref(`users/${uid}/upgrade_request/status`).set('rejected')
      .then(() => { alert('Upgrade request rejected.'); })
      .catch(err => alert('Reject failed: ' + err.message));
  }

  // -- Minimal setup for maps/stats/ads/user approvals/history, as in your previous code
  // Add your detailed implementations here as needed.

  function setupLiveMap(){try{window.liveMap = L.map('map').setView([20,78],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.liveMap);}catch{}}
  function setupHistoryMap(){window.historyMap = L.map('historyMap').setView([20,78],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.historyMap);}
  function loadStats(){
    db.ref('users').once('value').then(snap=>{
      const users = snap.val()||{};
      let companiesSet = new Set(), vehicles = 0, deliveries = 0, alerts = 0;
      for(const uid in users){
        const u = users[uid];
        if (u && u.vehicle && u.vehicle.companies) {
          Object.keys(u.vehicle.companies).forEach(cn => companiesSet.add(cn));
          Object.values(u.vehicle.companies).forEach(comp => {
            const vehs = comp.vehicle||{};
            vehicles += Object.keys(vehs).length;
            Object.values(vehs).forEach(v => {
              if (v && v.deliveries) {
                const d = v.deliveries;
                deliveries += (typeof d === 'object' && !Array.isArray(d)) ? Object.keys(d).length : (Array.isArray(d) ? d.length : 0);
              }
            });
          });
        } else if (u && u.vehicles) {
          vehicles += Object.keys(u.vehicles).length;
        }
        if (u && u.vehicle && u.vehicle.last_trigger && u.vehicle.last_trigger.status === 'alert') alerts++;
      }
      totalCompaniesEl.innerText = companiesSet.size;
      totalVehiclesEl.innerText = vehicles;
      totalDeliveriesEl.innerText = deliveries;
      alertsTodayEl.innerText = alerts;
    });
  }
  // ...keep/loadPendingApprovals(), approveUser, rejectUser, etc. from your previous code.
  </script>
</body>
</html>
