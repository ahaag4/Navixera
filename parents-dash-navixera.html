<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SVMS Parents Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  
  <style>
    :root {
      --primary-color: #2563eb;
      --primary-rgb: 37, 99, 235;
      --primary-hover: #1d4ed8;
      --secondary-color: #64748b;
      --accent-color: #8b5cf6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --bg-light: #f8fafc;
      --card-bg: #ffffff;
      --card-border: #e2e8f0;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --font-family: 'Inter', sans-serif;
      --border-radius: 12px;
      --border-radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: var(--font-family);
      background-color: var(--bg-light);
      color: var(--text-primary);
      line-height: 1.5;
    }

    .navbar {
      background: var(--card-bg);
      box-shadow: var(--shadow-sm);
      padding: 0.75rem 0;
    }

    .navbar-brand {
      font-weight: 700;
      display: flex;
      align-items: center;
      color: var(--primary-color);
      font-size: 1.25rem;
    }

    .navbar-brand svg {
      color: var(--primary-color);
    }

    .card {
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      background: var(--card-bg);
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .card-header {
      background: var(--card-bg);
      border-bottom: 1px solid var(--card-border);
      padding: 1rem 1.25rem;
      font-weight: 600;
    }

    .card-title {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .card-body {
      padding: 1.25rem;
    }

    #map {
      height: 70vh;
      min-height: 500px;
      border-radius: var(--border-radius);
      z-index: 1;
    }

    .map-card {
      position: relative;
      overflow: hidden;
    }
    
    .map-controls {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 401;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .map-controls .btn {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
    }

    .map-controls .btn:hover {
      transform: scale(1.05);
    }

    .loader-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
      transition: opacity 0.3s ease;
      opacity: 1;
      backdrop-filter: blur(4px);
    }

    .loader-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-menu {
      background: var(--card-bg);
      box-shadow: var(--shadow-md);
      height: calc(100vh - 70px);
      position: fixed;
      width: 250px;
      padding: 1rem;
      overflow-y: auto;
    }

    .sidebar-menu .nav-link {
      color: var(--text-secondary);
      font-weight: 500;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius-sm);
      transition: var(--transition);
    }

    .sidebar-menu .nav-link:hover {
      background: #f1f5f9;
      color: var(--primary-color);
    }

    .sidebar-menu .nav-link.active {
      background: rgba(var(--primary-rgb), 0.1);
      color: var(--primary-color);
    }

    .main-content {
      margin-left: 250px;
      padding: 2rem;
    }

    .alert-card {
      margin-bottom: 1.5rem;
    }

    .payment-form {
      max-width: 500px;
    }

    .chat-form {
      max-width: 600px;
    }

    .log-list {
      max-height: 400px;
      overflow-y: auto;
    }

    /* Add more styles as needed for new features */

    @keyframes pulse {
      0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0); }
      100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0); }
    }

    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1080;
    }

    .toast {
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-lg);
      border: none;
    }

  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-bus-front" viewBox="0 0 16 16" style="margin-right: 8px;">
          <path d="M5 11a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-3zm3.5-4a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm-5 0a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1zm1.874-5.89c.01-.216.105-.443.238-.647.134-.205.306-.36.498-.44.19-.084.403-.1.57-.1.167 0 .38.016.57.1.19.084.362.235.498.44.133.204.228.43.237.647a48.266 48.266 0 0 1 1.168-.637c.509-.128 1.021-.169 1.3-.169.279 0 .791.041 1.3.169.51.128.721.372.938.637.01.216.105.443.238.647.134.205.306.36.498.44.19.084.403.1.57.1.167 0 .38-.016.57-.1.19-.084.362-.235.498-.44.133-.204.228-.43.237-.647.217-.265.428-.509.938-.637.509-.128 1.021-.169 1.3-.169V2a2 2 0 0 0-1-1.732l-3-1a2 2 0 0 0-2 0l-3 1A2 2 0 0 0 3 2v.865c.279 0 .791.041 1.3.169.51.128.721.372.938.637zM2 16a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1v-1a.5.5 0 0 0-.5-.5H2a.5.5 0 0 0-.5.5v1zm13-5H1v3h14v-3zM5 5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V5zm1 3h4V5H6v3z"/>
        </svg>
        SVMS Parents Portal
      </a>
      <div class="d-flex align-items-center">
        <span class="badge bg-primary me-2">Live</span>
        <small class="text-muted d-none d-md-block">Child Transport Monitoring</small>
        <button id="logoutBtn" class="btn btn-outline-danger ms-3">Logout</button>
      </div>
    </div>
  </nav>

  <div class="sidebar-menu">
    <nav class="nav flex-column">
      <a class="nav-link active" href="#tracking" data-section="tracking">Bus Tracking</a>
      <a class="nav-link" href="#alerts" data-section="alerts">Alerts & Attendance</a>
      <a class="nav-link" href="#logs" data-section="logs">Trip Logs</a>
      <a class="nav-link" href="#fees" data-section="fees">Fees & Payments</a>
      <a class="nav-link" href="#schedule" data-section="schedule">Schedule Management</a>
      <a class="nav-link" href="#vehicle" data-section="vehicle">Vehicle & Driver Info</a>
      <a class="nav-link" href="#communication" data-section="communication">Communication</a>
    </nav>
  </div>

  <main class="main-content">
    <div id="tracking-section" class="section">
      <h4>Real-Time Bus Tracking</h4>
      <div class="card map-card">
        <div id="map"></div>
        <div class="map-controls">
          <button id="locateBusBtn" class="btn btn-light" title="Locate Bus">
            <i class="bi bi-bus-front text-primary"></i>
          </button>
          <button id="showRouteBtn" class="btn btn-light" title="Show Route">
            <i class="bi bi-signpost text-primary"></i>
          </button>
        </div>
        <div class="loader-overlay" id="loader">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <p id="eta-info" class="text-muted">ETA: Calculating...</p>
      </div>
    </div>

    <div id="alerts-section" class="section d-none">
      <h4>Alerts & Attendance</h4>
      <div class="alert-card card">
        <div class="card-body">
          <h5>Current Status</h5>
          <p id="attendance-status">Loading...</p>
          <h5>Recent Alerts</h5>
          <ul id="alert-list" class="list-group">
            <!-- Dynamically populated -->
          </ul>
          <button id="requestSosBtn" class="btn btn-danger mt-3">Request Emergency Help</button>
        </div>
      </div>
    </div>

    <div id="logs-section" class="section d-none">
      <h4>Historical Trip Logs</h4>
      <div class="card">
        <div class="card-body">
          <div class="log-list" id="trip-logs">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>
    </div>

    <div id="fees-section" class="section d-none">
      <h4>Fees & Payments</h4>
      <div class="card">
        <div class="card-body">
          <h5>Current Balance</h5>
          <p id="fee-balance">Loading...</p>
          <form class="payment-form" id="paymentForm">
            <div class="mb-3">
              <label for="paymentAmount" class="form-label">Amount (INR)</label>
              <input type="number" class="form-control" id="paymentAmount" required>
            </div>
            <div class="mb-3">
              <label for="paymentMethod" class="form-label">Method</label>
              <select class="form-control" id="paymentMethod">
                <option value="upi">UPI</option>
                <option value="card">Card</option>
                <option value="other">Other</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Pay Now</button>
          </form>
        </div>
      </div>
    </div>

    <div id="schedule-section" class="section d-none">
      <h4>Route & Schedule Management</h4>
      <div class="card">
        <div class="card-body">
          <h5>Current Schedule</h5>
          <p id="current-schedule">Loading...</p>
          <form id="scheduleChangeForm">
            <div class="mb-3">
              <label for="newPickup" class="form-label">New Pickup Location</label>
              <input type="text" class="form-control" id="newPickup">
            </div>
            <div class="mb-3">
              <label for="newDropoff" class="form-label">New Drop-off Location</label>
              <input type="text" class="form-control" id="newDropoff">
            </div>
            <button type="submit" class="btn btn-primary">Request Change</button>
          </form>
        </div>
      </div>
    </div>

    <div id="vehicle-section" class="section d-none">
      <h4>Vehicle & Driver Details</h4>
      <div class="card">
        <div class="card-body">
          <h5>Assigned Vehicle</h5>
          <p id="vehicle-info">Loading...</p>
          <h5>Driver Info</h5>
          <p id="driver-info">Loading...</p>
        </div>
      </div>
    </div>

    <div id="communication-section" class="section d-none">
      <h4>Communication</h4>
      <div class="card">
        <div class="card-body">
          <form class="chat-form" id="messageForm">
            <div class="mb-3">
              <label for="messageSubject" class="form-label">Subject</label>
              <input type="text" class="form-control" id="messageSubject" required>
            </div>
            <div class="mb-3">
              <label for="messageBody" class="form-label">Message</label>
              <textarea class="form-control" id="messageBody" rows="4" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Send Message</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <div class="toast-container"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <script>
    (function () {
      'use strict';

      // Firebase Configuration
      const firebaseConfig = {
        apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
        authDomain: "svms-c0232.firebaseapp.com",
        databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
        projectId: "svms-c0232",
        storageBucket: "svms-c0232.appspot.com",
        messagingSenderId: "359201898609",
        appId: "1:359201898609:web:893ef076207abb06471bd0"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();

      // DOM Elements
      const dom = {
        loader: document.getElementById('loader'),
        logoutBtn: document.getElementById('logoutBtn'),
        map: document.getElementById('map'),
        etaInfo: document.getElementById('eta-info'),
        attendanceStatus: document.getElementById('attendance-status'),
        alertList: document.getElementById('alert-list'),
        requestSosBtn: document.getElementById('requestSosBtn'),
        tripLogs: document.getElementById('trip-logs'),
        feeBalance: document.getElementById('fee-balance'),
        paymentForm: document.getElementById('paymentForm'),
        currentSchedule: document.getElementById('current-schedule'),
        scheduleChangeForm: document.getElementById('scheduleChangeForm'),
        vehicleInfo: document.getElementById('vehicle-info'),
        driverInfo: document.getElementById('driver-info'),
        messageForm: document.getElementById('messageForm'),
        toastContainer: document.querySelector('.toast-container')
      };

      // State Variables
      let map;
      let busMarker;
      let routeLayer = L.featureGroup();
      let childData = {};
      let assignedVehicle = null;
      let currentUser;

      // Helper Functions
      const showLoader = () => dom.loader.classList.remove('hidden');
      const hideLoader = () => dom.loader.classList.add('hidden');

      const showToast = (message, type = 'info', ttl = 3500) => {
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-bg-${type} border-0 show`;
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
          </div>`;
        dom.toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: ttl });
        toast.show();
      };

      const parseGps = (gps) => {
        if (!gps) return null;
        const parts = String(gps).split(',').map(s => parseFloat(s.trim()));
        if (parts.length < 2 || isNaN(parts[0]) || isNaN(parts[1])) return null;
        return [parts[0], parts[1]];
      };

      const calculateDistance = (lat1, lon1, lat2, lon2) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      };

      const calculateETA = (currentPos, targetPos, speed) => {
        const distance = calculateDistance(currentPos[0], currentPos[1], targetPos[0], targetPos[1]);
        const time = (distance / (speed || 40)) * 60; // Assume average speed 40 km/h if not provided
        return Math.round(time);
      };

      // Map Initialization
      const initMap = () => {
        map = L.map('map').setView([19.0760, 72.8777], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        routeLayer.addTo(map);
      };

      // Load Child Data
      const loadChildData = () => {
        db.ref(`users/${currentUser.uid}/children`).once('value', snap => {
          childData = snap.val() || {};
          const firstChild = Object.values(childData)[0]; // Assume one child for simplicity
          assignedVehicle = firstChild.transport.assigned_vehicle;
          loadBusTracking();
          loadAttendanceAndAlerts();
          loadTripLogs();
          loadFees();
          loadSchedule();
          loadVehicleDriverInfo();
        });
      };

      // Feature 1: Real-Time Bus Location Tracking & Route Visualization
      const loadBusTracking = () => {
        if (!assignedVehicle) return;
        const vehicleRef = db.ref(`public_transport/vehicles/${assignedVehicle}`);
        vehicleRef.on('value', snap => {
          const v = snap.val();
          if (v) {
            const coords = parseGps(v.gps);
            if (coords) {
              if (!busMarker) {
                busMarker = L.marker(coords, { icon: L.divIcon({ html: '<i class="bi bi-bus-front text-primary fs-3"></i>' }) }).addTo(map);
              } else {
                busMarker.setLatLng(coords);
              }
              map.flyTo(coords, 15);

              // Route Visualization
              routeLayer.clearLayers();
              const routePath = (v.fullRoutePath || []).map(parseGps).filter(Boolean);
              if (routePath.length > 1) {
                L.polyline(routePath, { color: '#2563eb', weight: 5 }).addTo(routeLayer);
              }

              // ETA
              const dropoff = parseGps(firstChild.transport.dropoff_gps);
              if (dropoff) {
                const eta = calculateETA(coords, dropoff, v.speed);
                dom.etaInfo.textContent = `ETA to drop-off: ${eta} minutes`;
                if (eta > 30) showToast('Bus delay detected!', 'warning'); // Delay Notification
              }
            }
          }
        });
      };

      // Feature 2: Child Boarding/Deboarding Alerts & Attendance Tracking
      const loadAttendanceAndAlerts = () => {
        const attendanceRef = db.ref(`users/${currentUser.uid}/children/firstChild/transport/attendance`); // Assume child ID 'firstChild'
        attendanceRef.on('value', snap => {
          const status = snap.val() || 'Not on bus';
          dom.attendanceStatus.textContent = `Status: ${status}`;
          if (status === 'Boarded' || status === 'Deboarded') {
            showToast(`Child has ${status.toLowerCase()} the bus.`, 'success');
            if (Notification.permission === 'granted') {
              new Notification(`SVMS Alert: Child has ${status.toLowerCase()} the bus.`);
            }
          }
        });

        // Alerts list
        const alertsRef = db.ref(`users/${currentUser.uid}/alerts`);
        alertsRef.on('child_added', snap => {
          const alert = snap.val();
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${alert.time}: ${alert.message}`;
          dom.alertList.appendChild(li);
          showToast(alert.message, alert.type || 'info');
        });

        // Emergency SOS
        dom.requestSosBtn.addEventListener('click', () => {
          db.ref(`users/${currentUser.uid}/alerts`).push({
            time: new Date().toISOString(),
            message: 'Emergency SOS requested by parent.',
            type: 'danger'
          });
          showToast('SOS request sent to admin.', 'success');
        });

        // Driver Monitoring (speed example)
        db.ref(`public_transport/vehicles/${assignedVehicle}/speed`).on('value', snap => {
          const speed = snap.val();
          if (speed > 80) {
            showToast('Bus exceeding speed limit!', 'danger');
          }
        });
      };

      // Feature 3: Historical Trip Logs
      const loadTripLogs = () => {
        const logsRef = db.ref(`users/${currentUser.uid}/children/firstChild/transport/logs`);
        logsRef.on('value', snap => {
          const logs = snap.val() || {};
          dom.tripLogs.innerHTML = '';
          Object.entries(logs).forEach(([date, log]) => {
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.innerHTML = `<strong>${date}</strong>: ${log.duration} min, Route: ${log.route}`;
            dom.tripLogs.appendChild(div);
          });
        });
      };

      // Feature 4: Fee Management and Online Payments
      const loadFees = () => {
        const feesRef = db.ref(`users/${currentUser.uid}/transport_fees`);
        feesRef.on('value', snap => {
          const balance = snap.val()?.balance || 0;
          dom.feeBalance.textContent = `Balance Due: ₹${balance}`;
        });

        dom.paymentForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const amount = dom.paymentForm.paymentAmount.value;
          const method = dom.paymentForm.paymentMethod.value;
          db.ref('admin/payments').push({
            uid: currentUser.uid,
            feature: 'transport_fees',
            amount: parseFloat(amount),
            currency: 'inr',
            status: 'pending',
            created: new Date().toISOString(),
            expiry: new Date(Date.now() + 30*24*60*60*1000).toISOString(), // 30 days
            payment_method: method
          });
          showToast('Payment request submitted.', 'success');
        });
      };

      // Feature 5: Route and Schedule Management
      const loadSchedule = () => {
        const scheduleRef = db.ref(`users/${currentUser.uid}/children/firstChild/transport/schedule`);
        scheduleRef.on('value', snap => {
          const schedule = snap.val() || {};
          dom.currentSchedule.textContent = `Pickup: ${schedule.pickup_time}, Drop-off: ${schedule.dropoff_time}`;
        });

        dom.scheduleChangeForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const newPickup = dom.scheduleChangeForm.newPickup.value;
          const newDropoff = dom.scheduleChangeForm.newDropoff.value;
          db.ref(`admin/upgrade_requests`).push({
            uid: currentUser.uid,
            requestedPlan: `Change pickup to ${newPickup}, dropoff to ${newDropoff}`,
            status: 'pending',
            request_time: new Date().toISOString()
          });
          showToast('Schedule change request submitted.', 'success');
        });
      };

      // Feature 6: Vehicle and Driver Details
      const loadVehicleDriverInfo = () => {
        const vehicleRef = db.ref(`public_transport/vehicles/${assignedVehicle}`);
        vehicleRef.once('value', snap => {
          const v = snap.val();
          dom.vehicleInfo.textContent = `Vehicle: ${assignedVehicle}, Type: ${v.vehicleType}, Battery: ${v.battery}%`;
        });

        // Assume driver info in vehicle
        vehicleRef.child('driver').once('value', snap => {
          const driver = snap.val();
          dom.driverInfo.textContent = `Driver: ${driver.name}, License: ${driver.license}, Contact: ${driver.phone}`;
        });
      };

      // Feature 7: Communication Tools
      dom.messageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const subject = dom.messageForm.messageSubject.value;
        const body = dom.messageForm.messageBody.value;
        db.ref('contact_submissions').push({
          name: currentUser.displayName || 'Parent',
          email: currentUser.email,
          message: `${subject}: ${body}`
        });
        showToast('Message sent to admin.', 'success');
      });

      // Sidebar Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
          document.getElementById(`${link.dataset.section}-section`).classList.remove('d-none');
        });
      });

      // Initialization
      document.addEventListener('DOMContentLoaded', () => {
        showLoader();
        auth.onAuthStateChanged(user => {
          if (user) {
            currentUser = user;
            initMap();
            loadChildData();
            hideLoader();
            Notification.requestPermission(); // For alerts
          } else {
            // Redirect to login (assume a login page)
            window.location.href = 'login.html';
          }
        });

        dom.logoutBtn.addEventListener('click', () => {
          auth.signOut();
        });
      });
    })();
  </script>
</body>
</html>
