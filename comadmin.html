<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Smart Vehicle Logistics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background: #f2f5fa; }
    .card { box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .navbar { background: #007bff; }
    .navbar-brand, .nav-link { color: white !important; }
    #map { height: 300px; width: 100%; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Admin Panel</a>
    </div>
  </nav>
  <div class="container py-4">
    <div class="row">
      <div class="col-md-4">
        <!-- Vehicle & Delivery Controls -->
        <div class="card p-3 mb-3">
          <h5>Add Delivery</h5>
          <input type="text" class="form-control mb-2" id="dTrackId" placeholder="Tracking ID (e.g. ASI001)" />
          <input type="text" class="form-control mb-2" id="dVehicleId" placeholder="Vehicle ID (e.g. V123)" />
          <input type="text" class="form-control mb-2" id="dStatus" placeholder="Status (e.g. In Transit)" />
          <button class="btn btn-primary w-100" onclick="addDelivery()">Add Delivery</button>
        </div>
        <div class="card p-3 mb-3">
          <h5>Add Vehicle</h5>
          <input type="text" class="form-control mb-2" id="vId" placeholder="Vehicle ID" />
          <input type="text" class="form-control mb-2" id="vType" placeholder="Vehicle Type" />
          <button class="btn btn-success w-100" onclick="addVehicle()">Add Vehicle</button>
        </div>
        <div class="card p-3 mb-3">
          <h5>Add Driver</h5>
          <input type="text" class="form-control mb-2" id="driverName" placeholder="Driver Name" />
          <input type="text" class="form-control mb-2" id="driverContact" placeholder="Contact Number" />
          <button class="btn btn-info w-100" onclick="addDriver()">Add Driver</button>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card p-3 mb-4">
          <h5>Live Vehicle Locations</h5>
          <div id="map"></div>
        </div>
        <div class="card p-3">
          <h5>Deliveries</h5>
          <ul class="list-group" id="deliveryList"></ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCn9YSO4-ksWl6JBqIcEEuLx2EJN8jMj4M",
      authDomain: "svms-c0232.firebaseapp.com",
      databaseURL: "https://svms-c0232-default-rtdb.firebaseio.com",
      projectId: "svms-c0232",
      storageBucket: "svms-c0232.appspot.com",
      messagingSenderId: "359201898609",
      appId: "1:359201898609:web:893ef076207abb06471bd0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let userId = "";
    let companyName = "";

    
      // âœ… company Dashboard Initialization
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    alert("Not signed in. Redirecting...");
    window.location.href = "login.html";
    return;
  }

    // âœ… Check if user is an company
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    alert("User data not found. Redirecting...");
    window.location.href = "login.html";
    return;
  }

  const userData = userSnap.data();
  if (userData.role !== "company") {
    alert("Unauthorized access! Redirecting to dashboard...");
    window.location.href = "dashboard.html"; // Redirect non-admin users
    return;
  }

    // ðŸšš Add delivery
    function addDelivery() {
      const trackId = document.getElementById("dTrackId").value.trim();
      const vehicleId = document.getElementById("dVehicleId").value.trim();
      const status = document.getElementById("dStatus").value.trim();
      if (trackId && vehicleId && status) {
        db.ref(`users/${userId}/vehicle/companies/${companyName}/vehicle/${vehicleId}/deliveries/${trackId}`).set({ status });
        alert("âœ… Delivery added");
      }
    }

    // ðŸš— Add vehicle
    function addVehicle() {
      const vId = document.getElementById("vId").value.trim();
      const vType = document.getElementById("vType").value.trim();
      if (vId && vType) {
        db.ref(`users/${userId}/vehicle/companies/${companyName}/vehicle/${vId}`).set({
          vehicleType: vType,
          gps: "19.2183,72.9781",
          battery: Math.floor(Math.random() * 20) + 80
        });
        alert("âœ… Vehicle added");
      }
    }

    // ðŸ‘· Add driver
    function addDriver() {
      const name = document.getElementById("driverName").value.trim();
      const contact = document.getElementById("driverContact").value.trim();
      if (name && contact) {
        db.ref(`users/${userId}/drivers`).push({ name, contact });
        alert("âœ… Driver added");
      }
    }

    // ðŸ—ºï¸ Setup map and vehicle locations
    function setupPanel() {
      const map = L.map("map").setView([19.2183, 72.9781], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
      }).addTo(map);

      const markers = {};
      db.ref(`users/${userId}/vehicle/companies/${companyName}/vehicle`).on("value", snap => {
        const vehicles = snap.val();
        for (const id in vehicles) {
          const data = vehicles[id];
          const [lat, lng] = (data.gps || "0,0").split(",").map(Number);
          if (!markers[id]) {
            markers[id] = L.marker([lat, lng]).addTo(map).bindPopup(`${id} (${data.vehicleType})`);
          } else {
            markers[id].setLatLng([lat, lng]).setPopupContent(`${id} (${data.vehicleType})`);
          }
        }
      });

      db.ref(`users/${userId}/vehicle/companies/${companyName}/vehicle`).on("value", snap => {
        const list = document.getElementById("deliveryList");
        list.innerHTML = "";
        const data = snap.val();
        for (const vehId in data) {
          const deliveries = data[vehId]?.deliveries || {};
          for (const trackId in deliveries) {
            const status = deliveries[trackId].status;
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = `ðŸ“¦ ${trackId} - ðŸšš ${vehId} - ${status}`;
            list.appendChild(li);
          }
        }
      });
    }
  </script>
</body>
</html>
